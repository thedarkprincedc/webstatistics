jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");jQuery.sap.require("sap.apf.modeler.ui.utils.optionsValueModelBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.viewValidator");jQuery.sap.require('sap.apf.modeler.ui.utils.sortDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.stepPropertyMetadataHandler');(function(){"use strict";var p,t,c,C,T,g,s,v,S,o,I,a;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var b=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var d=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var e=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function _(i){i.byId("idStepBasicData").setText(t("stepBasicData"));i.byId("idStepTitleLabel").setText(t("stepTitle"));i.byId("idStepTitle").setPlaceholder(t("newStep"));i.byId("idStepLongTitleLabel").setText(t("stepLongTitle"));i.byId("idStepLongTitle").setPlaceholder(t("stepLongTitle"));i.byId("idCategoryTitleLabel").setText(t("categoryAssignments"));i.byId("idGlobalLabel").setText(t("globalNavigationTarget"));i.byId("idStepSpecificLabel").setText(t("stepSpecificNavTargets"));i.byId("idDataRequest").setText(t("dataRequest"));i.byId("idFilterMapping").setText(t("filterMap"));i.byId("idFilterMapKeepSourceLabel").setText(t("filterMapKeepSource"));i.byId("idNavigationTarget").setText(t("navigationTargetAssignments"));i.byId("idDataReduction").setText(t("dataReduction"));i.byId("idDataReductionLabel").setText(t("dataReductionType"));i.byId("idNoDataReduction").setText(t("noDataReduction"));i.byId("idTopN").setText(t("topN"));i.byId("idNumberOfRecordsLabel").setText(t("recordNumber"));i.byId("idAriaPropertyForDataReduction").setText(t("dataReductionType"));}function f(i,j){var L=t(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().updateTitleAndBreadCrumb(L);h(i,j);}function h(i,j){var L=t(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(L);}function k(i,j){var L={id:s.getId(),icon:s.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(j){L.name=j;}i.getView().getViewData().updateSelectedNode(L);}function l(i){var j,L;if(p&&p.arguments&&p.arguments.stepId){s=C.getStep(p.arguments.stepId);I=(s&&s.getType()==="hierarchicalStep")?true:false;}if(!n.checkIsNotUndefined(s)){L=p.arguments.categoryId;I=p.bIsHierarchicalStep;if(I){j=C.createHierarchicalStep(L);}else{j=C.createStep(L);}s=C.getStep(j);k(i);}}function m(i){var j=this;var L=i.getParameter("bShowFilterMappingLayout");j.byId("idStepFilterMappingVBox").setVisible(L);j.byId("idFilterMapKeepSourceLabel").setVisible(L);j.byId("idFilterKeepSourceCheckBox").setVisible(L);if(!L){j.byId("idFilterMapping").setText("");j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS);}else{j.byId("idFilterMapping").setText(t("filterMap"));}}function q(i){i.byId("idDataReductionForm").setVisible(!I);}function r(i,j,V,L,U){sap.ui.view({viewName:L,type:sap.ui.core.mvc.ViewType.XML,id:i.createId(U),viewData:V,controller:j});}function u(i){var V,j,L,M,N,O,P;V={oTextReader:t,oConfigurationEditor:C,oTextPool:T,oParentObject:s,oStepPropertyMetadataHandler:a};j=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");r(i,j,V,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");N=i.byId("idStepCornerTextView");i.byId("idStepCornerTextVBox").insertItem(N);V.oConfigurationHandler=c;V.getCalatogServiceUri=i.getView().getViewData().getCalatogServiceUri;if(I){L=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest");}else{L=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest");}r(i,L,V,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");O=i.byId("idStepRequestView");i.byId("idStepRequestVBox").insertItem(O);M=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");r(i,M,V,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");P=i.byId("idStepFilterMappingView");i.byId("idStepFilterMappingVBox").insertItem(P);O.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,i.setDataReductionSection.bind(i));O.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,m.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,m.bind(i));O.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,P.getController().updateFilterMappingFields.bind(P.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,P.getController().resetFilterMappingFields.bind(P.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,N.getController().updateSubViewInstancesOnReset.bind(N.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,O.getController().updateSubViewInstancesOnReset.bind(O.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,P.getController().updateSubViewInstancesOnReset.bind(P.getController()));O.addStyleClass("formTopPadding");O.addStyleClass("formBottomPadding");P.addStyleClass("formTopPadding");P.addStyleClass("formBottomPadding");}function w(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepTitle").setValue(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(s.getTitleId())&&T.get(s.getTitleId())){i.byId("idStepTitle").setValue(T.get(s.getTitleId()).TextElementDescription);}}function x(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepLongTitle").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(s.getLongTitleId())&&T.get(s.getLongTitleId())){i.byId("idStepLongTitle").setValue(T.get(s.getLongTitleId()).TextElementDescription);}}function y(i){var j=[];var L=C.getCategories();L.forEach(function(O){var P={};P.CategoryId=O.getId();P.CategoryTitle=T.get(O.labelKey)?T.get(O.labelKey).TextElementDescription:O.labelKey;j.push(P);});var M=b.prepareModel(j,j.length);i.byId("idCategorySelect").setModel(M);var N=C.getCategoriesForStep(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(N)){i.byId("idCategorySelect").setSelectedKeys(N);}}function z(i){i.byId("idNumberOfRecordsValue").setValue("");i.byId("idNumberOfRecordsValue").setValueState("None");if(s.getTopN()){i.byId("idNumberOfRecordsValue").setValue(s.getTopN().top);}B(i);}function A(i){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idNoDataReduction"));E(i);if(s.getTopN()){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idTopN"));}}function B(i){var j=i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idTopN")?true:false;i.byId("idNumberOfRecordsLabel").setVisible(j);i.byId("idNumberOfRecordsValue").setVisible(j);if(j){v.addField("idNumberOfRecordsValue");}else{v.removeField("idNumberOfRecordsValue");}}function D(i){if(s.getTopN()){S.instantiateStepSortData();if(s.getTopN().orderby.length===0){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var M=o.createMessageObject({code:"11523"});o.putMessage(M);}}else{S.destroySortData();}}function E(i){var j=(s.getSelectProperties().length!==0)?true:false;i.byId("idDataReductionRadioGroup").setEnabled(j);}function F(i){var j=(s.getFilterProperties().length!==0)?true:false;i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":j});}function G(i){if(n.checkIsNotNullOrUndefinedOrBlank(s.getFilterMappingKeepSource())){i.byId("idFilterKeepSourceCheckBox").setSelected(s.getFilterMappingKeepSource());}}function H(i,N,j,L){var M=[];if(N.length!==0){j.setBusy(true);}N.forEach(function(O){var P={};P.navTargetKey=O.getId();g(O.getId()).then(function(Q){P.navTargetName=Q;M.push(P);if(M.length===N.length){var R=b.prepareModel(M,M.length);j.setModel(R);j.setSelectedKeys(L);j.setBusy(false);}});});}function J(i){var j=C.getNavigationTargets();var L=s.getNavigationTargets();var N=j.filter(function(M){return M.isStepSpecific();});H(i,N,i.byId("idStepSpecificCombo"),L);}function K(i){var j=C.getNavigationTargets();var N=j.filter(function(M){return M.isGlobal();});var L=N.map(function(M){return M.getId();});H(i,N,i.byId("idGlobalCombo"),L);}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var i=this,j;var V=i.getView().getViewData();o=V.oCoreApi;t=o.getText;p=V.oParams;c=V.oConfigurationHandler;T=c.getTextPool();C=V.oConfigurationEditor;g=V.getNavigationTargetName;v=new sap.apf.modeler.ui.utils.ViewValidator(i.getView());_(i);l(i);a=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(o,s);S=new sap.apf.modeler.ui.utils.SortDataHandler(i.getView(),s,a,t);u(i);i.setDetailData();j=i.byId("idStepTitle").getValue().trim();if(j===""){j="< "+t("newStep")+" >";}h(i,j);v.addFields(["idStepTitle","idCategorySelect"]);},setDetailData:function(){var i=this;w(i);x(i);y(i);i.setDataReductionSection();q(i);F(i);G(i);J(i);K(i);},onAfterRendering:function(){var i=this;if(i.byId("idStepTitle").getValue().length===0){i.byId("idStepTitle").focus();}},updateSubViewInstancesOnReset:function(i){var j=this;C=i;s=C.getStep(s.getId());j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":s});},setDataReductionSection:function(){var i=this;A(i);z(i);D(i);},handleChangeForStepTitle:function(){var i=this;var j=C.getCategoriesForStep(s.getId());var L=i.byId("idStepTitle").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(L)){T.setTextAsPromise(L,d).done(function(M){s.setTitleId(M);if(j.length>1){i.getView().getViewData().updateTree();}else{k(i,L);}f(i,L);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,d);},handleChangeForStepLongTitle:function(){var i=this;var j=i.byId("idStepLongTitle").getValue().trim();if(n.checkIsNotNullOrUndefined(j)){T.setTextAsPromise(j,e).done(function(L){s.setLongTitleId(L);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepLongTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,e);},handleChangeForCategory:function(){var L=this;var M=s.getId();var N=p.arguments.categoryId;var P=C.getCategoriesForStep(s.getId());var O=L.byId("idCategorySelect").getSelectedKeys();var Q=O.indexOf(N);var R=[];var U=[];var i,j;for(i=0;i<P.length;i++){var V=false;for(j=0;j<O.length;j++){if(P[i]===O[j]){V=true;break;}}if(!V){U.push(P[i]);}}if(O.length!==0){O.forEach(function(W){C.addCategoryStepAssignment(W,M);var X={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:N,stepId:M}},newContext:{arguments:{configId:p.arguments.configId,categoryId:W}}};if(W!==N){R.push(X);}});P.forEach(function(W){if(O.indexOf(W)===-1){C.removeCategoryStepAssignment(W,s.getId());}});if(U.length!==0){U.forEach(function(W){var X={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:N,stepId:M}},newContext:{arguments:{configId:p.arguments.configId,categoryId:W}},removeStep:true};if(Q===-1&&W===N){var Y={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:O[0],stepId:M}};X.categoryChangeContext=Y;X.changeCategory=true;}R.push(X);});}}if(R.length!==0){L.getView().getViewData().updateTree(R);}C.setIsUnsaved();},handleChangeForDataReductionType:function(){var i=this;if(i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idNoDataReduction")){s.resetTopN();i.setDataReductionSection();}else{S.instantiateStepSortData();}B(i);C.setIsUnsaved();},handleValidationForNumberOfRecords:function(i){var j=i.getSource();var V=j.getValue().trim();var L=(V.indexOf("E")!==-1||V.indexOf("e")!==-1||V.indexOf(".")!==-1||V<=0||V>10000)?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None;j.setValueState(L);C.setIsUnsaved();},handleChangeForNoOfRecords:function(i){var j=this;var V=i.getSource().getValue().trim();if(i.getSource().getValueState()===sap.ui.core.ValueState.Error){return;}if(n.checkIsNotNullOrUndefinedOrBlank(V)){if(s.getTopN()===undefined){j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);}s.setTopNValue(V);}C.setIsUnsaved();},handleFilterMapKeepSource:function(){var i=this;var j=i.byId("idFilterKeepSourceCheckBox").getSelected();s.setFilterMappingKeepSource(j);C.setIsUnsaved();},handleChangeForStepSpecificNavTargets:function(){var i=this;var j=i.byId("idStepSpecificCombo").getSelectedKeys();var L=s.getNavigationTargets();L.forEach(function(M){if(j.indexOf(M)===-1){s.removeNavigationTarget(M);}});j.forEach(function(M){if(L.indexOf(M)===-1){s.addNavigationTarget(M);}});C.setIsUnsaved();},getValidationState:function(){var i=this;return v.getValidationState()&&i.byId("idStepRequestView").getController().getValidationState()&&i.byId("idStepFilterMappingView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idStepCornerTextView").destroy();i.byId("idStepRequestView").destroy();i.byId("idStepFilterMappingView").destroy();}});}());
