/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.declare("sap.apf.ui.representations.table");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.ui.utils.formatter');jQuery.sap.require("sap.apf.ui.representations.utils.paginationHandler");jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");jQuery.sap.require("sap.apf.ui.representations.utils.paginationDisplayOptionHandler");jQuery.sap.require("sap.ui.model.Sorter");jQuery.sap.require("sap.ui.table.Table");jQuery.sap.require("sap.ui.table.Column");jQuery.sap.require("sap.ui.core.CustomData");jQuery.sap.require("sap.ui.model.json.JSONModel");jQuery.sap.require("sap.ui.core.Icon");jQuery.sap.require("sap.ui.layout.VerticalLayout");jQuery.sap.require("sap.m.Text");jQuery.sap.require("sap.m.Label");jQuery.sap.require("sap.m.Button");jQuery.sap.require("sap.m.HBox");jQuery.sap.require("sap.m.VBox");jQuery.sap.require("sap.m.ScrollContainer");jQuery.sap.require('sap.ui.export.Spreadsheet');jQuery.sap.require("sap.apf.ui.utils.determineColumnSettingsForSpreadSheetExport");jQuery.sap.require("sap.ui.export.EdmType");(function(){'use strict';function _(t,s){s.forEach(function(i){t.addSelectionInterval(i,i);});}function a(t,r){if(t.bIsAlternateRepresentation&&t.oApi.getActiveStep()){t.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.getFilterValues().forEach(function(F){if(t.aFiltersInTable.indexOf(F)===-1){t.aFiltersInTable.push(F);}});}if((r&&t.oParameter.top)||t.oParameter.isAlternateRepresentation){t.aFiltersInTable=c(t,r);}}function b(t,r){var s=[];t.aDataResponse.forEach(function(i,p){var q=i[r];if(t.aFiltersInTable.indexOf(q)!==-1){s.push(p);}});return s;}function c(t,r){var F=[];t.aFiltersInTable.forEach(function(i){t.aDataResponse.forEach(function(p){var q=p[r];if(q==i&&F.indexOf(i)===-1){F.push(i);}});});return F;}function d(E){var r=this.oParameter.requiredFilters;var R=r&&(r.length>0)?r[0]:undefined;var i=E.getParameter("userInteraction");var C=E.getParameter("rowIndices");if(!i||C.length===0){return;}if(E.getSource().getFocusDomRef()&&E.getSource().getFocusDomRef().offsetTop!==0){this.nFirstVisibleRow=this.tableControl.getFirstVisibleRow();}e(this,R,C);var p=jQuery.unique(this.aFiltersInTable);f(this,p);}function e(t,r,C){var s=t.tableControl.getContextByIndex(C[0]).getProperty(r);if((t.tableControl.isIndexSelected(C[0]))&&(t.aFiltersInTable.indexOf(s))===-1){t.aFiltersInTable.push(s);}else{var i=t.aFiltersInTable.indexOf(s);if(i!==-1){t.aFiltersInTable.splice(i,1);}}}function f(t,C){g(t);t.aFiltersInTable=C;t.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.updateFilterFromSelection(C);t.oApi.selectionChanged();}function g(t){t.oRepresentationFilterHandler.clearFilters();t.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.clearFilters();t.aValidatedFilter=[];t.aFiltersInTable=[];}function h(t,p){var r=t.oParameter.requiredFilters;var R=r&&(r.length>0)?r[0]:undefined;var F=j(t);var A=p.getModel().getData().tableData;var s=[],S=[];A.forEach(function(u,v){if(F.indexOf(u[R])!==-1){s.push(v);}});var i=t.tableControl.getBinding().aIndices;s.forEach(function(u){S.push(i.indexOf(u));});s=S;var q=(r&&(r.length>0))?"MultiToggle":"None";p.setSelectionMode(q);p.onAfterRendering=function(){s.forEach(function(u){p.getRows()[u].$().addClass("sapTableSelectionForPrint");});};}function j(t){var F=t.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.getFilterValues();return F;}function k(t,s,T){var i=function(E){return function(F){if(T.metadata!==undefined){var G;if(t.value[E]&&F){G=T.oFormatter.getFormattedValue(t.value[E],F);if(G!==undefined){return G;}}}return F;};};var p=new sap.ui.table.Table({title:s,showNoData:false,enableSelectAll:false,visibleRowCount:15});var r=T.oParameter.requiredFilters;var q=(r&&(r.length>0))?"MultiToggle":"None";p.setSelectionMode(q);var u=[],C,v,w;for(var x=0;x<t.name.length;x++){C=new sap.m.Text().bindText(t.value[x],i(x),sap.ui.model.BindingMode.OneWay);v=new sap.ui.table.Column({label:new sap.m.Label({text:t.name[x]}),template:C,tooltip:t.name[x]});w=new sap.ui.core.CustomData({value:{text:t.name[x],key:t.value[x]}});v.addCustomData(w);u.push(v);}var y;y=u;y.forEach(function(E){p.addColumn(E);});if(u.length>10){p.getColumns().forEach(function(v){v.setWidth("125px");});}var M=new sap.ui.model.json.JSONModel();M.setSizeLimit(10000);var z=T.getData();M.setData({tableData:z});p.setModel(M);p.bindRows("/tableData");l(p);if(T.metadata!==undefined){for(var A=0;A<t.name.length;A++){var B=T.metadata.getPropertyMetadata(t.value[A]);if(B["aggregation-role"]==="measure"){var D=p.getColumns()[A];D.setHAlign(sap.ui.core.HorizontalAlign.End);}}}return p;}function l(t){var i=t.getModel().getData().tableData.length;var p;if(jQuery('.chartContainer').height()){p=jQuery('.chartContainer').height()-(jQuery(".chartContainer > div :first-child").height()+120);}var q=sap.ui.Device.system.desktop?32:36;var r=(p>0)?p/q:15;var s=Math.floor(r);if(i<s){s=i;}t.setVisibleRowCount(s);}function m(C,t){var s;var i=jQuery('.tableRepresentation').offset().top;var S=t.oApi.getUiApi().getStepContainer();if(S&&S.getContent()[0]&&S.getContent()[0].getContent()[0].getFullScreen()){s=((window.innerHeight-i)+40)+"px";}else{s=((window.innerHeight-i)-(jQuery(".applicationFooter").height()+40))+"px";}document.querySelector('.tableRepresentation').style.cssText+="height : "+s;t.tableControl.setFirstVisibleRow(t.nFirstVisibleRow);}function n(t){var T=t.getData();var p=[],q;var C={name:[],value:[]};p=t.oParameter.dimensions.concat(t.oParameter.measures).length?t.oParameter.dimensions.concat(t.oParameter.measures):t.parameter.properties;if(T.length!==0){for(var i=0;i<p.length;i++){C.value[i]=p[i].fieldName;var r=t.metadata.getPropertyMetadata(p[i].fieldName).label||t.metadata.getPropertyMetadata(p[i].fieldName).name;var u="";if(t.metadata!==undefined&&t.metadata.getPropertyMetadata(p[i].fieldName).unit!==undefined){var U=t.metadata.getPropertyMetadata(p[i].fieldName).unit;u=t.getData()[0][U];for(q=0;q<t.getData().length;q++){if(u!==t.getData()[q][U]){u=undefined;break;}}C.name[i]=p[i].fieldDesc===undefined||!t.oApi.getTextNotHtmlEncoded(p[i].fieldDesc).length?r:t.oApi.getTextNotHtmlEncoded(p[i].fieldDesc);if(u!==undefined&&u!==""){C.name[i]=t.oApi.getTextNotHtmlEncoded("displayUnit",[C.name[i],u]);}}else{C.name[i]=p[i].fieldDesc===undefined||!t.oApi.getTextNotHtmlEncoded(p[i].fieldDesc).length?r:t.oApi.getTextNotHtmlEncoded(p[i].fieldDesc);}}}return C;}function o(v){var s;var S=v.getSelectedSortItem();v.getSortItems().forEach(function(i){if(i.getId()===S){s=i.getKey();}});return s;}sap.apf.ui.representations.table=function(A,p){this.nFirstVisibleRow=0;this.oViewSettingDialog=undefined;this.aDataResponse=[];this.aValidatedFilter=[];this.aFiltersInTable=[];this.oParameter=p;this.orderby=p.orderby;this.omitTopAndSkipOptionsForNextPathUpdate=false;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,p]);this.alternateRepresentation=p.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler(this);this.oPaginationDisplayOptionHandler=new sap.apf.ui.representations.utils.PaginationDisplayOptionHandler();};sap.apf.ui.representations.table.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.table.prototype.constructor=sap.apf.ui.representations.table;sap.apf.ui.representations.table.prototype.setData=function(D,i,p,v){var s=this;var r,q;if(!i){var M=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}this.metadata=i;this.oFormatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata,this.aDataResponse);if(this.oParameter.requiredFilters.length>0){r=this.oParameter.requiredFilters[0];q=i.getPropertyMetadata(r).text;}if(!this.oParameter.isAlternateRepresentation){if(r){this.aValidatedFilter=[];if(v&&v.length>0){v.forEach(function(y){s.aValidatedFilter.push(y[r]);s.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(y[r],y[q]);});s.aFiltersInTable=s.aValidatedFilter;}else{s.aFiltersInTable=[];}}var t=this.getRequestOptions();var u=t.paging&&t.paging.skip;this.nDataResponseCount=p;if(u===undefined||u===0){this.aDataResponse=D;this.nFirstVisibleRow=0;}else{D.map(function(y){s.aDataResponse.push(y);});}if(!this.oParameter.top&&this.titleControl){var w=(this.aDataResponse&&this.aDataResponse.length)||0;var x=this.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[this.title,w,p]);this.titleControl.setText(x);}}else{this.aDataResponse=D;}if(q){this.aDataResponse.forEach(function(y){s.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(y[r],y[q]);});}};sap.apf.ui.representations.table.prototype.getFilter=function(){this.filter=this.oRepresentationFilterHandler.createFilterFromSelectedValues(this.aFiltersInTable);return this.filter;};sap.apf.ui.representations.table.prototype.getSelections=function(){var t=this,s=[],S;var r=t.parameter.requiredFilters[0];a(t,r);t.aFiltersInTable.forEach(function(i){S=t.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(i,t.parameter.requiredFilterOptions,r,t.oFormatter);s.push({id:i,text:S});});return s;};sap.apf.ui.representations.table.prototype.markSelectionInTable=function(i){var r=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(r){var s=b(this,r);if(this.oParameter.isAlternateRepresentation){var S=[];var p=this.tableControl.getBinding().aIndices;s.forEach(function(q){S.push(p.indexOf(q));});s=S;}this.tableControl.clearSelection();if(s.length>0){_(this.tableControl,s);}}};sap.apf.ui.representations.table.prototype.getRequestOptions=function(F,i){this.bIsAlternateRepresentation=i;if(F){this.oPaginationHandler.resetPaginationOption();}var r={paging:{},orderby:[]};if(F){this.omitTopAndSkipOptionsForNextPathUpdate=false;}if(this.omitTopAndSkipOptionsForNextPathUpdate){r.paging={inlineCount:true};}else if(!this.bIsAlternateRepresentation){r.paging=this.oPaginationHandler.getPagingOption(this.oParameter.top);}if(this.orderby){r.orderby=this.orderby;}if(this.oViewSettingDialog){var s=o(this.oViewSettingDialog);if(s){var S={property:o(this.oViewSettingDialog),ascending:!this.oViewSettingDialog.getSortDescending()};this.orderby=[S];r.orderby=[S];}}return r;};sap.apf.ui.representations.table.prototype.resetPaginationForTable=function(){this.oPaginationHandler.resetPaginationOption();};sap.apf.ui.representations.table.prototype.getMainContent=function(s,i,w){var p=this;function q(z,A){var B=p.nDataResponseCount||0;var C,D,E;var F=p.oApi.getTextNotHtmlEncoded("buttonTextExport");var G=new sap.m.Button({text:F,press:function(){p.exportExcel(z);}});if(p.oParameter.top){C=new sap.m.HBox({items:[G]});E=p.title;}else{F=p.oApi.getTextNotHtmlEncoded("buttonTextLoadAll");D=new sap.m.Button({text:F,press:p.loadAll.bind(p)});C=new sap.m.HBox({items:[D,G]});E=p.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[p.title,A,B]);}p.titleControl=new sap.m.Title({text:E,level:sap.ui.core.TitleLevel.H1});var H=new sap.m.HBox({alignItems:"Start",justifyContent:"SpaceBetween",items:[p.titleControl,C]});return H;}var t=this.getData();this.title=s;var r=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var u=n(this);var M;if(!s){M=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(r.length===0){M=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",s]});this.oApi.putMessage(M);}if(!t||t.length===0){M=this.oApi.createMessageObject({code:"6000",aParameters:[s]});this.oApi.putMessage(M);}var v=(w||1000)+"px";if(this.oParameter.isAlternateRepresentation){this.tableControl=k(u,s,this);}else{var x=q(s,t.length);this.tableControl=k(u,x,this);}this.tableControl.attachRowSelectionChange(d.bind(p));var y=new sap.m.ScrollContainer({content:[this.tableControl],width:v,horizontal:false}).addStyleClass("tableRepresentation");if(sap.ui.Device.system.desktop){y.addStyleClass("sapUiSizeCompact");}this.tableControl.addEventDelegate({onAfterRendering:function(){if(p.oParameter){p.markSelectionInTable(true);l(p.tableControl);m(y,p);if(!p.oParameter.top&&!p.oParameter.isAlternateRepresentation&&p.nDataResponseCount>100){p.oPaginationHandler.attachPaginationOnTable(p);}}}});return y;};sap.apf.ui.representations.table.prototype.getThumbnailContent=function(){var t;var T=this.getData();var i=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(T!==undefined&&T.length!==0){var p=new sap.ui.core.Icon({src:i,size:"70px"}).addStyleClass('thumbnailTableImage');t=p;}else{var q=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');t=new sap.ui.layout.VerticalLayout({content:q});}return t;};sap.apf.ui.representations.table.prototype.removeAllSelection=function(){g(this);this.tableControl.clearSelection();this.oApi.selectionChanged();};sap.apf.ui.representations.table.prototype.getPrintContent=function(s){var t=n(this),p;var P=k(t,s,this);P.setTitle(s);P.getColumns().forEach(function(i){i.setWidth("auto");});P.setVisibleRowCount(P.getModel().getData().tableData.length);h(this,P);p={oRepresentation:P};return p;};sap.apf.ui.representations.table.prototype.getViewSettingDialog=function(){if(!this.oViewSettingDialog){var v={oTableInstance:this};var V=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:v});this.oViewSettingDialog=V.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact");}return this.oViewSettingDialog;};sap.apf.ui.representations.table.prototype.loadAll=function(){this.omitTopAndSkipOptionsForNextPathUpdate=true;this.oApi.selectionChanged();};sap.apf.ui.representations.table.prototype.exportExcel=function(s){var t=this;function p(){var v=n(t);var r=[];var i,w;for(i=0;i<v.value.length;i++){w=sap.apf.ui.utils.determineColumnSettingsForSpreadSheetExport(v.value[i],t.metadata);w.property=v.value[i];w.label=v.name[i];r.push(w);}return r;}var q=this.getData();var r=p();var S={workbook:{columns:r},dataSource:q,fileName:s+".xlsx"};var u=new sap.ui.export.Spreadsheet(S);u.build();};sap.apf.ui.representations.table.prototype.onChartSwitch=function(){this.resetPaginationForTable();};sap.apf.ui.representations.table.prototype.destroy=function(){if(this.orderby){this.orderby=null;}if(this.oParameter){this.oParameter=null;}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy();}if(this.aDataResponse){this.aDataResponse=null;}if(this.aValidatedFilter){this.aValidatedFilter=[];}if(this.aFiltersInTable){this.aFiltersInTable=[];}};}());
