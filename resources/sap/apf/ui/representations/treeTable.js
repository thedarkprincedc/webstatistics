/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.declare("sap.apf.ui.representations.treeTable");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.ui.utils.formatter");jQuery.sap.require("sap.apf.modeler.ui.utils.constants");jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");jQuery.sap.require("sap.apf.ui.representations.utils.paginationDisplayOptionHandler");jQuery.sap.require("sap.ui.table.TreeTable");(function(){'use strict';function g(r,n){if(r&&r.length>0){if(n.getPropertyMetadata(r[0])["filter-restriction"]==="single-value"){return sap.ui.table.SelectionMode.Single;}return sap.ui.table.SelectionMode.MultiToggle;}return sap.ui.table.SelectionMode.None;}function _(t,s,T){var o;var n=function(u){return function(v){if(T.metadata!==undefined){var w;if(v){w=T.oFormatter.getFormattedValue(u,v);if(w!==undefined){return w;}}}return v;};};o=new sap.ui.table.TreeTable({showNoData:false,title:s,enableSelectAll:false});var r=T.oParameters.requiredFilters;o.setSelectionMode(g(r,T.metadata));var C=[],p,q;t.name.forEach(function(u,v){p=new sap.m.Text().bindText(t.value[v],n(t.value[v]),sap.ui.model.BindingMode.OneWay);q=new sap.ui.table.Column({label:new sap.m.Label({text:u}),template:p,tooltip:u});C.push(q);});C.forEach(function(u){o.addColumn(u);});T.oTreeTableModel.attachBatchRequestCompleted(function(){if(T.oApi.getUiApi().getLayoutView().getController()&&T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer")){T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer").getContent()[0].byId("idStepLayout").setBusy(false);}k(o);b(T,o,t);if(T.oRepresentationFilterHandler.getFilterValues().length>0){a(T);}else{T.oTreeTable.clearSelection();}});T.oTreeTableModel.attachBatchRequestSent(function(E){if(T.oApi.getUiApi().getLayoutView().getController()&&T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer")){T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer").getContent()[0].byId("idStepLayout").setBusy(true);}});o.setModel(T.oTreeTableModel);o.bindRows(T.oTreeTableControlObject);return o;}function a(t){var T=t.oTreeTable.getRows();t.oTreeTable.clearSelection();setTimeout(function(){T.forEach(function(r,n){var o=r.getBindingContext();if(o){var R=o.getProperty(t.oParameters.requiredFilters[0]);t.oRepresentationFilterHandler.getFilterValues().forEach(function(p){if(R===p){t.oTreeTable.addSelectionInterval(n,n);}});}});},1);}function b(t,T,n){if(t.metadata!==undefined){for(var o=0;o<n.name.length;o++){var M=t.metadata.getPropertyMetadata(n.value[o]);if(M["aggregation-role"]==="measure"){var p=T.getColumns()[o];p.setHAlign(sap.ui.core.HorizontalAlign.End);}}}}function c(E){var n=E.getParameter("userInteraction");var o=E.getParameter("rowIndex");if(!n||o===undefined||o===null){return;}var r=this.oParameters.requiredFilters;var R=r&&(r.length>0)?r[0]:undefined;d(this,R,o);}function d(t,r,n){var C=t.oTreeTable.getContextByIndex(n).getProperty(r);var s=t.oTreeTable.getSelectionMode();var I=t.oTreeTable.isIndexSelected(n);var D=t.oTreeTable.getContextByIndex(n).getProperty(t.metadata.getPropertyMetadata(r).text);t.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(C,D);var u=t.oRepresentationFilterHandler.getFilterValues();if(I){u=h(t,s,C,u);}else{u=i(t,s,C,u);}j(t,u);t.oApi.selectionChanged();}function e(t){t.oRepresentationFilterHandler.clearFilters();}function f(F){return F.filter(function(n,o,p){return p.indexOf(n)===o;});}function h(t,s,C,u){if(s===sap.ui.table.SelectionMode.Single){u=[C];}else{u.push(C);}return f(u);}function i(t,s,C,u){if(s===sap.ui.table.SelectionMode.Single){u=[];}else{var n=u.indexOf(C);if(n!==-1){u.splice(n,1);}}return u;}function j(t,u){e(t);t.oRepresentationFilterHandler.updateFilterFromSelection(u);t.oApi.selectionChanged();}function k(t){var n;if(jQuery('.chartContainer').height()){n=jQuery('.chartContainer').height()-(jQuery(".chartContainer > div :first-child").height()+120);}var v=(n>0)?n/32:15;var o=Math.floor(v);t.setVisibleRowCount(o+1);}function l(C,t){var s;var n=jQuery('.treeTableRepresentation').offset().top;var S=t.oApi.getUiApi().getStepContainer();if(S&&S.getContent()[0]&&S.getContent()[0].getContent()[0].getFullScreen()){s=((window.innerHeight-(n+80)))+"px";}else{s=((window.innerHeight-n)-(jQuery(".applicationFooter").height()+jQuery(".subHeader").height()+80))+"px";}document.querySelector('.treeTableRepresentation').style.cssText+="height : "+s;}function m(t){var C={name:[],value:[]};var p=t.oParameters.hierarchicalProperty.concat(t.oParameters.properties);p.forEach(function(n,o){var q=n.fieldName;var r=t.metadata.getPropertyMetadata(q).label||t.metadata.getPropertyMetadata(q).name;if(n.kind===sap.apf.modeler.ui.utils.CONSTANTS.propertyTypes.HIERARCHIALCOLUMN){if(n.labelDisplayOption==="text"){q=t.metadata.getPropertyMetadata(t.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeFor).text;}else{q=t.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeExternalKeyFor;}}C.name[o]=n.fieldDesc===undefined||!t.oApi.getTextNotHtmlEncoded(n.fieldDesc).length?r:t.oApi.getTextNotHtmlEncoded(n.fieldDesc);C.value[o]=q;});return C;}sap.apf.ui.representations.treeTable=function(A,p){this.oParameters=p;this.oKeyTextLookup={};this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,p]);this.oPaginationDisplayOptionHandler=new sap.apf.ui.representations.utils.PaginationDisplayOptionHandler();};sap.apf.ui.representations.treeTable.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.treeTable.prototype.constructor=sap.apf.ui.representations.treeTable;sap.apf.ui.representations.treeTable.prototype.getMainContent=function(s,n){var t=this,o;if(!n){var T=m(this);if(!this.oTreeTable){this.oTreeTable=_(T,s,this);this.oTreeTable.addEventDelegate({onAfterRendering:function(){if(t.oParameters){l(o,t);k(t.oTreeTable);if(t.oRepresentationFilterHandler.getFilterValues().length>0){a(t);}else{t.oTreeTable.clearSelection();}}}});this.oTreeTable.attachRowSelectionChange(c.bind(this));}}o=new sap.m.ScrollContainer({content:[t.oTreeTable],horizontal:false}).addStyleClass("treeTableRepresentation");if(sap.ui.Device.system.desktop){o.addStyleClass("sapUiSizeCompact");}return o;};sap.apf.ui.representations.treeTable.prototype.getSelections=function(){var s=[],t=this,S;this.oRepresentationFilterHandler.getFilterValues().forEach(function(n){S=n;if(t.parameter.requiredFilterOptions&&t.parameter.requiredFilterOptions.labelDisplayOption){S=t.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(n,t.parameter.requiredFilterOptions,t.parameter.requiredFilters[0],t.oFormatter);}s.push({id:n,text:S});});return s;};sap.apf.ui.representations.treeTable.prototype.removeAllSelection=function(){this.oRepresentationFilterHandler.clearFilters();this.oTreeTable.clearSelection();this.oApi.selectionChanged();};sap.apf.ui.representations.treeTable.prototype.getFilter=function(){var n=this.oApi.createFilter();var A=n.getTopAnd().addOr('exprssionOr');this.oRepresentationFilterHandler.getFilterValues().forEach(function(o){var F={id:o,name:this.oParameters.requiredFilters[0],operator:"EQ",value:o};A.addExpression(F);}.bind(this));return n;};sap.apf.ui.representations.treeTable.prototype.setFilterValues=function(v){var t=this,F=[];var r=t.oParameters.requiredFilters[0];t.oRepresentationFilterHandler.clearFilters();v.forEach(function(n){t.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(n[r],n[t.metadata.getPropertyMetadata(r).text]);F.push(n[r]);});t.oRepresentationFilterHandler.updateFilterFromSelection(F);};sap.apf.ui.representations.treeTable.prototype.updateTreetable=function(n,M,o,F){this.oTreeTableModel=M;this.oTreeTableControlObject=n;this.metadata=o;this.oFormatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata);if(this.oTreeTable&&F){this.oTreeTable.bindRows(this.oTreeTableControlObject);}};sap.apf.ui.representations.treeTable.prototype.getThumbnailContent=function(){var t;var T=new sap.ui.core.Icon({src:"sap-icon://tree",size:"70px"}).addStyleClass('thumbnailTableImage');t=T;return t;};sap.apf.ui.representations.treeTable.prototype.getPrintContent=function(s){var t=this.oTreeTable.clone();var p={oRepresentation:t};return p;};sap.apf.ui.representations.treeTable.prototype.getSelectedFilterPropertyLabel=function(r){return this.metadata.getPropertyMetadata(r)["hierarchy-node-for"];};sap.apf.ui.representations.treeTable.prototype.destroy=function(){if(this.oParameters){this.oParameters=null;}if(this.oTreeTableModel){this.oTreeTableModel=null;}if(this.oTreeTableControlObject){this.oTreeTableControlObject=null;}if(this.metadata){this.metadata=null;}if(this.oRepresentationFilterHandler){this.oRepresentationFilterHandler=null;}};}());
