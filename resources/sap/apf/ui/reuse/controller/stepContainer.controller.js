/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
*/
(function(){"use strict";var c,u,a,r=false,b=false;function _(){var R=a.getSelectedRepresentation();if(R.type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){return true;}return false;}function d(){var R=a.getSelectedRepresentation();if(R.type===sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION){return true;}return false;}function e(){if(a.getSelectedRepresentation().bIsAlternateView===undefined||a.getSelectedRepresentation().bIsAlternateView===false){return false;}return true;}function f(C){var R=C.getCurrentRepresentation();var i=R.getParameter().requiredFilters;if(i===undefined||i.length===0){return undefined;}return i[0];}function g(C,i){var j=C.byId("idChartContainer");var A="0";var B=jQuery(window).width();var D=j.getId();if(jQuery("#"+D).length!==0){A=jQuery("#"+D+" > div:first-child > div:nth-child(2)").offset().top;B=jQuery("#"+D+" > div:first-child > div:nth-child(2)").width();}var E=(jQuery(window).height()-A)-jQuery(".applicationFooter").height();var F=B;i.setHeight(E+"px");i.setWidth(F+"px");}function h(C){var i=C.byId("idChartContainer");var R=C.getCurrentRepresentation();var T=a.longTitle&&!c.isInitialTextKey(a.longTitle.key)?a.longTitle:a.title;var S=c.getTextNotHtmlEncoded(T);var j=R.getMainContent(S,b);b=false;var A={onBeforeRendering:function(){g(C,j);}};j.addEventDelegate(A);i.removeAllContent();var B=new sap.suite.ui.commons.ChartContainerContent({content:j});i.addContent(B);}function k(C,i){var S=C.byId("idSelectedText");var j=x(C);var A=C.getCurrentRepresentation().getSelectionFilterLabel();var B=A+" ("+j+") ";var D=C.byId("idSelPropertyAndCount");if(!D){D=new sap.m.Link({id:C.createId("idSelPropertyAndCount"),press:C.handlePressSelectedPropertyCountLink.bind(C)});D.addAriaLabelledBy(S.getId());}D.setVisible(true);D.setText(B);i.addContent(D);i.onAfterRendering=function(){var E=this;if(E.getContent().length>=5){E.getContent()[4].focus();}};}function l(C){var i=C.byId("idChartContainer");i.removeAllCustomIcons();m(C);n(C);o(C);}function m(C){var j=C.byId("idChartContainer");var A=a.getSelectedRepresentationInfo();var B;if(A.parameter&&A.parameter.orderby){new sap.apf.ui.utils.Helper(c).getRepresentationSortInfo(A).done(function(F){var S=[];for(var i=0;i<F.length;i++){F[i].done(function(G){S.push(G);});}B=S.join(", ");var D=c.getTextNotHtmlEncoded(A.label)+"\n"+((B!==undefined)?c.getTextNotHtmlEncoded("sortBy")+": "+B:"");var E=new sap.ui.core.Icon({src:A.picture,tooltip:D,press:function(G){C.handlePressChartIcon(G);}});j.addCustomIcon(E);});}else{var D=c.getTextNotHtmlEncoded(A.label)+"\n"+((B!==undefined)?c.getTextNotHtmlEncoded("sortBy")+": "+B:"");var E=new sap.ui.core.Icon({src:A.picture,tooltip:D,press:function(i){C.handlePressChartIcon(i);}});j.addCustomIcon(E);}}function n(C){if(_()||d()){return;}var i=C.byId("idChartContainer");var j=c.getTextNotHtmlEncoded("listView");var A=new sap.ui.core.Icon({src:"sap-icon://table-view",tooltip:j,press:C.handlePressAlternateRepIcon.bind(C)});i.addCustomIcon(A);}function o(C){if((C.getCurrentRepresentation().topN!==undefined)||(!e()&&!_())||(d())){return;}var i=C.byId("idChartContainer");var j=c.getTextNotHtmlEncoded("view-Settings-Button");var A=new sap.ui.core.Icon({src:"sap-icon://drop-down-list",tooltip:j,press:function(){C.getCurrentRepresentation().getViewSettingDialog().open();}});i.addCustomIcon(A);}function p(C,i){var S=C.byId("idSelectedText");if(!S){S=new sap.m.Label({id:C.createId("idSelectedText"),text:c.getTextNotHtmlEncoded("selectedValue")});}S.setVisible(true);i.addContent(S);}function q(C,i){var R=C.byId("idReset");if(!R){R=new sap.m.Button({text:c.getTextNotHtmlEncoded("reset"),id:C.createId("idReset"),type:"Transparent",press:C.handlePressResetButton.bind(C)}).addStyleClass("chartContainerResetStyle");}R.setVisible(true);i.addContent(R);}function s(C,i){var j=x(C);if(j>0&&f(C)!==undefined){p(C,i);k(C,i);q(C,i);}}function t(C,i){var P=C.byId("idPathFilterDisplayButton");if(!P){P=new sap.m.Button({text:c.getTextNotHtmlEncoded("pathFilterDisplayButton"),id:C.createId("idPathFilterDisplayButton"),icon:"sap-icon://message-information",type:"Transparent",press:function(){if(C.byId("idStepLayout").getBusy()===false){c.getPathFilterInformation().done(function(j){var A=new sap.ui.xmlview({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:j,oCoreApi:c,oUiApi:u},id:C.createId("pathFilterDisplay")});A.setParent(C.getView());A.getContent()[0].open();});}}});}i.addContent(P);}function v(C){var i=C.byId("idChartContainer");var j=i.getToolbar();if(j){j.removeAllContent();}else{j=new sap.m.OverflowToolbar();}var A=new sap.m.Label({text:c.getTextNotHtmlEncoded("currentStep")});j.addContent(A);var S=new sap.m.ToolbarSpacer();j.addContent(S);s(C,j);t(C,j);j.addContent(new sap.suite.ui.commons.ChartContainerToolbarPlaceholder());i.setToolbar(j);}function w(C){if(a===undefined){return;}h(C);l(C);v(C);}function x(C){var i=C.getCurrentRepresentation();var j=i.getSelections().length;return j;}function y(C,A){var B=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,showSeparators:sap.m.ListSeparators.None,includeItemInSelection:true,selectionChange:C.handleSelectionChartSwitchIcon.bind(C)});var D;var R;for(var j=0;j<a.getRepresentationInfo().length;j++){R=a.getRepresentationInfo()[j];D=undefined;if(R.parameter&&R.parameter.orderby){new sap.apf.ui.utils.Helper(c).getRepresentationSortInfo(R).done(function(F){var G=[];for(var i=0;i<F.length;i++){F[i].done(function(H){G.push(H);});}D=G.join(", ");var E=D!==undefined?c.getTextNotHtmlEncoded("sortBy")+": "+D:"";var I=new sap.m.StandardListItem({description:E,icon:R.picture,title:c.getTextNotHtmlEncoded(R.label),customData:[new sap.ui.core.CustomData({key:'data',value:{oRepresentationType:R,icon:R.picture}})]});B.addItem(I);});}else{var E=D!==undefined?c.getTextNotHtmlEncoded("sortBy")+": "+D:"";var I=new sap.m.StandardListItem({description:E,icon:R.picture,title:c.getTextNotHtmlEncoded(R.label),customData:[new sap.ui.core.CustomData({key:'data',value:{oRepresentationType:R,icon:R.picture}})]});B.addItem(I);}}if(!C.byId("idAllChartPopover")){var S=new sap.m.Popover({id:C.createId("idAllChartPopover"),placement:sap.m.PlacementType.Bottom,showHeader:false,content:[B],afterClose:function(){S.destroy();}});}C.byId("idAllChartPopover").openBy(A);}function z(C,i){C.byId("idReset").setVisible(i);C.byId("idSelPropertyAndCount").setVisible(i);C.byId("idSelectedText").setVisible(i);}sap.ui.controller("sap.apf.ui.reuse.controller.stepContainer",{onInit:function(){var C=this;c=C.getView().getViewData().oCoreApi;u=C.getView().getViewData().uiApi;a=c.getActiveStep();this.initialText=new sap.m.Label({id:this.createId("idInitialText")}).addStyleClass('initialText');this.initialText.setText(c.getTextNotHtmlEncoded('initialText'));},onAfterRendering:function(){var C=this;jQuery(window).resize(function(){var i=90;c.getSmartFilterBarConfigurationAsPromise().done(function(j){if(j){i=165;}var A=jQuery(window).height()-i;jQuery('.layoutView').css({"height":A});if(a){b=d()?true:false;}C.drawStepContent();});});jQuery(u.getStepContainer().getDomRef()).hide();if(jQuery("#"+this.initialText.getId()).length===0&&c.getSteps().length===0){jQuery('#'+u.getStepContainer().getId()).parent().append(sap.ui.getCore().getRenderManager().getHTML(this.initialText));}else if(c.getSteps().length>0){jQuery(u.getStepContainer().getDomRef()).show();}if(u.getAnalysisPath().getController().isOpenPath){jQuery(".initialText").remove();}},getCurrentRepresentation:function(){var i=a.getSelectedRepresentation();if(e()){i=a.getSelectedRepresentation().toggleInstance;}return i;},handlePressSelectedPropertyCountLink:function(){var C=this;C.oCoreApi=c;var i=new sap.ui.jsfragment("idSelectionDisplayFragment","sap.apf.ui.reuse.fragment.selectionDisplay",C);i.open();},handlePressResetButton:function(){var C=this;if(e()){C.getCurrentRepresentation().removeAllSelection();}C.getCurrentRepresentation().removeAllSelection();z(C,false);},createToggleRepresentationInstance:function(R,j){var A={};function B(F){var G=F.dimensions;var E=R.getMetaData();if(E===undefined){return F;}var i,H;for(i=0;i<G.length;i++){var S=E.getPropertyMetadata(G[i].fieldName).hasOwnProperty('text');if(S&&G[i].labelDisplayOption===sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){H={};H.fieldName=E.getPropertyMetadata(G[i].fieldName).text;F.dimensions.splice(i+1,0,H);}else if(S&&G[i].labelDisplayOption===sap.apf.core.constants.representationMetadata.labelDisplayOptions.TEXT){H={};H.fieldName=E.getPropertyMetadata(G[i].fieldName).text;F.dimensions.splice(i,1,H);}}F.isAlternateRepresentation=true;return F;}var C=jQuery.extend(true,{},R.getParameter());delete C.alternateRepresentationTypeId;delete C.alternateRepresentationType;C=B(C);if(j){C.orderby=j;}A=c.createRepresentation(R.getParameter().alternateRepresentationType.constructor,C);var D=R.getData(),E=R.getMetaData();if(D!==undefined&&E!==undefined){A.setData(D,E);}return A;},handlePressAlternateRepIcon:function(){var C=this;var i=a.getSelectedRepresentation();i.bIsAlternateView=true;if(e()){i.toggleInstance=C.createToggleRepresentationInstance(i);}r=true;C.getView().getViewData().uiApi.selectionChanged(true);},handlePressChartIcon:function(E){var C=this;var i=a.getSelectedRepresentation();var j=c.getSteps().indexOf(a);if(a.getRepresentationInfo().length>1){var A=E.getParameter("controlReference");y(C,A);}else{i.bIsAlternateView=false;r=true;u.getAnalysisPath().getCarousel().getStepView(j).getController().drawThumbnailContent(true);C.drawStepContent();}},handleSelectionChartSwitchIcon:function(E){var C=this;C.byId("idAllChartPopover").close();var S=E.getParameter("listItem").getCustomData()[0].getValue();var i=c.getSteps().indexOf(a);var j=a.getSelectedRepresentationInfo().representationId;var A=S.oRepresentationType.representationId;if(j===A&&a.getSelectedRepresentation().bIsAlternateView===false){return;}r=true;a.getSelectedRepresentation().bIsAlternateView=false;a.setSelectedRepresentation(S.oRepresentationType.representationId);u.getAnalysisPath().getController().refresh(S.nActiveStepIndex);c.updatePath(u.getAnalysisPath().getController().callBackForUpdatePath.bind(u.getAnalysisPath().getController()));u.getAnalysisPath().getCarousel().getStepView(i).getController().drawThumbnailContent(true);},drawStepContent:function(S){var C=this,i=false;var P=a;a=c.getActiveStep();if(P!==a){i=true;}var j=c.getSteps().indexOf(a);var A=u.getAnalysisPath().getCarousel().getStepView(j);if(A===undefined){return;}var T=A.oThumbnailChartLayout.isBusy();if(T){C.byId("idStepLayout").setBusy(true);}if(S||r||i){w(C);}else{v(C);}r=false;C.byId("idStepLayout").setBusy(false);}});}());
