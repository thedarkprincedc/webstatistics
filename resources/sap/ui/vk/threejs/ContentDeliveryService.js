/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./thirdparty/three","sap/ui/vk/threejs/thirdparty/matai","./PerspectiveCamera","./OrthographicCamera","sap/ui/vk/View"],function(q,M,t,m,P,O,V){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{publicMethods:["initUrl","load","update","loadView"],events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true},errorReported:{paramters:{error:{type:"any"}}}}}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this);}this._loader=null;this._transientSceneMap=new Map();};C.prototype.initUrl=function(u){var a=this;var d;var e;if(!a._loader){this._loader=new Matai.Loader();}var p=[];if(q.sap.startsWith(u,"ws")){d=new Matai.Loader.WebSocketConnection();e=d.init(u).then(function(){a._loader.init(d);}).catch(function(f){a._loader=null;throw f;});p.push(e);}else if(q.sap.startsWith(u,"http")){d=new Matai.Loader.HttpConnection();e=d.init(u).then(function(){a._loader.init(d);});p.push(e);}else{a._loader=null;p.push(Promise.reject("Content Delivery Service only allows http and websocket connection"));}return Promise.all(p);};function c(a){if(!a){return null;}var d;if(a.isOrthographicCamera){d=new sap.ui.vk.threejs.OrthographicCamera();}else if(a.isPerspectiveCamera){d=new sap.ui.vk.threejs.PerspectiveCamera();}d.setCameraRef(a);d.setUsingDefaultClipPlanes(true);if(a.cameraInfo&&a.cameraInfo.zoom===-1){d.setZoomNeedRecalculate(true);}return d;}C.prototype._createLoadParam=function(r,a,s,p,d){var e=this;var i;var f=false;var g=false;if(s.logger===true){g=true;}var h={root:p,onActiveCamera:function(n){var j=false;var k=e._loader.getState();if(k){var l=k.contextMap.get(s.veid);if(l&&l.phase<2){i=c(n);j=true;}}if(!j){e.fireCameraChanged({sceneId:s.veid,camera:c(n)});}},onSetGeometry:function(){e.fireSceneUpdated({sceneId:s.veid});},onInitialSceneFinished:function(){f=true;r({node:p,camera:i,contentResource:d,loader:e});},activateView:s.activateView,logger:g,onError:function(j){var k;if(j.errorText){k=j.errorText;}else if(j.error){k=j.error;}else if(j.reason){k=j.reason;}else{k="failed to load: unknown reason";}if(!f){a(k);}else{e.fireErrorReported(j);}}};return h;};C.prototype.load=function(p,a){var d=this;return new Promise(function(r,f){var s;try{s=JSON.parse(a.getSource());}catch(e){f("ContentDeliveryService.load - invalid json: contentResource");return;}if(!s||!s.veid){f("url or veid not specified");return;}d.initUrl(s.url).then(function(){var g=d._createLoadParam(r,f,s,p,a);d._loader.request(s.veid,g);}).catch(function(g){f(g);});});};C.prototype.getState=function(){if(this._loader){return this._loader.getState();}return null;};C.prototype.decrementResouceCountersForDeletedTreeNode=function(s){var a=this.getState();if(a){a.contextMap.forEach(function(v,k){if(v.treeNodeMap.has(s)){Matai.decrementResouceCountersForDeletedTreeNode(a,v,s);}});}};C.prototype.loadTransientScene=function(s,p){var a=this;return new Promise(function(r,d){if(!s||!p){d("invalid arguments");return;}if(a._transientSceneMap.has(s)){var e=a._transientSceneMap.get(s).clone();p.add(e);r({nodeRef:e});return;}if(!a._loader){d("ContentDeliveryService is not initialised");return;}var f=new THREE.Object3D();f.name="transient";var g={root:f,onSceneCompleted:function(){a._transientSceneMap.set(s,f);var e=f.clone();p.add(e);r({nodeRef:e});}};a._loader.request(s,g);});};C.prototype.update=function(s,a,v){if(!this._loader){return Promise.reject("ContentDeliveryService is not initialised");}else{return Promise.resolve(this._loader.update(s,a,v));}};C.prototype.exit=function(){if(b.exit){b.exit.call(this);}if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,a){if(typeof a==="undefined"){a="static";}return this._loader.requestView(s,a,v).then(function(d){var e=new sap.ui.vk.View({name:d.name,nodeInfos:d.viewNodes});if(d.camera){var f=true;var r=false;if(d.camera.cameraInfo&&d.camera.cameraInfo.zoom===-1){r=true;}if(d.camera.type==="PerspectiveCamera"){e.setCameraInfo({type:d.camera.type,fov:d.camera.cameraInfo.fov*180/Math.PI,position:d.camera.position.toArray(),nearClipPlane:d.camera.near,farClipPlane:d.camera.far,upDirection:d.camera.up.toArray(),targetDirection:d.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f});}if(d.camera.type==="OrthographicCamera"){e.setCameraInfo({type:d.camera.type,zoomFactor:d.camera.zoom,position:d.camera.position.toArray(),nearClipPlane:d.camera.near,farClipPlane:d.camera.far,upDirection:d.camera.up.toArray(),targetDirection:d.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f,zoomNeedRecalculate:r});}}return e;}).catch(function(e){q.sap.log.error(e);return null;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
