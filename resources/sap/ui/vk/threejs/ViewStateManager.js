/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/core/Element","../ContentConnector","../ViewStateManagerBase"],function(q,E,C,V){"use strict";var a;var b=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{publicMethods:["enumerateSelection","getNodeHierarchy","getOpacity","getSelectionState","getTintColor","getVisibilityChanges","getVisibilityState","setOpacity","setSelectionState","setTintColor","setVisibilityState","setShowSelectionBoundingBox","getShowSelectionBoundingBox"]}});var c=b.getMetadata().getParent().getClass().prototype;b.prototype.init=function(){if(c.init){c.init.call(this);}this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._visibilityTracker=new a();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this.setHighlightColor("rgba(255, 0, 0, 1.0)");};b.prototype._setContent=function(e){var s=null;if(e&&e.scene instanceof sap.ui.vk.threejs.Scene){s=e.scene;}this._setScene(s);};b.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};b.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};b.prototype._handleContentReplaced=function(e){var f=e.getParameter("newContent");this._setContent(f);};b.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);return this;};b.prototype._setNodeHierarchy=function(n){var o=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._visibilityTracker.clear();}if(n){this._nodeHierarchy=n;var v=[],h=[];var e=n.findNodesByName();e.forEach(function(f){(f.visible?v:h).push(f);});this.fireVisibilityChanged({visible:v,hidden:h});}if(n!==o){this.fireNodeHierarchyReplaced({oldNodeHierarchy:o,newNodeHierarchy:n});}return this;};b.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};b.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};b.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),e=n.findNodesByName(),v=[],h=[];e.forEach(function(f){var g=n.createNodeProxy(f),i=q.grep(g.getVeIds(),function(i){return i.type==="VE_LOCATOR";})[0].fields[0].value;n.destroyNodeProxy(g);if(this.getVisibilityState(f)){v.push(i);}else{h.push(i);}},this);return{visible:v,hidden:h};};b.prototype.getVisibilityState=function(n){return Array.isArray(n)?n.map(function(e){return e.visible;}):n.visible;};b.prototype.setVisibilityState=function(n,v,r){if(!Array.isArray(n)){n=[n];}n=(r?this._collectNodesRecursively(n):n).filter(function(f,i,s){return s.indexOf(f)===i;});var e=n.filter(function(f){return f.visible!=v;},this);if(e.length>0){e.forEach(function(f){f.visible=v;},this);if(this.getShouldTrackVisibilityChanges()){e.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged({visible:v?e:[],hidden:v?[]:e});}return this;};b.prototype.enumerateSelection=function(e){this._selectedNodes.forEach(e);return this;};b.prototype.getSelectionState=function(n){var s=this._selectedNodes;function i(e){return s.has(e);}return Array.isArray(n)?n.map(i):i(n);};b.prototype._applyColor=function(n,e){if(n&&n.material){if(!n.userData.originalMaterial){n.userData.originalMaterial=n.material;}if(n.userData.originalMaterial){n.material=n.userData.originalMaterial.clone();}var f=sap.ui.vk.abgrToColor(e);if(n.material.color){n.material.color.r=f.red/255.0;n.material.color.g=f.green/255.0;n.material.color.b=f.blue/255.0;n.material.opacity=f.alpha;}if(Math.abs(f.alpha-1.0)>0.0001){n.material.transparent=true;}}};b.prototype._applyOpacity=function(n,o){if(n&&n.material){if(!n.userData.originalMaterial){n.userData.originalMaterial=n.material;}if(n.userData.originalMaterial===n.material){n.material=n.userData.originalMaterial.clone();}n.material.opacity=o;if(Math.abs(o-1.0)>0.0001){n.material.transparent=true;}else{n.material.transparent=false;}}};b.prototype._resetColor=function(n){if(n&&n.material){if(typeof n.userData.beHighlighted=="undefined"){if(n.userData.tintColorABGR){this._applyColor(n,n.userData.tintColorABGR);}else if(n.userData.originalMaterial){n.material=n.userData.originalMaterial;}}if(n.userData.opacity){this._applyOpacity(n,n.userData.opacity);}else if(n.userData.beHighlighted){this._applyColor(n,this._highlightColorABGR);}}};b.prototype._isAChild=function(e,n){var f=e.parent;while(f){if(n.has(f)){return true;}f=f.parent;}return false;};b.prototype._ApplyHighlightingColor=function(n){this._applyColor(n,this._highlightColorABGR);if(n.userData.opacity){this._applyOpacity(n,n.userData.opacity);}n.userData.beHighlighted=true;var e=this._nodeHierarchy.getChildren(n);var f;for(f=0;f<e.length;f++){this._ApplyHighlightingColor(e[f]);}};b.prototype._RemoveHighlightingColor=function(n){if(!this._selectedNodes.has(n)){delete n.userData.beHighlighted;this._resetColor(n);var e=this._nodeHierarchy.getChildren(n);var f;for(f=0;f<e.length;f++){this._RemoveHighlightingColor(e[f]);}}};function d(n){var p=n.parent,m=n.matrix.clone(),e=n.matrixAutoUpdate;n.parent=null;n.matrix.identity();n.matrixAutoUpdate=false;var f=new THREE.Box3().setFromObject(n);n.matrixAutoUpdate=e;n.matrix.copy(m);n.parent=p;n.updateMatrixWorld(true);return f;}b.prototype._AddBoundingBox=function(n){if(n.userData.boundingBox===undefined){n.userData.boundingBox=d(n);}if(this._boundingBoxesScene&&n.userData.boxHelper===undefined){var e=new THREE.BoxHelper(n.userData.boundingBox,0xffff00);e.matrixWorld.copy(n.matrixWorld);e.matrix.copy(n.matrixWorld);e.matrixAutoUpdate=false;n.userData.boxHelper=e;this._boundingBoxesScene.add(e);}};b.prototype._RemoveBoundingBox=function(n){if(n.userData.boundingBox!==undefined){delete n.userData.boundingBox;}if(n.userData.boxHelper!==undefined){n.userData.boxHelper.parent.remove(n.userData.boxHelper);delete n.userData.boxHelper;}};b.prototype._updateBoundingBoxesTransformation=function(){this._selectedNodes.forEach(function(n){var e=n.userData.boxHelper;if(e!==undefined){n.updateMatrixWorld();e.matrixWorld.copy(n.matrixWorld);e.matrix.copy(n.matrixWorld);}});};b.prototype._updateBoundingBoxesIfNeeded=function(){var u=new Set();this._selectedNodes.forEach(function(n){var p=n.parent;while(p){if(this._selectedNodes.has(p)){u.add(p);}p=p.parent;}}.bind(this));u.forEach(function(n){n.userData.boundingBox=d(n);if(n.userData.boxHelper!==undefined){n.userData.boxHelper.update(n.userData.boundingBox);}});};b.prototype.setShowSelectionBoundingBox=function(v){this._showSelectionBoundingBox=v;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(n){this._AddBoundingBox(n);}.bind(this));}else{this._selectedNodes.forEach(function(n){this._RemoveBoundingBox(n);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};b.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};b.prototype.setSelectionState=function(n,s,r){if(!Array.isArray(n)){n=[n];}n=(r?this._collectNodesRecursively(n):n).filter(function(v,i,j){return j.indexOf(v)===i;});var e=n.filter(function(i){return this._selectedNodes.has(i)!==s;},this);if(e.length>0){e.forEach(function(i){this._selectedNodes[s?"add":"delete"](i);},this);var f,g;var h=[];for(f=0;f<e.length;f++){if(!this._isAChild(e[f],this._selectedNodes)){h.push(e[f]);}}for(f=0;f<h.length;f++){if(s){this._ApplyHighlightingColor(h[f]);}else{this._RemoveHighlightingColor(h[f]);}}for(g=0;g<e.length;g++){if(s){if(this._showSelectionBoundingBox){this._AddBoundingBox(e[g]);}}else{this._RemoveBoundingBox(e[g]);}}this.fireSelectionChanged({selected:s?e:[],unselected:s?[]:e});}return this;};b.prototype._collectNodesRecursively=function(n){var r=[],t=this;n.forEach(function collectChildNodes(e){r.push(e);t._nodeHierarchy.enumerateChildren(e,collectChildNodes,false,true);});return r;};b.prototype._getOpacity=function(n){return n.userData&&n.userData.opacity?n.userData.opacity:null;};b.prototype.getOpacity=function(n){if(Array.isArray(n)){return n.map(this._getOpacity,this);}else{return this._getOpacity(n);}};b.prototype.setOpacity=function(n,o,r){if(!Array.isArray(n)){n=[n];}n=(r?this._collectNodesRecursively(n):n).filter(function(v,i,s){return s.indexOf(v)===i;});var e=n.filter(function(f){return this._getOpacity(f)!==o;},this);if(e.length>0){e.forEach(function(f){if(o){f.userData.opacity=o;}else{delete f.userData.opacity;}},this);e.forEach(function(f){this._resetColor(f);},this);this.fireOpacityChanged({changed:e,opacity:o});}return this;};b.prototype._getTintColorABGR=function(n){return n.userData&&n.userData.tintColorABGR?n.userData.tintColorABGR:null;};b.prototype._getTintColor=function(n){return n.userData&&n.userData.tintColorABGR?sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(n.userData.tintColorABGR)):null;};b.prototype.getTintColor=function(n,i){var g=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(n)){return n.map(this[g],this);}else{return this[g](n);}};b.prototype.setTintColor=function(n,t,r){if(!Array.isArray(n)){n=[n];}var e=null;switch(typeof t){case"number":e=t;break;case"string":if(sap.ui.core.CSSColor.isValid(t)){e=sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(t));}break;default:t=null;break;}n=(r?this._collectNodesRecursively(n):n).filter(function(v,i,s){return s.indexOf(v)===i;});var f=n.filter(function(g){return this._getTintColorABGR(g)!==e;},this);if(f.length>0){f.forEach(function(g){if(e){g.userData.tintColorABGR=e;}else if(g.userData&&g.userData.tintColorABGR){delete g.userData.tintColorABGR;}},this);f.forEach(function(g){this._resetColor(g);},this);this.fireTintColorChanged({changed:f,tintColor:t,tintColorABGR:e});}return this;};b.prototype.setHighlightColor=function(e){switch(typeof e){case"number":this._highlightColorABGR=e;break;case"string":if(sap.ui.core.CSSColor.isValid(e)){this._highlightColorABGR=sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(e));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(f){this._resetColor(f);},this);var s=Array.from(this._selectedNodes);for(var n=0;n<s.length;n++){this._ApplyHighlightingColor(s[n]);}this.fireHighlightColorChanged({highlightColor:sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});}return this;};b.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this._highlightColorABGR));};a=function(){this._visibilityChanges=new Set();};a.prototype.getInfo=function(n){var f=function(v){return v.type==="VE_LOCATOR";};var e=[];this._visibilityChanges.forEach(function(g){var h=n.createNodeProxy(g);var i=h.getVeIds();var v=q.grep(i,f)[0].fields[0].value;n.destroyNodeProxy(h);e.push(v);});return e;};a.prototype.clear=function(){this._visibilityChanges.clear();};a.prototype.trackNodeRef=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};C.injectMethodsIntoClass(b);return b;});
