/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/EventProvider","sap/ui/core/ResizeHandler","./thirdparty/three"],function(q,E,R,t){"use strict";var V=E.extend("sap.ui.vk.threejs.ViewportGestureHandler",{metadata:{publicMethods:["beginGesture","move","endGesture","click","doubleClick","contextMenu","getViewport","update"]},constructor:function(v){this._viewport=v;this._rect=null;this._evt={x:0,y:0,z:0,d:0,initd:0};this._gesture=false;this._viewport.attachEvent("resize",this,this._onresize);this._nomenu=false;var T=function(a){var v=a;var g=new THREE.Vector3();var z=new THREE.Vector2();var A=0.001;var M=-Math.PI/2+A;var b=Math.PI/2-A;this.isTurnTableMode=true;this._timeIntervalForCameraAnimation=500;this._startTimeForCameraAnimation=0;this._newCamera=null;this._oldCamera=null;this._animationType=null;this._zoomedNodeRef=null;this._isZoomIn=true;function c(r){var d=new THREE.Box3();r.traverse(function(o){var e=o.geometry;if(e!==undefined){if(!e.boundingBox){e.computeBoundingBox();}var f=e.boundingBox.clone().applyMatrix4(o.matrixWorld);d.expandByPoint(f.min);d.expandByPoint(f.max);}});return d;}function s(e,d,x){x=THREE.Math.clamp((x-e)/(d-e),0.0,1.0);return x*x*x*(x*(x*6-15)+10);}this.beginGesture=function(x,y){var d=v.getScene().getSceneRef();var e=v.getCamera().getCameraRef();var f=v.getRenderer().getSize();z.x=x/f.width*2-1;z.y=y/f.height*-2+1;var h=v.hitTest(x,y,d,e);if(h){g.copy(h.point);}else{g=c(d).getCenter();}};this.endGesture=function(){};this.pan=function(d,e){if(d===0&&e===0){return;}var f=v.getCamera().getCameraRef();var h=v.getRenderer().getSize();var o=g.clone().project(f);o.x-=d*2/h.width;o.y+=e*2/h.height;o.unproject(f).sub(g);f.position.add(o);f.updateMatrixWorld();v.setShouldRenderFrame();};this.rotate=function(d,e,i){if(i!==undefined){this.isTurnTableMode=i;}if(d===0&&e===0){return;}var f=v.getCamera().getCameraRef(),h=d*-0.01,j=e*-0.01;var o=f.position.clone().sub(g);var l=f.getWorldDirection().normalize(),u=new THREE.Vector3().setFromMatrixColumn(f.matrixWorld,1).normalize(),r=new THREE.Vector3().setFromMatrixColumn(f.matrixWorld,0).normalize();var k=new THREE.Quaternion(),m=new THREE.Quaternion();if(this.isTurnTableMode){var n=new THREE.Vector3(0,1,0);r.crossVectors(l,n).normalize();u.crossVectors(r,l);var p=Math.atan2(l.y,Math.sqrt(l.x*l.x+l.z*l.z));k.setFromAxisAngle(n,h);m.setFromAxisAngle(r,THREE.Math.clamp(j,M-p,b-p));}else{k.setFromAxisAngle(u,h);m.setFromAxisAngle(r,j);}k.multiply(m);o.applyQuaternion(k);l.applyQuaternion(k);u.applyQuaternion(k);o.add(g);f.position.copy(o);f.up.copy(u);f.lookAt(o.add(l));f.updateMatrixWorld();v.setShouldRenderFrame();};this.zoom=function(d){if(d===0||d===1){return;}var e=v.getCamera().getCameraRef();var f=new THREE.Vector3();if(e.isPerspectiveCamera){f.set(z.x,z.y,1).unproject(e);f.sub(new THREE.Vector3(z.x,z.y,-1).unproject(e));var m=g.clone().sub(e.position).length()*(1-1/d);f.setLength(m);}else if(e.isOrthographicCamera){f.set(z.x,z.y,1).unproject(e);f.sub(new THREE.Vector3(0,0,1).unproject(e));f.multiplyScalar(1-1/d);e.zoom*=d;e.updateProjectionMatrix();}else{q.sap.log.error("threejs.ViewportGestureHandler: unsupported camera type");}e.position.add(f);e.updateMatrixWorld();v.setShouldRenderFrame();};this.animateCameraUpdate=function(){if(this._newCamera===null||this._oldCamera===null){return;}var i=Math.min((Date.now()-this._startTimeForCameraAnimation)/this._timeIntervalForCameraAnimation,1);i=s(0,1,i);var d=v.getCamera().getCameraRef();if(d.isOrthographicCamera&&this._newCamera.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){d.left=THREE.Math.lerp(this._oldCamera.left,this._newCamera.left,i);d.right=THREE.Math.lerp(this._oldCamera.right,this._newCamera.right,i);d.top=THREE.Math.lerp(this._oldCamera.top,this._newCamera.top,i);d.bottom=THREE.Math.lerp(this._oldCamera.bottom,this._newCamera.bottom,i);d.zoom=THREE.Math.lerp(this._oldCamera.zoom,this._newCamera.zoom,i);}if(d.isPerspectiveCamera&&this._newCamera.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){d.fov=THREE.Math.lerp(this._oldCamera.fov,this._newCamera.fov,i);d.aspect=THREE.Math.lerp(this._oldCamera.aspect,this._newCamera.aspect,i);}d.far=THREE.Math.lerp(this._oldCamera.far,this._newCamera.far,i);d.near=THREE.Math.lerp(this._oldCamera.near,this._newCamera.near,i);d.updateProjectionMatrix();d.position.lerpVectors(this._oldCamera.position,this._newCamera.position,i);d.quaternion.copy(this._oldCamera.quaternion).slerp(this._newCamera.quaternion,i);d.scale.lerpVectors(this._oldCamera.scale,this._newCamera.scale,i);d.updateMatrixWorld();if(i===1){this._newCamera=null;this._oldCamera=null;if(this._animationType==="zooming"&&this._zoomedNodeRef){v.fireNodeZoomed({zoomed:this._zoomedNodeRef,isZoomIn:this._isZoomIn});}}v.setShouldRenderFrame();};this.zoomObject=function(n,i,d){var e=new THREE.Box3().setFromObject(i&&n?n:v.getScene().getSceneRef());this._zoomedNodeRef=n;this._isZoomIn=i;this._animationType="zooming";var f=v.getCamera().getCameraRef();var h=f.getWorldDirection();var j=e.getCenter();var k=h.multiplyScalar(e.getSize().length());var l=j.clone().sub(k);var m=[new THREE.Vector3(e.min.x,e.min.y,e.min.z),new THREE.Vector3(e.max.x,e.max.y,e.max.z),new THREE.Vector3(e.min.x,e.min.y,e.max.z),new THREE.Vector3(e.min.x,e.max.y,e.max.z),new THREE.Vector3(e.max.x,e.min.y,e.max.z),new THREE.Vector3(e.max.x,e.max.y,e.min.z),new THREE.Vector3(e.min.x,e.max.y,e.min.z),new THREE.Vector3(e.max.x,e.min.y,e.min.z)];var p,o;this._newCamera=f.clone();this._newCamera.position.copy(l);this._newCamera.updateMatrixWorld(true);if(f.isPerspectiveCamera){var r=false;h.copy(k);h.multiplyScalar(2.0);while(!r){r=true;for(o=0;o<m.length;o++){p=m[o].clone().project(this._newCamera);if(p.x<-1.0||p.x>1.0||p.y<-1.0||p.y>1.0){r=false;break;}}if(!r){l.sub(h);this._newCamera.position.copy(l);this._newCamera.updateMatrixWorld(true);}}var u=10;var P=l.clone();var w=j.clone();for(var x=0;x<u;x++){l.copy(P);l.add(w).multiplyScalar(0.5);this._newCamera.position.copy(l);this._newCamera.updateMatrixWorld(true);r=true;for(o=0;o<m.length;o++){p=m[o].clone().project(this._newCamera);if(p.x<-1.0||p.x>1.0||p.y<-1.0||p.y>1.0){r=false;break;}}if(x===u-1){if(!r){l.copy(P);}}if(r){P.copy(l);}else{w.copy(l);}}this._newCamera.position.copy(l);this._newCamera.updateMatrixWorld(true);}if(f.isOrthographicCamera){var y=new THREE.Box2();p=m[0].project(this._newCamera);m.forEach(function(B){p=B.project(this._newCamera);y.expandByPoint(new THREE.Vector2(p.x,p.y));}.bind(this));this._newCamera.zoom=f.zoom/(Math.max(y.getSize().x,y.getSize().y)*0.5);this._newCamera.updateProjectionMatrix();}this._startTimeForCameraAnimation=Date.now();this._timeIntervalForCameraAnimation=d!==undefined?d:500;};this.prepareForCameraUpdateAnimation=function(){this._oldCamera=v.getCamera().getCameraRef().clone();};this.startAnimatingCameraUpdate=function(d){this._newCamera=v.getCamera().getCameraRef().clone();this._timeIntervalForCameraAnimation=d!==undefined?d:500;this._startTimeForCameraAnimation=Date.now();};};this._cameraController=new T(v);}});V.prototype.destroy=function(){this._viewport=null;this._rect=null;this._evt=null;this._gesture=false;};V.prototype._getOffset=function(o){var r=o.getBoundingClientRect();var p={x:r.left+window.pageXOffset,y:r.top+window.pageYOffset};return p;};V.prototype._inside=function(e){if(this._rect===null||true){var i=this._viewport.getIdForLabel();var d=document.getElementById(i);if(!d){return false;}var o=this._getOffset(d);this._rect={x:o.x,y:o.y,w:d.offsetWidth,h:d.offsetHeight};}return(e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h);};V.prototype._onresize=function(e){this._gesture=false;this._rect=null;};V.prototype.beginGesture=function(a){if(this._inside(a)&&!this._gesture){this._gesture=true;var x=a.x-this._rect.x,y=a.y-this._rect.y;this._evt.x=x;this._evt.y=y;this._evt.d=a.d;this._evt.initd=a.d;this._evt.avgd=a.d;this._evt.avgx=0;this._evt.avgy=0;q.sap.log.debug("Loco: beginGesture: "+x+", "+y);this._cameraController.beginGesture(x,y);a.handled=true;if(document.activeElement){try{document.activeElement.blur();}catch(e){}}var d=document.getElementById(this._viewport.getIdForLabel());d.focus();}this._nomenu=false;};V.prototype.move=function(e){if(this._gesture){var x=e.x-this._rect.x,y=e.y-this._rect.y;var d=x-this._evt.x;var a=y-this._evt.y;var b=e.d-this._evt.d;this._evt.x=x;this._evt.y=y;this._evt.d=e.d;this._evt.avgx=this._evt.avgx*0.99+d*0.01;this._evt.avgy=this._evt.avgy*0.99+a*0.01;var z=1.0;if(this._evt.initd>0){z=1.0+b*(1.0/this._evt.initd);}else if(e.n===2){if(e.points[0].y>e.points[1].y){z=1.0-b*0.005;if(z<0.333){z=0.333;}}else{z=1.0+b*0.005;if(z>3){z=3;}}}if(this._evt.initd>0){var c=Math.sqrt(this._evt.avgx*this._evt.avgx+this._evt.avgy*this._evt.avgy);q.sap.log.debug("AvgDist: "+c);if((Math.abs(e.d-this._evt.avgd)/this._evt.avgd)<(c/10)){z=1.0;}}this._evt.avgd=this._evt.avgd*0.97+e.d*0.03;switch(e.n){case 1:q.sap.log.debug("Loco: Rotate: "+(d)+", "+(a));this._cameraController.rotate(d,a);break;case 2:q.sap.log.debug("Loco: Pan: "+(d)+", "+(a));if(z!=0&&z!=1.0){q.sap.log.debug("Loco: Zoom: "+(z));}this._cameraController.pan(d,a);if(d<10&&a<10&&z!=0&&z!=1.0){this._cameraController.zoom(z);}break;default:break;}this._nomenu=true;e.handled=true;}};V.prototype.endGesture=function(e){if(this._gesture){var x=e.x-this._rect.x,y=e.y-this._rect.y;q.sap.log.debug("Loco: endGesture: "+x+", "+y);this._cameraController.endGesture();this._gesture=false;e.handled=true;}};V.prototype.click=function(e){if(this._inside(e)&&e.buttons<=1){var x=e.x-this._rect.x,y=e.y-this._rect.y;q.sap.log.debug("Loco: click: "+(x)+", "+(y));if(this._viewport){this._viewport.tap(x,y,false);}e.handled=true;}};V.prototype.doubleClick=function(e){if(this._inside(e)&&e.buttons<=1){var x=e.x-this._rect.x,y=e.y-this._rect.y;q.sap.log.debug("Loco: doubleClick: "+(x)+", "+(y));if(this._viewport){this._viewport.tap(x,y,true);}e.handled=true;}};V.prototype.contextMenu=function(e){if(this._inside(e)||this._nomenu||e.buttons===5){this._nomenu=false;e.handled=true;}};V.prototype.keyEventHandler=function(e){};V.prototype.getViewport=function(){return this._viewport;};V.prototype.setView=function(a,b){this._cameraController.prepareForCameraUpdateAnimation();var c=this._viewport.getCamera().getCameraRef();if(a){c.quaternion.copy(a);c.updateMatrixWorld();c.up.setFromMatrixColumn(c.matrixWorld,1).normalize();this._cameraController.zoomObject(null,false,b);}else{c.copy(this._viewport._homeCamera?this._viewport._homeCamera:new sap.ui.vk.threejs.PerspectiveCamera().getCameraRef());var s=this._viewport.getRenderer().getSize();this._viewport.getCamera().update(s.width,s.height);this._cameraController.startAnimatingCameraUpdate(b);}return this;};V.prototype.zoomObject=function(n,i,a){this._cameraController.prepareForCameraUpdateAnimation();this._cameraController.zoomObject(n,i,a);return this;};V.prototype.animateCameraUpdate=function(){this._cameraController.animateCameraUpdate();};V.prototype.prepareForCameraUpdateAnimation=function(){this._cameraController.prepareForCameraUpdateAnimation();};V.prototype.startAnimatingCameraUpdate=function(a){this._cameraController.startAnimatingCameraUpdate(a);};return V;},true);
