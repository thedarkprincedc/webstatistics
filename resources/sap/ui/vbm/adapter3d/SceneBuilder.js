/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","./Utilities","./thirdparty/ColladaLoader"],function(q,B,U,d){"use strict";var t="sap.ui.vbm.adapter3d.SceneBuilder";var a=THREE.Math.degToRad;var l=q.sap.log;var b=THREE.Box3;var F=THREE.Face3;var M=THREE.Matrix4;var V=THREE.Vector2;var c=THREE.Vector3;var r="_sapRefCount";var f;var g;var h;var n;var i=U.toBoolean;var j=U.toFloat;var k=U.toVector3;var m=U.toColor;var o=U.toDeltaColor;var S=B.extend("sap.ui.vbm.adapter3d.SceneBuilder",{metadata:{publicMethods:["synchronize"]},constructor:function(e,p,s,u){B.call(this);this._groups=e;this._instances=p;this._resources=s;this._root=u;this._textureLoader=null;this._colladaLoader=null;this._textures=new Map();this._boxGeometryWith4SidedTexture=null;this._boxGeometryWith6SidedTexture=null;}});S.prototype.destroy=function(){this._resources=null;this._groups=null;this._instances=null;this._root=null;B.prototype.destroy.call(this);};S.prototype.synchronize=function(){var e=this;return new Promise(function(p,s){var u=new Map();var v=function(C){if(u.has(C)){u.get(C).refCount+=1;}else{u.set(C,{object3D:null,refCount:1});}};var w=new Set();var x=e._instances.filter(function(C){return C.isAdded;});var y=e._instances.filter(function(C){return C.isDeleted;});var z=e._instances.filter(function(C){return C.isUpdated;});var A=[].concat(x,z);A.filter(function(C){return C.isColladaModel&&C.model&&C.model!==C._lastModel;}).map(function(C){return C.model;}).forEach(v);A.filter(function(C){return C.texture&&C.texture!==C._lastTexture;}).map(function(C){return C.texture;}).forEach(w.add,w);e._loadTextures(w).then(function(){return e._loadModels(u);}).then(function(){y.forEach(e._destroyVisualObjectInstance.bind(e,e._root));z.forEach(e._updateVisualObjectInstance.bind(e,e._root,u));x.forEach(e._addVisualObjectInstance.bind(e,e._root,u));e._cleanupCache();p();}).catch(function(C){s(C);});});};S.prototype._loadTextures=function(e){var p=[];e.forEach(function(s){if(!this._textures.has(s)){p.push(this._loadTexture(s));}},this);return Promise.all(p);};S.prototype._loadTexture=function(e){var p=this;return new Promise(function(s,u){p._getTextureLoader().load(p._resources.get(e),function(v){v.flipY=false;v[r]=0;p._textures.set(e,v);s();},null,function(x){l.error("Failed to load texture from Data URI: "+e,"status: "+x.status+", status text: "+x.statusText,t);s();});});};S.prototype._loadModels=function(e){var p=[];e.forEach(function(s,u){p.push(this._loadModel(u,s));},this);return Promise.all(p);};S.prototype._loadModel=function(p,s){var u=this;return new Promise(function(v,w){try{u._getColladaLoader().parse(u._resources.get(p),function(x){g(x.scene);x.scene.traverse(h);x.scene.rotateX(a(180));s.object3D=x.scene;v();});}catch(e){l.error("Failed to load Collada model from resource: "+p,e instanceof Error?e.message:"",t);v();}});};S.prototype._releaseTexture=function(e){if(e.hasOwnProperty(r)){e[r]-=1;}else{e.dispose();}return this;};S.prototype._addRefTexture=function(e){if(!e.hasOwnProperty(r)){e[r]=0;}e[r]+=1;return this;};S.prototype._releaseGeometry=function(e){if(e.hasOwnProperty(r)){e[r]-=1;}else{e.dispose();}return this;};S.prototype._addRefGeometry=function(e){if(!e.hasOwnProperty(r)){e[r]=0;}e[r]+=1;return this;};S.prototype._cleanupCache=function(){this._textures.forEach(function(e){if(e[r]===0){e.dispose();this._textures.delete(e);}});if(this._boxGeometryWith4SidedTexture&&this._boxGeometryWith4SidedTexture[r]===0){this._boxGeometryWith4SidedTexture.dispose();this._boxGeometryWith4SidedTexture=null;}if(this._boxGeometryWith6SidedTexture&&this._boxGeometryWith6SidedTexture[r]===0){this._boxGeometryWith6SidedTexture.dispose();this._boxGeometryWith6SidedTexture=null;}return this;};S.prototype._destroyVisualObjectInstance=function(e,p){var s=this;if(p.object3D){p.object3D.traverse(function(u){if(u.isMesh){var v=u.material;if(v){var w=v.map;if(w){s._releaseTexture(w);v.map=null;}v.dispose();u.material=null;}var x=u.geometry;if(x){s._releaseGeometry(x);u.geometry=null;}}});e.remove(p.object3D);p.object3D=null;p._lastModel=null;p._lastTexture=null;p._lastTexture6=null;}return this;};S.prototype._updateVisualObjectInstance=function(e,p,s){if(s.isColladaModel){if(s.model!==s._lastModel){return this._destroyVisualObjectInstance(e,s)._addVisualObjectInstance(e,p,s);}this._assignColladaModelProperties(s);}else if(s.isBox){this._assignBoxProperties(s);}return this;};S.prototype._addVisualObjectInstance=function(e,p,s){if(s.isColladaModel){s.object3D=new THREE.Group();s._lastModel=s.model;var u=p.get(s.model);var v=--u.refCount===0?u.object3D:u.object3D.clone();if(i(s.normalize)){n(v);}s.object3D.add(v);this._assignMaterial(s.object3D,this._createMaterial());this._assignColladaModelProperties(s);}else if(s.isBox){s.object3D=new THREE.Group();s.object3D.add(new THREE.Mesh(undefined,this._createMaterial()));this._assignBoxProperties(s);}if(s.object3D){e.add(s.object3D);}return this;};S.prototype._assignColladaModelProperties=function(e){this._assignProperties(e);return this;};S.prototype._assignBoxProperties=function(e){if(e._lastTexture6!==e.texture6){var p=e.object3D.children[0];if(p.geometry){this._releaseGeometry(p.geometry);}p.geometry=this._getBoxGeometry(i(e.texture6));this._addRefGeometry(p.geometry);p.scale.set(1,-1,-1);if(i(e.normalize)){n(p);}p.rotateX(a(180));e._lastTexture6=e.texture6;}this._assignProperties(e);return this;};S.prototype._assignProperties=function(e){if(e._lastTexture&&e._lastTexture!==e.texture){this._removeTexture(e);}if(e.texture){this._assignTexture(e);}e._lastTexture=e.texture;var p=m(e.color);e.object3D.traverse(function(w){if(w.isMesh&&w.material){w.material.color=p.rgb;w.material.opacity=p.opacity;w.material.transparent=p.opacity<1;}});var s=k(e.scale);e.object3D.scale.set(s[0],s[1],s[2]);var u=k(e.rot);e.object3D.rotation.set(u[0],a(-u[1]),a(-u[2]));var v=k(e.pos);e.object3D.position.set(-v[0],v[1],v[2]);e.object3D.traverse(function(w){w._sapInstance=e;});return this;};S.prototype._removeTexture=function(e){if(e.object3D){var p=this;e.object3D.traverse(function(s){if(s.isMesh&&s.material&&s.material.map){p._releaseTexture(s.material.texture);s.material.map=null;}});}return this;};S.prototype._assignTexture=function(e){if(e.object3D){var p=this;var s=this._textures.get(e.texture);e.object3D.traverse(function(u){if(u.isMesh&&u.material){u.material.map=s;p._addRefTexture(s);}});}return this;};S.prototype._createMaterial=function(){return new THREE.MeshPhongMaterial();};S.prototype._assignMaterial=function(e,p){e.traverse(function(s){if(s.isMesh){s.material=p;}});return this;};S.prototype._getBoxGeometry=function(e){var p=e?"_boxGeometryWith6SidedTexture":"_boxGeometryWith4SidedTexture";return this[p]||(this[p]=f(e));};S.prototype._getTextureLoader=function(){return this._textureLoader||(this._textureLoader=new THREE.TextureLoader());};S.prototype._getColladaLoader=function(){return this._colladaLoader||(this._colladaLoader=new THREE.ColladaLoader());};g=function(e){var p=[];e.traverse(function(s){if(s.isLight||s.isCamera){p.push(s);}});p.forEach(function(s){while(s&&s!==e){var u=s.parent;if(s.children.length===0){u.remove(s);}s=u;}});return e;};h=function(e){function p(v,w,x){w=w||1;x=x||2;var y=v[w];v[w]=v[x];v[x]=y;}function s(v){v.x=-v.x;}function u(v){v.vertices.forEach(s);v.faces.forEach(function(w){p(w,"b","c");if(w.normal){s(w.normal);}if(w.vertexNormals&&w.vertexNormals.length===3){p(w.vertexNormals);s(w.vertexNormals[0]);s(w.vertexNormals[1]);s(w.vertexNormals[2]);}if(w.vertexColors&&w.vertexColors.length===3){p(w.vertexColors);}});v.faceVertexUvs.forEach(function(w){w.forEach(function(x){p(x);});});return v;}if(e.isMesh&&e.geometry&&e.geometry.isGeometry){u(e.geometry);}else if(e.isGeometry){u(e);}return e;};n=function(e){var p=new b().setFromObject(e).getCenter();e.position.add(new c(-p.x,-p.y,+p.z));var s=new b().setFromObject(e);var u=Math.max(Math.abs(s.min.x),Math.abs(s.min.y),Math.abs(s.min.z),Math.abs(s.max.x),Math.abs(s.max.y),Math.abs(s.max.z));if(u){u=1/u;}e.applyMatrix(new M().makeScale(u,u,u));s=new b().setFromObject(e);p=s.getCenter();e.translateZ(p.z-(s.max.z<0?s.max.z:s.min.z));return e;};f=function(e){var p=new THREE.Geometry();var s=0.1;p.vertices.push(new c(s,s,-s),new c(s,-s,-s),new c(-s,-s,-s),new c(-s,s,-s),new c(s,s,s),new c(-s,s,s),new c(-s,-s,s),new c(s,-s,s),new c(s,s,-s),new c(s,s,s),new c(s,-s,s),new c(s,-s,-s),new c(s,-s,-s),new c(s,-s,s),new c(-s,-s,s),new c(-s,-s,-s),new c(-s,-s,-s),new c(-s,-s,s),new c(-s,s,s),new c(-s,s,-s),new c(s,s,s),new c(s,s,-s),new c(-s,s,-s),new c(-s,s,s));var u=new THREE.Color(0.5,0.5,0.5);p.faces.push(new F(0,2,3,new c(0,0,-1),u),new F(0,1,2,new c(0,0,-1),u),new F(4,5,6,new c(0,0,1),u),new F(4,6,7,new c(0,0,1),u),new F(8,10,11,new c(1,0,0),u),new F(8,9,10,new c(1,0,0),u),new F(12,14,15,new c(0,-1,0),u),new F(12,13,14,new c(0,-1,0),u),new F(16,18,19,new c(-1,0,0),u),new F(16,17,18,new c(-1,0,0),u),new F(20,22,23,new c(0,1,0),u),new F(20,21,22,new c(0,1,0),u));var v;if(e){v=[new V(2/3,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(2/3,1.0),new V(2/3,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(2/3,0.5),new V(2/3,0.5),new V(2/3,1.0),new V(1/3,1.0),new V(1/3,0.5),new V(2/3,0.0),new V(2/3,0.5),new V(1/3,0.5),new V(1/3,0.0),new V(1/3,0.5),new V(1/3,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(1/3,0.0),new V(1/3,0.5)];}else{v=[new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.5,0.5),new V(0.5,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(0.5,0.0),new V(0.5,0.5)];}p.faceVertexUvs[0].push([v[0],v[2],v[3]],[v[0],v[1],v[2]],[v[4],v[5],v[6]],[v[4],v[6],v[7]],[v[8],v[10],v[11]],[v[8],v[9],v[10]],[v[12],v[14],v[15]],[v[12],v[13],v[14]],[v[16],v[18],v[19]],[v[16],v[17],v[18]],[v[20],v[22],v[23]],[v[20],v[21],v[22]]);h(p);return p;};return S;});
