/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","./VisualObjectFactory","./Utilities","./../library"],function(q,B,F,U,l){"use strict";var V=B.extend("sap.ui.vbm.adapter3d.VBIJSONParser",{metadata:{publicMethods:["loadVBIJSON"]},constructor:function(v,a,r,c){this._voGroups=v;this._vos=a;this._resources=r;this._actions=c;this._factory=new F();this._visualObjectTemplateGenerators={};}});V.prototype.loadVBIJSON=function(p){if(p&&p.SAPVB){if(p.SAPVB.Resources){this._processResources(p.SAPVB.Resources);}if(p.SAPVB.DataTypes){this._processDataTypes(p.SAPVB.DataTypes);}if(p.SAPVB.Scenes&&p.SAPVB.Scenes.Set&&p.SAPVB.Scenes.Set.Scene&&p.SAPVB.Scenes.Set.Scene.VO){this._processVOs([].concat(p.SAPVB.Scenes.Set.Scene.VO));}if(p.SAPVB.Actions&&p.SAPVB.Actions.Set&&p.SAPVB.Actions.Set.Action){this._processActions([].concat(p.SAPVB.Actions.Set.Action));}if(p.SAPVB.Data){this._processData(p.SAPVB.Data);}}return this;};V.prototype._processResources=function(a){if(a&&a.Set&&a.Set.Resource){var c=function(d,n){return atob(d.split(",")[0]);};var p=function(r){if(q.sap.endsWith(r.name,".dae")){this._resources.set(r.name,c(r.value,r.name));}else{this._resources.set(r.name,"data:"+r.name.split(".")[1]+";base64,"+r.value);}};[].concat(a.Set.Resource).forEach(p,this);}return this;};V.prototype._processDataTypes=function(d){if(d.Set&&d.Set&&d.Set.N){this._dataTypes=[].concat(d.Set.N);}return this;};var b=function(v,d,a,c){var i={};for(var e in v){if(!(e==="datasource"||e==="id"||e==="type")){if(q.sap.endsWith(e,".bind")){i[e.split(".")[0]]=c[a[v[e].split(".")[1]]];}else{i[e]=v[e];}}}i.id=c[a[d.key]];return i;};V.prototype._processVOs=function(v){v.forEach(function(a){var d=sap.ui.vbm.findInArray(this._dataTypes,function(e){return e.name===a.datasource;});var c={};if(d&&d.A){[].concat(d.A).forEach(function(e){c[e.name]=e.alias;});}this._voGroups.push(this._factory.createVisualObjectGroup({id:a.id,type:a.type,datasource:a.datasource,maxSel:d.maxSel,minSel:d.minSel}));this._visualObjectTemplateGenerators[a.id]=b.bind(undefined,a,d,c);},this);return this;};V.prototype._processActions=function(c){c.forEach(function(a){this._actions.push(a);},this);return this;};V.prototype._markAsNew=function(v){v.isAdded=true;v.isUpdated=false;v.isDeleted=false;return this;};V.prototype._markForChange=function(v){v.isAdded=false;v.isUpdated=true;v.isDeleted=false;return this;};V.prototype._markForDeletion=function(v){v.isAdded=false;v.isUpdated=false;v.isDeleted=true;return this;};V.prototype._processData=function(d){if(d.Set&&typeof d.Set==='object'&&!q.isEmptyObject(d.Set)){if(!Array.isArray(d.Set)&&!d.Set.name&&!d.Set.type){this._vos.forEach(function(v){this._markForDeletion(v);},this);if(d.Set&&d.Set.N){[].concat(d.Set.N).forEach(function(n){var v=sap.ui.vbm.findInArray(this._voGroups,function(g){return g.datasource===n.name;});[].concat(n.e).forEach(function(e){var a=this._visualObjectTemplateGenerators[v.id](e);var c=this._factory.createVisualObject(v,a);this._markAsNew(c);this._vos.push(c);if(U.toBoolean(c["VB:s"])){v.selected.push(c);}},this);},this);}}else{var h=!Array.isArray(d.Set)?d.Set.N:true;if(d.Set&&h){[].concat(d.Set).forEach(function(s){var v=sap.ui.vbm.findInArray(this._voGroups,function(_){return _.datasource===s.name;});[].concat(s.N.E||[]).forEach(function(e){var a=this._visualObjectTemplateGenerators[v.id](e);var c=sap.ui.vbm.findIndexInArray(this._vos,function(g){return g.id===a.id;});if(c>=0){var f=this._vos[c];q.extend(f,a);this._markForChange(f);}else{var n=this._factory.createVisualObject(v,a);this._markAsNew(n);this._vos.push(n);}},this);},this);}}}if(d.Remove){[].concat(d.Remove).forEach(function(g){if(g.N&&g.N.E){[].concat(g.N.E).forEach(function(e){var a=sap.ui.vbm.findInArray(this._vos,function(v){return v.id===e.K;});this._markForDeletion(a);},this);}},this);}return this;};return V;});
