/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Element","sap/ui/base/ManagedObjectObserver","sap/ui/vk/ContentConnector","sap/ui/vk/ContentResource","sap/ui/vk/threejs/Viewport","sap/ui/vk/threejs/ViewStateManager","./adapter3d/VisualObjectFactory","./adapter3d/VBIJSONParser","./adapter3d/SceneBuilder","./adapter3d/Utilities"],function(q,l,E,M,C,a,V,b,c,P,S,U){"use strict";var t="sap.ui.vbm.adapter3d.Adapter3D";var d=q.sap.log;var e=U.toBoolean;var f=U.applyColor;var v;var A=E.extend("sap.ui.vbm.Adapter3D",{metadata:{library:"sap.ui.vbm",publicMethods:["load"],associations:{viewport:{type:"sap.ui.vk.threejs.Viewport"}},events:{submit:{parameters:{data:{type:"string"}}}}}});var g=A.getMetadata().getParent().getClass().prototype;A.prototype.init=function(){if(g.init){g.init.call(this);}var i=this;this._contentConnector=new C();this.addDependent(this._contentConnector);this._sceneRootPromise=new Promise(function(r){i._contentConnector.attachEventOnce("contentReplaced",function(j){var k=i._contentConnector.getContentResources()[0].getNodeProxy().getNodeRef();k.rotateX(THREE.Math.degToRad(90));r(k);});});this._contentConnector.addContentResource(new a({name:"Root"}));this._viewStateManager=new b({contentConnector:this._contentConnector});this.addDependent(this._viewStateManager);this._viewport=null;this._resources=new Map();this._actions=[];this._groups=[];this._instances=[];this._parser=null;this._sceneBuilder=null;this._lastHoverInstance=null;this._clickTimerId=null;this._mouseDown=false;this._lastXY={x:0,y:0};this._viewportObserver=new M(this._observeChanges.bind(this));};A.prototype.exit=function(){if(this._clickTimerId){q.sap.clearDelayedCall(this._clickTimerId);this._clickTimerId=null;}this._disconnectViewport();this._viewportObserver.disconnect();this._viewportObserver=null;if(this._sceneBuilder){this._sceneBuilder.destroy();this._sceneBuilder=null;}if(this._parser){this._parser.destroy();this._parser=null;}this._contentConnector=null;this._viewStateManager=null;this._resources=null;this._actions=null;this._groups=null;this._instances=null;if(g.exit){g.exit.call(this);}};A.prototype._getSceneRoot=function(){return this._sceneRootPromise;};A.prototype.setViewport=function(i){this.setAssociation("viewport",i,true);this._configureViewport();return this;};A.prototype._configureViewport=function(){var i=sap.ui.getCore().byId(this.getViewport())||null;if(i!==this._viewport){this._disconnectViewport();this._viewport=i;this._connectViewport();}return this;};A.prototype._connectViewport=function(){if(this._viewport){this._viewportObserver.observe(this._viewport,{destroy:true});this._viewport.setContentConnector(this._contentConnector);this._viewport.setViewStateManager(this._viewStateManager);this._viewport.setSelectionMode(sap.ui.vk.SelectionMode.None);this._viewport.addEventDelegate(v,this);if(this._viewport._viewportGestureHandler&&this._viewport._viewportGestureHandler.zoomObject){this._viewport._viewportGestureHandler.zoomObject=function(){};}}return this;};A.prototype._disconnectViewport=function(){if(this._viewport){this._viewport.removeEventDelegate(v);this._viewportObserver.unobserve(this._viewport,{destroy:true});if(!this._viewport.bIsDestroyed){this._viewport.setViewStateManager(null);this._viewport.setContentConnector(null);}this._viewport=null;}return this;};A.prototype._observeChanges=function(i){if(i.type==='destroy'&&i.object===this._viewport){this._disconnectViewport();}};A.prototype.load=function(j){var k=this;return this._getSceneRoot().then(function(r){if(!k._parser){k._parser=new P(k._groups,k._instances,k._resources,k._actions);}if(!k._sceneBuilder){k._sceneBuilder=new S(k._groups,k._instances,k._resources,r);}k._configureViewport();var p=null;if(typeof j==="string"){try{p=JSON.parse(j);}catch(m){d.error("sap.ui.vbm.Adapter: attempt to load invalid JSON string.");return Promise.resolve();}}else if(typeof j==="object"){p=j;}if(!(p&&p.SAPVB)){d.error("sap.ui.vbm.Adapter3D: attempt to load null.");return Promise.resolve();}k._parser.loadVBIJSON(p);k._sceneBuilder.synchronize().then(function(){for(var i=k._instances.length-1;i>=0;--i){var n=k._instances[i];if(n.isDeleted){k._deleteInstance(i);}else{n.isAdded=n.isUpdated=false;}}k._viewport.setShouldRenderFrame();k._processAutomation(p);return Promise.resolve();});});};A.prototype._deleteInstance=function(i){var j=this._instances[i];this._instances.splice(i,1);var k=j.voGroup.voInstances;k.splice(k.indexOf(j),1);var m=j.voGroup.selected;var s=m.indexOf(j);if(s>=0){m.splice(s,1);}if(j===this._lastHoverInstance){this._lastHoverInstance=null;}return this;};A.prototype._processAutomation=function(i){var j=this;var k=function(m,p,u,w){var z=new sap.ui.unified.MenuItem({text:p.text,enabled:p.disabled==="X"?false:true,select:j._menuItemSelectionHandler.bind(j,p.id,u.instance,w,u.object)});if(p.MenuItem){var B=new sap.ui.unified.Menu();[].concat(p.MenuItem).forEach(function(D){k(B,D,u,w);});z.setSubmenu(B);}m.addItem(z);};if(i&&i.SAPVB&&i.SAPVB.Automation&&i.SAPVB.Automation.Call&&i.SAPVB.Automation.Call){if(i.SAPVB.Automation.Call.handler&&i.SAPVB.Automation.Call.handler==="CONTEXTMENUHANDLER"){var x=[].concat(i.SAPVB.Automation.Call.Param).filter(function(p){return p.name==="x";});var y=[].concat(i.SAPVB.Automation.Call.Param).filter(function(p){return p.name==="y";});var o=undefined;if(x.length>0&&y.length>0){o=x[0]["#"]+" "+y[0]["#"];}if(i.SAPVB&&i.SAPVB.Menus&&i.SAPVB.Menus.Set){var n=[].concat(i.SAPVB.Menus.Set).filter(function(m){return m.Menu.id===i.SAPVB.Automation.Call.refID;});if(n.length>0){var r=new sap.ui.unified.Menu();[].concat(n[0].Menu.MenuItem).forEach(function(m){k(r,m,i.SAPVB.Automation.Call,n[0].Menu.action);});var s=sap.ui.core.Popup.Dock;r.open(false,this._viewport,s.BeginTop,s.BeginTop,this._viewport,o);}}}}return this;};C.addContentManagerResolver(function(i){return Promise.resolve({dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager",settings:{loader:function(p,i){return Promise.resolve({node:p,contentResource:i});}}});});A.prototype._menuItemSelectionHandler=function(i,j,n,k){var p={version:"2.0","xmlns:VB":"VB",Action:{id:i,instance:j,name:n,object:k}};this.fireSubmit({data:JSON.stringify(p)});};A.prototype._genericEventHandler=function(n,i){var j=i.instance;var k=j?j.voGroup.id:i.voGroupId;var m=sap.ui.vbm.findInArray(this._actions,function(r){return r.refVO===k&&r.refEvent===n;});if(m){var p={version:"2.0","xmlns:VB":"VB",Action:{id:m.id,name:m.name,object:m.refVO,instance:j?j.voGroup.datasource+"."+j.id:"",Params:{Param:[{name:"x","#":i.cursor.x},{name:"y","#":i.cursor.y}]}}};if(m.AddActionProperty){var o=[];[].concat(m.AddActionProperty).forEach(function(r){if(j&&j.hasOwnProperty(r.name)){o.push({name:r.name,"#":j[r.name]});}});if(o.length>0){p.Action.AddActionProperties={AddActionProperty:o};}}if(j&&n==="Click"&&i.selectionChanges){p.Data={Merge:{N:[{name:j.voGroup.datasource,E:i.selectionChanges.selected.map(function(j){return{K:j.id,"VB:s":"true"}}).concat(i.selectionChanges.deselected.map(function(j){return{K:j.id,"VB:s":"false"}}))}]}};}this.fireSubmit({data:JSON.stringify(p)});}};A.prototype._propagateClick=function(i){this._genericEventHandler("Click",i);};A.prototype._propagateDoubleClick=function(i){this._genericEventHandler("DoubleClick",i);};A.prototype._propagateContextMenu=function(i){this._genericEventHandler("ContextMenu",i);};A.prototype._propagateKeyPress=function(i){this._genericEventHandler("KeyPress",i);};A.prototype._handleClick=function(i){var j=i.instance;d.info("click","x: "+i.cursor.x+", y: "+i.cursor.y+", instance: "+(j?j.id:"")+", tooltip: "+(j?j.tooltip:""),t);this._extendEventWithSelection(i);if(i.selectionChanges){this._applySelectionChangesToScene3D(i.selectionChanges.selected,i.selectionChanges.deselected);}this._propagateClick(i);};A.prototype._handleDoubleClick=function(i){var j=i.instance;d.info("double click","x: "+i.cursor.x+", y: "+i.cursor.y+", instance: "+(j?j.id:"")+", tooltip: "+(j?j.tooltip:""),t);this._propagateDoubleClick(i);};A.prototype._handleContextMenu=function(i){var j=i.instance;if(!j){i.voGroupId="Scene";}d.info("context menu","x: "+i.cursor.x+", y: "+i.cursor.y+", instance: "+(j?j.id:"")+", tooltip: "+(j?j.tooltip:""),t);this._propagateContextMenu(i);};A.prototype._handleHover=function(i){var j;var k=i.instance;d.info("hover","x: "+i.cursor.x+", y: "+i.cursor.y+", instance: "+(k?k.id:"")+", tooltip: "+(k?k.tooltip:""),t);if(k){j=k.tooltip;if(!j){j=k.text;}}var m=this._viewport.getDomRef();if(m){if(j){m.setAttribute("title",j);}else{m.removeAttribute("title");}}this._applyHoverChangesToScene3D(k);};A.prototype._handleKeyPress=function(i){d.info("keypress",i.key,t);this._propagateKeyPress(i);};A.prototype._getXY=function(i){var r=this._viewport.getDomRef().getBoundingClientRect();return{x:(i.pageX||i.originalEvent.pageX)-window.pageXOffset-r.left,y:(i.pageY||i.originalEvent.pageY)-window.pageYOffset-r.top};};A.prototype._hitTest=function(i){var s=this._viewport.getScene().getSceneRef();var j=this._viewport.getCamera().getCameraRef();var p=i.cursor||this._getXY(i);var k=this._viewport.hitTest(p.x,p.y,s,j);return k&&k.object&&k.object._sapInstance;};A.prototype._extendEventWithInstanceAndCursor=function(i){i.cursor=this._getXY(i);i.instance=this._hitTest(i);return this;};v={onkeydown:function(i){if(!i.originalEvent.repeat){this._handleKeyPress(i);}},oncontextmenu:function(i){this._extendEventWithInstanceAndCursor(i);this._handleContextMenu(i);},onmousedown:function(i){this._mouseDown=true;this._extendEventWithInstanceAndCursor(i);d.info("mousedown","x: "+i.cursor.x+", y: "+i.cursor.y,t);this._lastXY.x=i.cursor.x;this._lastXY.y=i.cursor.y;},onmouseup:function(i){this._mouseDown=false;},onhover:function(i){this._extendEventWithInstanceAndCursor(i);d.info("hover","x: "+i.cursor.x+", y: "+i.cursor.y,t);if(this._mouseDown){if(this._lastXY.x!==i.cursor.x||this._lastXY.y!==i.cursor.y){this._skipClick=true;}return;}this._handleHover(i);},onmouseout:function(i){this._extendEventWithInstanceAndCursor(i);delete i.instance;this._handleHover(i);},onBeforeRendering:function(i){if(this._onhoverProxy){this._viewport.$().off(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge?"pointermove":"mousemove",this._onhoverProxy);}if(this._onpointerdownProxy){this._viewport.$().off("pointerdown",this._onpointerdownProxy);}if(this._onpointeronProxy){this._viewport.$().off("pointerup",this._onpointerupProxy);}},onAfterRendering:function(i){if(!this._onhoverProxy){this._onhoverProxy=v.onhover.bind(this);}this._viewport.$().on(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge?"pointermove":"mousemove",this._onhoverProxy);if(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge){if(!this._onpointerdownProxy){this._onpointerdownProxy=v.onmousedown.bind(this);}this._viewport.$().on("pointerdown",this._onpointerdownProxy);if(!this._onpointerupProxy){this._onpointerupProxy=v.onmouseup.bind(this);}this._viewport.$().on("pointerup",this._onpointerupProxy);}}};v[sap.ui.Device.browser.msie||sap.ui.Device.browser.edge?"onclick":"ontap"]=function(i){d.info("onclick","",t);this._extendEventWithInstanceAndCursor(i);if(this._skipClick){this._skipClick=false;this._handleHover(i);return;}if(this._clickTimerId){q.sap.clearDelayedCall(this._clickTimerId);this._clickTimerId=null;this._handleDoubleClick(i);}else{this._clickTimerId=q.sap.delayedCall(200,this,function(){this._clickTimerId=null;this._handleClick(i);});}};var h=sap.ui.Device.os.macintosh?"metaKey":"ctrlKey";A.prototype._extendEventWithSelection=function(i){var j=i.instance;if(j){if(i.originalEvent.type==="click"){if(!(i[h]&&i.shiftKey)){var k;var m;if(i[h]){k="toggle";m=false;}else if(i.shiftKey){k="select";m=false;}else{k="select";m=true;}i.selectionChanges=this._changeSelection(j,k,m);}}else{i.selectionChanges=this._changeSelection(j,"toggle",false);}}return this;};A.prototype._changeSelection=function(i,j,k){var s=[];var m=[];var n=i.voGroup;var w=e(i["VB:s"]);var o;if(j==="select"){if(n.maxSel!=="0"){if(w){if(k){o=n.selected.indexOf(i);m=n.selected.splice(o+1).concat(n.selected.splice(0,o));}}else{if(k||n.maxSel==="1"){m=n.selected.splice(0);}n.selected.push(i);s=[i];}}}else if(j==="toggle"){if(w){if(n.minSel==="0"||n.selected.length>1){o=n.selected.indexOf(i);m=n.selected.splice(o,1);}}else if(n.maxSel!=="0"){if(n.maxSel==="1"){m=n.selected.splice(0);}n.selected.push(i);s=[i];}}s.forEach(function(i){i["VB:s"]="true";});m.forEach(function(i){i["VB:s"]="false";});return{selected:s,deselected:m};};A.prototype._applySelectionChangesToScene3D=function(s,i){i.forEach(function(j){f(j,j.color);});s.forEach(function(j){f(j,j.selectColor);});this._viewport.setShouldRenderFrame();return this;};A.prototype._applyHoverChangesToScene3D=function(i){if(this._lastHoverInstance!==i){if(this._lastHoverInstance){f(this._lastHoverInstance,this._lastHoverInstance[e(this._lastHoverInstance["VB:s"])?"selectColor":"color"]);}this._lastHoverInstance=i;if(this._lastHoverInstance){f(this._lastHoverInstance,this._lastHoverInstance.hotDeltaColor);}}this._viewport.setShouldRenderFrame();return this;};return A;});
