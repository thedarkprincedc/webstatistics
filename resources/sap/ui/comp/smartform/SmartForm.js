/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2017 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/m/MessageBox','sap/ui/core/Control','sap/ui/layout/form/Form','sap/ui/layout/form/ResponsiveLayout','sap/ui/layout/form/ResponsiveGridLayout','sap/m/Title','sap/m/Button','sap/m/ButtonType','sap/m/Panel','sap/m/OverflowToolbar','sap/m/ToolbarSpacer','sap/m/ToolbarSeparator'],function(q,l,M,C,F,R,a,T,B,b,P,O,c,d){"use strict";var S=C.extend("sap.ui.comp.smartform.SmartForm",{metadata:{library:"sap.ui.comp",designTime:true,properties:{title:{type:"string",group:"Misc",defaultValue:null},useHorizontalLayout:{type:"boolean",group:"Misc",defaultValue:null},horizontalLayoutGroupElementMinWidth:{type:"int",group:"Misc",defaultValue:null},checkButton:{type:"boolean",group:"Misc",defaultValue:false},entityType:{type:"string",group:"Misc",defaultValue:null},expandable:{type:"boolean",group:"Misc",defaultValue:false},expanded:{type:"boolean",group:"Misc",defaultValue:null},editTogglable:{type:"boolean",group:"Misc",defaultValue:false},editable:{type:"boolean",group:"Misc",defaultValue:false},ignoredFields:{type:"string",group:"Misc",defaultValue:null},flexEnabled:{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"groups",aggregations:{groups:{type:"sap.ui.comp.smartform.Group",multiple:true,singularName:"group"},content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},layout:{type:"sap.ui.comp.smartform.Layout",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false},customToolbar:{type:"sap.m.Toolbar",multiple:false},toolbar:{type:"sap.m.Toolbar",multiple:false,visibility:"hidden"}},events:{editToggled:{parameters:{editable:{type:"boolean"}}},checked:{parameters:{erroneousFields:{type:"sap.ui.comp.smartfield.SmartField[]"}}}}},renderer:function(i,j){i.write("<div");i.writeControlData(j);i.addClass("sapUiCompSmartForm");i.writeClasses();i.write(">");var k=j.getAggregation("content");i.renderControl(k);i.write("</div>");}});S.prototype.init=function(){var i=y.call(this);this._oForm=new F(this.getId()+"--Form",{layout:i});this._oForm.getToolbar=function(){var j=this.getParent();if(j&&!j.getExpandable()){return j._getToolbar();}};this.setAggregation("content",this._oForm);this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");};S.prototype.onBeforeRendering=function(){z.call(this);};S.prototype.addGroup=function(i){if(!i){return this;}i=this.validateAggregation("groups",i,true);f.call(this,i);this._delegateEditMode(i);this._oForm.addFormContainer(i);_.call(this,i);return this;};S.prototype.getGroups=function(){return this._oForm.getFormContainers();};S.prototype.indexOfGroup=function(i){return this._oForm.indexOfFormContainer(i);};S.prototype.insertGroup=function(i,I){if(!i){return this;}i=this.validateAggregation("groups",i,true);f.call(this,i);this._delegateEditMode(i);this._oForm.insertFormContainer(i,I);_.call(this,i);return this;};S.prototype.removeGroup=function(i){var j=this._oForm.removeFormContainer(i);if(j){j.detachEvent("_visibleChanged",D,this);h.call(this,j);D.call(this);}return j;};S.prototype.removeAllGroups=function(){var j=this._oForm.removeAllFormContainers();for(var i=0;i<j.length;i++){j[i].detachEvent("_visibleChanged",D,this);h.call(this,j[i]);}D.call(this);return j;};S.prototype.destroyGroups=function(){var j=this.getGroups();for(var i=0;i<j.length;i++){j[i].detachEvent("_visibleChanged",D,this);}this._oForm.destroyFormContainers();D.call(this);return this;};function _(i){var U=this.getUseHorizontalLayout();var H=this.getHorizontalLayoutGroupElementMinWidth();i.attachEvent("_visibleChanged",D,this);if(H!=i.getHorizontalLayoutGroupElementMinWidth){i.setHorizontalLayoutGroupElementMinWidth(H);}if(U!=i.getUseHorizontalLayout()){i.setUseHorizontalLayout(U);}if(U){i._updateGridDataSpan();i._updateLineBreaks();}else{D.call(this);}}S.prototype._getToolbar=function(){var i=this.getCustomToolbar();return i||this.getAggregation("toolbar");};S.prototype.propagateGridDataSpan=function(){var j=this.getGroups();for(var i=0;i<j.length;i++){var k=j[i];k._updateGridDataSpan();k._updateLineBreaks();}return this;};S.prototype._getGridDataSpanNumbers=function(){var L=this.getLayout();var i;if(L&&L._getGridDataSpanNumbers){i=L._getGridDataSpanNumbers();}return i;};S.prototype._toggleEditMode=function(){var i=this.getEditable();this.setEditable(!i);};S.prototype.check=function(i){if(i===undefined){i=true;}var j=this._checkClientError(i);return j;};S.prototype._checkClientError=function(i){if(i===undefined){i=true;}var j=this.getSmartFields(i,i);var k=[];var H=null;j.forEach(function(I){if(I.checkClientError()){if(i&&I.getVisible){if(!I.getVisible()){return;}}H=I.getParent();while(H.getParent){H=H.getParent();if(H instanceof sap.ui.comp.smartform.Group){if(!H.getExpanded()){H.setExpanded(true);}break;}}k.push(I.getId());}});return k;};S.prototype._displayError=function(i){var j=this._oRb.getText("FORM_CLIENT_CHECK_ERROR_TITLE");var k=this._oRb.getText("FORM_CLIENT_CHECK_ERROR");M.show(k,{icon:M.Icon.ERROR,title:j,styleClass:(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":""});};S.prototype.setEditable=function(i){var j=this.getEditable();if(j===i){return this;}if(!i&&this.hasListeners("editToggled")){var k=this.check(true);if(k&&k.length>0){this._displayError(k);return this;}}this.setProperty("editable",i);if(this._oForm){this._oForm.setEditable(i);}this.fireEditToggled({editable:i});if(this._oEditToggleButton){this._oEditToggleButton.setIcon(i?"sap-icon://display":"sap-icon://edit");var H=this._oRb.getText(i?"FORM_TOOLTIP_DISPLAY":"FORM_TOOLTIP_EDIT");this._oEditToggleButton.setTooltip(H);}var I=this.getGroups();I.forEach(function(J){J.setEditMode(i);});if(this.getCheckButton()&&i){t.call(this);}else{u.call(this);}return this;};S.prototype.setEditTogglable=function(i){this.setProperty("editTogglable",i,true);if(i){r.call(this);}else{s.call(this);}return this;};S.prototype.setTitle=function(i){this.setProperty("title",i,true);if(i){if(!this._oTitle){this._oTitle=new T(this.getId()+"-title-sfmain").addStyleClass("title");}this._oTitle.setText(i);this._oForm.addAriaLabelledBy(this._oTitle);o.call(this);}else if(this._oTitle){p.call(this);this._oForm.removeAriaLabelledBy(this._oTitle);this._oTitle.destroy();this._oTitle=null;}return this;};S.prototype.setCheckButton=function(i){this.setProperty("checkButton",i,true);if(i){t.call(this);}else{u.call(this);}return this;};S.prototype.setUseHorizontalLayout=function(U){var i=this.getUseHorizontalLayout();this.setProperty("useHorizontalLayout",U);if(i!==U){if(U){this.addStyleClass("sapUiCompSmartFormHorizontalLayout");}else{this.removeStyleClass("sapUiCompSmartFormHorizontalLayout");}var j=this.getGroups();if(j){j.forEach(function(k){if(k.getUseHorizontalLayout()!=U){k.setUseHorizontalLayout(U);}});}var L=this.getLayout();if(U){A.call(this,L);}else{z.call(this);A.call(this,L);}}return this;};S.prototype.setLayout=function(L){var i=this.getLayout();if(i==L){return this;}if(i){i.detachEvent("_change",G,this);}this.setAggregation("layout",L);if(L){L.attachEvent("_change",G,this);}this.propagateGridDataSpan();z.call(this);A.call(this,L);return this;};S.prototype.destroyLayout=function(){var i=this.getLayout();if(!i){return this;}this.destroyAggregation("layout");this.propagateGridDataSpan();z.call(this);A.call(this,null);return this;};S.prototype.setHorizontalLayoutGroupElementMinWidth=function(i){var j=this.getHorizontalLayoutGroupElementMinWidth();if(j==i){return this;}q.sap.log.error("HorizontalLayoutGroupElementMinWidth is deprecated",this);this.setProperty("horizontalLayoutGroupElementMinWidth",i);var k=this.getGroups();if(k){k.forEach(function(H){H.setHorizontalLayoutGroupElementMinWidth(i);});}return this;};S.prototype.getVisibleProperties=function(){var i=[];var j=this.getGroups();if(j){j.forEach(function(k){var H=k.getGroupElements();if(H.length>0){H.forEach(function(I){var J=I.getElements();if(J.length>0){J.forEach(function(K){if(K.getVisible()){var L=K.getBindingPath("value");if(L){i.push(L);}}});}});}});}return i;};S.prototype.setCustomToolbar=function(i){var j=this.getCustomToolbar();if(j==i){return this;}p.call(this);s.call(this);u.call(this);this.setAggregation("customToolbar",i);if(this.getTitle()){o.call(this);}if(this.getEditTogglable()){r.call(this);}if(this.getCheckButton()){t.call(this);}return this;};S.prototype.destroyCustomToolbar=function(){var i=this.getCustomToolbar();if(i){p.call(this);s.call(this);u.call(this);}this.destroyAggregation("customToolbar");if(this.getTitle()){o.call(this);}if(this.getEditTogglable()){r.call(this);}if(this.getCheckButton()){t.call(this);}return this;};S.prototype.setExpandable=function(i){this.setProperty("expandable",i);if(i){if(!this._oPanel){this._oPanel=new P(this.getId()+"--Panel",{expanded:this.getExpanded(),expandable:true,headerText:this.getTitle(),expandAnimation:false});this._oPanel.getHeaderToolbar=function(){var j=this.getParent();if(j){return j._getToolbar();}};this._oPanel.attachExpand(e,this);}this.setAggregation("content",this._oPanel);this._oPanel.addContent(this._oForm);}else if(this._oPanel){this.setAggregation("content",this._oForm);this._oPanel.destroy();this._oPanel=null;}return this;};function e(i){this.setProperty("expanded",i.getParameter("expand"),true);}S.prototype.setExpanded=function(i){this.setProperty("expanded",i);if(this._oPanel){this._oPanel.setExpanded(i);}return this;};S.prototype.addCustomData=function(j){if(!j){return this;}C.prototype.addCustomData.apply(this,arguments);var k=this.getGroups();for(var i=0;i<k.length;i++){g.call(this,k[i],j);}return this;};S.prototype.insertCustomData=function(j,I){if(!j){return this;}C.prototype.insertCustomData.apply(this,arguments);var k=this.getGroups();for(var i=0;i<k.length;i++){g.call(this,k[i],j);}return this;};S.prototype.removeCustomData=function(j){var k=C.prototype.removeCustomData.apply(this,arguments);if(k){var H=this.getGroups();for(var i=0;i<H.length;i++){h.call(this,H[i],k.getId());}}return k;};S.prototype.removeAllCustomData=function(){var j=C.prototype.removeAllCustomData.apply(this,arguments);if(j.length>0){var k=this.getGroups();for(var i=0;i<k.length;i++){h.call(this,k[i]);}}return j;};S.prototype.destroyCustomData=function(){C.prototype.destroyCustomData.apply(this,arguments);var j=this.getGroups();for(var i=0;i<j.length;i++){h.call(this,j[i]);}return this;};function f(j){var k=this.getCustomData();for(var i=0;i<k.length;i++){g.call(this,j,k[i]);}}function g(i,j){if(sap.ui.comp.smartform.inheritCostomDataToFields(j)){var N=j.clone();N._bFromSmartForm=true;N._sOriginalId=j.getId();i.addCustomData(N);}}function h(j,k){var H=j.getCustomData();for(var i=0;i<H.length;i++){var I=H[i];if(I._bFromSmartForm&&(!k||k==I._sOriginalId)){j.removeCustomData(I);}}}S.prototype._delegateEditMode=function(i){if(i){i.setEditMode(this.getEditable());}};S.prototype.getSmartFields=function(H,I){var J=[];var K=[];var L=[];var N=[];if(H===undefined){H=true;}J=this.getGroups();for(var i=0;i<J.length;i++){var Q=J[i];if(!H||(H&&Q.isVisible())){K=Q.getGroupElements();for(var j=0;j<K.length;j++){var U=K[j];if(!I||(I&&U.isVisible())){L=U.getElements();for(var k=0;k<L.length;k++){var V=L[k];if(V instanceof sap.ui.comp.smartfield.SmartField){N.push(V);}}}}}}return N;};S.prototype.setFocusOnEditableControl=function(){var i=[];this.getGroups().forEach(function(j){if(j.isVisible()){j.getGroupElements().forEach(function(k){if(k.isVisible()){i=i.concat(k.getElements());}});}});i.some(function(j){if(j.getEditable&&j.getEditable()&&j.focus&&j.getVisible()){if(j instanceof sap.ui.comp.smartfield.SmartField){j.attachEventOnce("innerControlsCreated",function(k){q.sap.delayedCall(0,k.oSource._oControl[k.oSource._oControl.current],"focus");});}else{j.focus();}return true;}});};S.prototype.clone=function(I,L){this.setAggregation("content",null);var j=this.getLayout();var k=this.getAggregation("toolbar");var H=this.getCustomToolbar();var J=this.getCustomData();var K=this.getGroups();var i=0;if(j){j.detachEvent("_change",G,this);}if(H){p.call(this);s.call(this);u.call(this);}else if(k){this.setAggregation("toolbar",null);}if(J.length>0){for(i=0;i<K.length;i++){h.call(this,K[i]);}}var N=C.prototype.clone.apply(this,arguments);for(i=0;i<K.length;i++){var Q=K[i].clone(I,L);N.addGroup(Q);}if(this.getExpandable()){this.setAggregation("content",this._oPanel);}else{this.setAggregation("content",this._oForm);}if(j){j.attachEvent("_change",G,this);}if(H){if(this.getTitle()){o.call(this);}if(this.getEditTogglable()){r.call(this);}if(this.getCheckButton()){t.call(this);}}else if(k){this.setAggregation("toolbar",k);}if(J.length>0){for(i=0;i<K.length;i++){f.call(this,K[i]);}}return N;};S.prototype.exit=function(){if(this._oForm){this._oForm.destroy();}if(this._oPanel){this._oPanel.destroy();}if(this._oTitle){this._oTitle.destroy();}if(this._oEditToggleButton){this._oEditToggleButton.destroy();}this._oForm=null;this._oPanel=null;this._oTitle=null;this._oRb=null;this._oEditToggleButton=null;};function m(){var i=this.getAggregation("toolbar");if(!i){i=new O(this.getId()+"-toolbar-sfmain",{"height":"3rem","design":sap.m.ToolbarDesign.Transparent});i._bCreatedBySmartForm=true;this.setAggregation("toolbar",i);}return i;}function n(i){var j=this.getAggregation("toolbar");if(j){if(i){var k=j.getContent();if(k.length>0){return;}}this.destroyAggregation("toolbar");}}function o(){if(!this._oTitle){return;}var i=this._getToolbar();if(!i){i=m.call(this);}i.insertContent(this._oTitle,0);}function p(){if(!this._oTitle){return;}var i=this._getToolbar();i.removeContent(this._oTitle);n.call(this,true);}function r(){if(!this.getEditTogglable()){return;}var i=this._getToolbar();if(!i){i=m.call(this);}if(!this._oCheckButton){w.call(this,i);}if(!this._oEditToggleButton){var I=this.getEditable()?"sap-icon://display":"sap-icon://edit";var j=this._oRb.getText(this.getEditable()?"FORM_TOOLTIP_DISPLAY":"FORM_TOOLTIP_EDIT");this._oEditToggleButton=new B(i.getId()+"-button-sfmain-editToggle",{type:b.Default,icon:I,tooltip:j});this._oEditToggleButton.attachPress(this._toggleEditMode,this);}var k=i.getContent().length;if(this._oCheckButton){k--;}i.insertContent(this._oEditToggleButton,k);}function s(){if(!this._oEditToggleButton){return;}var i=this._getToolbar();i.removeContent(this._oEditToggleButton);this._oEditToggleButton.destroy();this._oEditToggleButton=null;x.call(this,i);n.call(this,true);}function t(){if(!this.getCheckButton()||!this.getEditable()){return;}var i=this._getToolbar();if(!i){i=m.call(this);}if(!this._oEditToggleButton){w.call(this,i);}if(!this._oCheckButton){this._oCheckButton=new B(this.getId()+"-"+i.getId()+"-button-sfmain-check",{type:b.Default,text:this._oRb.getText("SMART_FORM_CHECK")});this._oCheckButton.attachPress(v,this);}var I=i.getContent().length;i.insertContent(this._oCheckButton,I);}function u(){if(!this._oCheckButton){return;}var i=this._getToolbar();i.removeContent(this._oCheckButton);this._oCheckButton.destroy();this._oCheckButton=null;x.call(this,i);n.call(this,true);}function v(i){var j=[];j=this.check();this.fireChecked({erroneousFields:j});}function w(j){var k;if(!j._bCreatedBySmartForm){var H=j.getContent();var I=false;for(var i=0;i<H.length;i++){if(H[i]instanceof c){I=true;break;}}if(!I){k=new c();k._bCreatedBySmartForm=true;j.addContent(k);}if(!(H[H.length-1]instanceof d)){var J=new d();J._bCreatedBySmartForm=true;j.addContent(J);}}else{k=new c();k._bCreatedBySmartForm=true;j.addContent(k);}}function x(i){var j=i.getContent();var L;if(!i._bCreatedBySmartForm){L=j[j.length-1];if(L instanceof d&&L._bCreatedBySmartForm){L.destroy();}j=i.getContent();}L=j[j.length-1];if(L instanceof c&&L._bCreatedBySmartForm){L.destroy();}}function y(){this._oFormLayoutNotInitial=true;var i=new a();E.call(this,i);return i;}function z(){var L=this.getLayout();var j=this._oForm.getLayout();var k=false;if(this.getUseHorizontalLayout()&&(!L||!L.getGridDataSpan())){if(!(j instanceof sap.ui.layout.form.ResponsiveLayout)){j.destroy();j=new sap.ui.layout.form.ResponsiveLayout();this._oForm.setLayout(j);k=true;}}else if(!(j instanceof sap.ui.layout.form.ResponsiveGridLayout)){j.destroy();j=y.call(this);this._oForm.setLayout(j);A.call(this,L);k=true;}if(k){var H=this.getGroups();for(var i=0;i<H.length;i++){var I=H[i];I._updateLayoutData();}}}function A(L){var i=this._oForm.getLayout();if(!(i instanceof sap.ui.layout.form.ResponsiveGridLayout)){return;}if(this.getUseHorizontalLayout()){if(L&&L.getGridDataSpan()){E.call(this,i);i.setColumnsL(1);i.setColumnsM(1);if(L.getBreakpointM()>0){i.setBreakpointM(L.getBreakpointM());}if(L.getBreakpointL()>0){i.setBreakpointL(L.getBreakpointL());}if(L.getBreakpointXL()>0){i.setBreakpointXL(L.getBreakpointXL());}this._oFormLayoutNotInitial=true;}}else{if(L){i.setLabelSpanXL(L.getLabelSpanXL()?L.getLabelSpanXL():-1);i.setLabelSpanL(L.getLabelSpanL()?L.getLabelSpanL():4);i.setLabelSpanM(L.getLabelSpanM()?L.getLabelSpanM():4);i.setLabelSpanS(L.getLabelSpanS()?L.getLabelSpanS():12);i.setEmptySpanXL(L.getEmptySpanXL()?L.getEmptySpanXL():-1);i.setEmptySpanL(L.getEmptySpanL()?L.getEmptySpanL():0);i.setEmptySpanM(L.getEmptySpanM()?L.getEmptySpanM():0);i.setColumnsXL(L.getColumnsXL()?L.getColumnsXL():-1);i.setColumnsL(L.getColumnsL()?L.getColumnsL():3);i.setColumnsM(L.getColumnsM()?L.getColumnsM():2);i.setSingleContainerFullSize(L.getSingleGroupFullSize());i.setBreakpointXL(L.getBreakpointXL()?L.getBreakpointXL():1440);i.setBreakpointL(L.getBreakpointL()?L.getBreakpointL():1024);i.setBreakpointM(L.getBreakpointM()?L.getBreakpointM():600);this._oFormLayoutNotInitial=true;}else{E.call(this,i);}D.call(this,L,i);}}function D(L,j){if(this.getUseHorizontalLayout()){return;}if(!j){j=this._oForm.getLayout();L=this.getLayout();}var k=this.getGroups();var H=-1;var I=3;var J=true;var V=0;for(var i=0;i<k.length;i++){if(k[i].isVisible()){V++;}}if(L){I=L.getColumnsL()?L.getColumnsL():3;H=(L.getColumnsXL()>0)?L.getColumnsXL():-1;J=L.getSingleGroupFullSize();}if(k&&V>0&&V<H&&J){j.setColumnsXL(V);}else if(j.getColumnsXL()!=H){j.setColumnsXL(H);}if(k&&V>0&&V<I&&J){j.setColumnsL(V);}else if(j.getColumnsL()!=I){j.setColumnsL(I);}}function E(i){if(this._oFormLayoutNotInitial){i.setLabelSpanXL(-1);i.setLabelSpanL(4);i.setLabelSpanM(4);i.setLabelSpanS(12);i.setEmptySpanXL(-1);i.setEmptySpanL(0);i.setEmptySpanM(0);i.setColumnsXL(-1);i.setColumnsL(3);i.setColumnsM(2);i.setSingleContainerFullSize(true);i.setBreakpointXL(1440);i.setBreakpointL(1024);i.setBreakpointM(600);this._oFormLayoutNotInitial=false;}}function G(i){var L=i.oSource;A.call(this,L);if(i.getParameter("name")=="gridDataSpan"){this.propagateGridDataSpan();}}return S;},true);
