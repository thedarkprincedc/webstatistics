/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2017 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/comp/library','./Factory','./LinkData','sap/m/Link','sap/m/Text','sap/ui/layout/form/SimpleFormLayout','sap/m/Label','sap/ui/core/TitleLevel','sap/ui/core/Title','sap/ui/layout/form/SimpleForm','sap/m/Image'],function(C,F,L,c,T,S,d,e,f,g,I){"use strict";var U={getStorableAvailableActions:function(m){return m.filter(function(M){return M.key!==undefined;});},sortArrayAlphabetical:function(n){var l;try{l=sap.ui.getCore().getConfiguration().getLocale().toString();if(typeof window.Intl!=='undefined'){var o=window.Intl.Collator(l,{numeric:true});n.sort(function(a,b){return o.compare(a,b);});}else{n.sort(function(a,b){return a.localeCompare(b,l,{numeric:true});});}}catch(E){}},retrieveNavigationTargets:function(s,a,A,o,b,m){var n={mainNavigation:undefined,ownNavigation:undefined,availableActions:[]};return new Promise(function(r){var x=F.getService("CrossApplicationNavigation");var u=F.getService("URLParsing");if(!x||!u){jQuery.sap.log.error("Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return r(n);}var h=[s].concat(a);var p=h.map(function(i){return[{semanticObject:i,params:b?b[i]:undefined,appStateKey:A,ui5Component:o,sortResultsBy:"text"}];});x.getLinks(p).then(function(l){if(!l||!l.length){return r(n);}var j=x.hrefForExternal();if(j&&j.indexOf("?")!==-1){j=j.split("?")[0];}if(j){j+="?";}l[0][0].forEach(function(q){var t=u.parseShellHash(q.intent);var K=(t.semanticObject&&t.action)?t.semanticObject+"-"+t.action:undefined;var v=(q.tags&&q.tags.indexOf("superiorAction")>-1);if(q.intent.indexOf(j)===0){n.ownNavigation=new L({key:K,href:q.intent,text:q.text,visible:true,isSuperiorAction:v});return;}if(t.action&&(t.action==='displayFactSheet')){n.mainNavigation=new L({key:K,href:q.intent,text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_FACTSHEET"),visible:true,isSuperiorAction:v});return;}n.availableActions.push(new L({key:K,href:q.intent,text:q.text,visible:true,isSuperiorAction:v}));});if(!n.mainNavigation&&typeof m==="string"){n.mainNavigation=new L({text:m,visible:true});}var k=[];for(var i=1;i<h.length;i++){k=k.concat(l[i][0]);}k.forEach(function(q){var t=u.parseShellHash(q.intent);n.availableActions.push(new L({key:(t.semanticObject&&t.action)?t.semanticObject+"-"+t.action:undefined,href:q.intent,text:q.text,visible:true,isSuperiorAction:(q.tags&&q.tags.indexOf("superiorAction")>-1)}));});return r(n);},function(){jQuery.sap.log.error("'retrieveNavigationTargets' failed");return r(n);});});},retrieveSemanticObjectMapping:function(p,o,b){if(!p){return Promise.resolve(null);}if(!o||!o.getMetaModel()){return Promise.resolve(null);}var t=this;var m=o.getMetaModel();return new Promise(function(r){m.loaded().then(function(){var O=t._getEntityTypeNameOfBindingContext(b,m);var E=m.getODataEntityType(O);if(!E||!E.property){return r(null);}var P=E.property.filter(function(h){return h.name===p;});if(P.length!==1){return r(null);}if(!P[0]["com.sap.vocabularies.Common.v1.SemanticObjectMapping"]){return r(null);}var s=t._getSemanticObjectMappingsOfProperty(P[0],t._getSemanticObjectsOfProperty(P[0]));var a={};for(var q in s){a[s[q].name]=s[q].mapping;}return r(a);});});},_getSemanticObjectsOfProperty:function(p){var s={};for(var a in p){var A=a.split("#")[0];var q=a.split("#")[1]||"";if(jQuery.sap.startsWith(A,"com.sap.vocabularies.Common.v1.SemanticObject")&&jQuery.sap.endsWith(A,"com.sap.vocabularies.Common.v1.SemanticObject")){s[q]={name:p[a]["String"],mapping:undefined};}}return s;},_getSemanticObjectMappingsOfProperty:function(p,s){var G=function(o){var m={};if(jQuery.isArray(o)){o.forEach(function(P){m[P.LocalProperty.PropertyPath]=P.SemanticObjectProperty.String;});}return m;};for(var a in p){var A=a.split("#")[0];var q=a.split("#")[1]||"";if(jQuery.sap.startsWith(A,"com.sap.vocabularies.Common.v1.SemanticObjectMapping")&&jQuery.sap.endsWith(A,"com.sap.vocabularies.Common.v1.SemanticObjectMapping")){if(s[q]){s[q].mapping=G(p[a]);}}}return s;},_getEntityTypeNameOfBindingContext:function(b,m){if(!b||!m){return null;}var M;try{M=m.getMetaContext(b);}catch(E){jQuery.sap.log.error("sap.ui.comp.navpopover.Util: binding path '"+b+"' is not valid. Error has been catched: "+E);}if(!M){return null;}var o=m.getObject(M.getPath());return o.namespace?o.namespace+"."+o.name:o.name;},retrieveContactAnnotationData:function(o,b,s){var t=this;return new Promise(function(r){if(!o||!o.getMetaModel()||s===undefined){return r({entitySet:undefined,path:undefined,contactAnnotation:undefined});}var m=o.getMetaModel();m.loaded().then(function(){var O=t._getEntityTypeNameOfBindingContext(b,m);var E=m.getODataEntityType(O);if(!E){return r({entitySet:undefined,path:undefined,contactAnnotation:undefined});}var a=m.getODataEntitySet(s);if(a){E=m.getODataEntityType(a.entityType);return r({entitySet:s,path:"",contactAnnotation:E["com.sap.vocabularies.Communication.v1.Contact"]});}var A=[];s.split("/").some(function(n){var h=m.getODataAssociationEnd(E,n);if(!h){return false;}A.push(n);E=m.getODataEntityType(h.type);});return r({entitySet:undefined,path:E["com.sap.vocabularies.Communication.v1.Contact"]?A.join("/"):undefined,contactAnnotation:E["com.sap.vocabularies.Communication.v1.Contact"]});});});},parseContactAnnotation:function(o){var a=o.contactAnnotation;if(!a||jQuery.isEmptyObject(a)){return{groups:[],expand:"",select:""};}var p=o.path?o.path+"/":"";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");var E=[o.path];var s=[];var G=[];var b={heading:r.getText("POPOVER_CONTACT_SECTION_TITLE"),elements:[]};if(a.photo){s.push(p+a.photo.Path);var h=new I({src:{path:p+a.photo.Path},visible:{path:p+a.photo.Path,formatter:function(v){return!!v;}},decorative:false});h.addStyleClass("sapUiIcon");h.addStyleClass("navigationPopoverThumbnail");b.elements.push({label:"",control:h});}if(a.fn){s.push(p+a.fn.Path);b.elements.push({label:r.getText("POPOVER_CONTACT_SECTION_NAME"),control:new T({text:{path:p+a.fn.Path},visible:{path:p+a.fn.Path,formatter:function(v){return!!v;}}})});}if(a.role){s.push(p+a.role.Path);b.elements.push({label:r.getText("POPOVER_CONTACT_SECTION_ROLE"),control:new T({text:{path:p+a.role.Path},visible:{path:p+a.role.Path,formatter:function(v){return!!v;}}})});}if(a.title){s.push(p+a.title.Path);b.elements.push({label:r.getText("POPOVER_CONTACT_SECTION_JOBTITLE"),control:new T({text:{path:p+a.title.Path},visible:{path:p+a.title.Path,formatter:function(v){return!!v;}}})});}if(a.org){s.push(p+a.org.Path);b.elements.push({label:r.getText("POPOVER_CONTACT_SECTION_DEPARTMENT"),control:new T({text:{path:p+a.org.Path},visible:{path:p+a.org.Path,formatter:function(v){return!!v;}}})});}if(a.email){var A=function(m){if(!m.length){return;}m.filter(function(n){return n.type&&!n.deleted&&(n.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/work")>-1||n.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1);}).forEach(function(n){n.deleted=true;s.push(p+n.address.Path);b.elements.push({label:r.getText("POPOVER_CONTACT_SECTION_EMAIL"),control:new c({href:{path:p+n.address.Path,formatter:function(v){if(!v){return v;}return"mailto:"+v;}},text:{path:p+n.address.Path},visible:{path:p+n.address.Path,formatter:function(v){return!!v;}}})});});};A(a.email.filter(function(m){return m.type&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1;}));A(a.email.filter(function(m){return m.type&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")<0;}));}if(a.tel){var i=function(t,m){t.deleted=true;s.push(p+t.uri.Path);b.elements.push({label:m,control:new c({href:{path:p+t.uri.Path,formatter:function(v){if(!v){return v;}return"tel:"+v;}},text:{path:p+t.uri.Path},visible:{path:p+t.uri.Path,formatter:function(v){return!!v;}}})});};var j=function(t){if(!t.length){return;}t.filter(function(m){return m.type&&!m.deleted&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/work")>-1;}).forEach(function(m){i(m,r.getText("POPOVER_CONTACT_SECTION_PHONE"));});t.filter(function(m){return m.type&&!m.deleted&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/cell")>-1;}).forEach(function(m){i(m,r.getText("POPOVER_CONTACT_SECTION_MOBILE"));});t.filter(function(m){return m.type&&!m.deleted&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/fax")>-1;}).forEach(function(m){i(m,r.getText("POPOVER_CONTACT_SECTION_FAX"));});t.filter(function(m){return m.type&&!m.deleted&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1;}).forEach(function(m){i(m,r.getText("POPOVER_CONTACT_SECTION_PHONE"));});};j(a.tel.filter(function(t){return t.type&&t.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1;}));j(a.tel.filter(function(t){return t.type&&t.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")<0;}));}if(a.adr){var k=function(l){if(!l.length){return;}var m=jQuery.extend(true,[],l);m.filter(function(n){return n.type&&!n.deleted&&(n.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/work")>-1||n.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1);}).forEach(function(n){n.deleted=true;var P=[];if(n.street){s.push(p+n.street.Path);}P.push(n.street?{path:p+n.street.Path}:{path:"$notExisting"});if(n.code){s.push(p+n.code.Path);}P.push(n.code?{path:p+n.code.Path}:{path:"$notExisting"});if(n.locality){s.push(p+n.locality.Path);}P.push(n.locality?{path:p+n.locality.Path}:{path:"$notExisting"});if(n.region){s.push(p+n.region.Path);}P.push(n.region?{path:p+n.region.Path}:{path:"$notExisting"});if(n.country){s.push(p+n.country.Path);}P.push(n.country?{path:p+n.country.Path}:{path:"$notExisting"});if(P.length){b.elements.push({label:r.getText("POPOVER_CONTACT_SECTION_ADR"),control:new T({text:{parts:P,formatter:function(q,t,u,R,v){var V=[];if(q){V.push(q);}if(t){V.push(t);}if(u){V.push(u);}if(R){V.push(R);}if(v){V.push(v);}return V.join(', ');}},visible:{parts:P,formatter:function(q,t,u,R,v){return!!(q||t||u||R||v);}}})});}});};var l=a.adr.filter(function(m){return m.type&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1;});k(l);l=a.adr.filter(function(m){return m.type&&m.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")<0;});k(l);}if(b.elements.length){G.push(b);}return{groups:G,expand:E.join(","),select:s.join(",")};},createContactDetailForms:function(G){if(!G.length){return[];}var a=[];G.forEach(function(o){if(!o.elements.length){return;}var b=new g({maxContainerCols:1,editable:false,layout:S.ResponsiveGridLayout});o.elements.forEach(function(E){if(!E.control){return;}if(E.label){var l=new d({text:E.label,labelFor:E.control.getId()});b.addContent(l);}b.addContent(E.control);});if(b.getContent().length&&o.heading){b.insertContent(new f({text:o.heading,level:e.H2}),0);}a.push(b);});return a;}};return U;},true);
