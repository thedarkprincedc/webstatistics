/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2017 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/EventProvider","sap/ui/comp/smartfield/ODataControlFactory","sap/ui/core/Item","sap/ui/model/BindingMode"],function(q,E,O,I,B){"use strict";var C=E.extend("sap.ui.comp.smartmultiedit.ControlHelper",{constructor:function(p){E.call(this);if(p){this.oFieldInstance=p.fieldInstance;}this._bDatePickerFinalized=false;}});C.prototype.destroy=function(){E.prototype.destroy.apply(this);if(this._oFieldItem){this._oFieldItem.destroy();this._oFieldItem=null;}if(this.oControl){this.oControl.destroy();this.oControl=null;}};C.prototype.createFactory=function(s){var c=new O(this.oFieldInstance.getModel(),this.oFieldInstance,{entitySet:s.entitySet,path:s.propertyName});var t=this;var l=function(p){var f;p.loadAnnotation();if(p.getMetadata().getName()==="sap.ui.comp.providers.ValueHelpProvider"){f=p._onValueHelpDialogRequired;p._onValueHelpDialogRequired=function(){f.apply(this,arguments);this.oValueHelpDialog.attachOk(t._setItemOnFieldInstance,t);this.oValueHelpDialog.attachCancel(t.oFieldInstance.resetSelection,t.oFieldInstance);}.bind(p);}};var o=c.createValueHelp;c.createValueHelp=function(){o.apply(this,arguments);this._aProviders.forEach(l);};c._oFieldControl.getBindableAttributes=q.sap.getter(null);c.bind();return c;};C.prototype.enrichBeforeFactory=function(){this.oFieldInstance.getConfiguration=q.sap.getter(null);this.oFieldInstance.getControlContext=q.sap.getter(null);this.oFieldInstance._getMode=q.sap.getter("display");this.oFieldInstance.getEditable=q.sap.getter(true);this.oFieldInstance.setTooltipLabel=q.noop;this.oFieldInstance.getExpandNavigationProperties=q.sap.getter(null);this.oFieldInstance.getEnabled=q.sap.getter(true);this.oFieldInstance.getContextEditable=q.sap.getter(true);this.oFieldInstance.setTextLabel=q.noop;this.oFieldInstance.getMaxLength=q.sap.getter(0);this.oFieldInstance.getShowSuggestion=q.sap.getter(true);this.oFieldInstance.getTextLabel=q.sap.getter("");this.oFieldInstance.getExpandNavigationProperties=q.sap.getter(null);this.oFieldInstance.getMandatory=q.sap.getter(false);this.oFieldInstance.checkError=q.noop;this.oFieldInstance.getControlProposal=q.sap.getter(false);this.oFieldInstance.getProposedControl=q.sap.getter(false);this.oFieldInstance.isContextTable=q.sap.getter(false);this.oFieldInstance.getTextArrangementInEditMode=q.sap.getter(false);this.oFieldInstance.getMode=q.sap.getter("edit");this.oFieldInstance.onBeforeValidateValue=q.noop;this.oFieldInstance.onTextInputFieldAsyncChange=q.noop;this.oFieldInstance.getBindingInfo=q.sap.getter({parts:[{model:"json",path:""}]});};C.prototype.enrichAfterFactory=function(){this.oFieldInstance.data=function(d){if(d==="errorCheck"){return"checkError";}else{return{style:"short",configdata:{onInput:q.noop}};}};};C.prototype.addControlInitialization=function(c){return new Promise(function(r){this.oFieldInstance.fireInitialise=function(){this.oControl=c.createControl().control;this.oFieldInstance.addDependent(this.oControl);this._prepareControl();r();}.bind(this);}.bind(this));};C.prototype._prepareControl=function(){var c=this.getControlName();switch(c){case"sap.m.CheckBox":this._prepareCheckBox(this.oControl);break;case"sap.m.Input":this._prepareInput(this.oControl);break;case"sap.m.DateTimePicker":case"sap.m.DatePicker":this._prepareDatePicker(this.oControl);break;default:q.sap.log.error("The property's OData type is not supported by the sap.ui.comp.smartmultiedit.Field.");break;}};C.prototype._prepareCheckBox=function(){this._setOneWayBindingMode("selected");};C.prototype._prepareInput=function(){this._setOneWayBindingMode("value");};C.prototype._prepareDatePicker=function(){this._setOneWayBindingMode("value");this.oControl.getDomRef=function(){return this._getInternalDomRef();}.bind(this.oFieldInstance);if(this.getControlName()==="sap.m.DateTimePicker"){this.oControl.getUIArea=function(){return this._getInternalUIArea();}.bind(this.oFieldInstance);}};C.prototype.getControlName=function(){return this.oControl&&this.oControl.getMetadata().getName();};C.prototype._setOneWayBindingMode=function(b){var o=this.oControl.getBinding(b);if(o){o.setBindingMode(B.OneWay);}};C.prototype.triggerValueSelection=function(){var c=this.getControlName();switch(c){case"sap.m.Input":this._triggerValueSelectionOnInput();break;case"sap.m.DateTimePicker":case"sap.m.DatePicker":this._triggerValueSelectionOnDatePicker();break;default:q.sap.log.error("The control instance does not support a value selection.");break;}};C.prototype._triggerValueSelectionOnInput=function(){this.oControl.fireValueHelpRequest();};C.prototype._triggerValueSelectionOnDatePicker=function(){this.oControl.onsapshow({preventDefault:q.noop});q.sap.delayedCall(0,this,function(){if(this.oControl&&this.oControl._oPopup){var c=this.oControl._oPopup.getContent();if(q.isArray(c)){c[0].focus();}else{c.focus();}}});if(!this._bDatePickerFinalized){this._finalizeDatePicker();}};C.prototype._finalizeDatePicker=function(){var c=this.getControlName();if(c==="sap.m.DateTimePicker"){this.oControl._oPopup.attachAfterClose(this._onPopupClosed,this);this.oControl._oPopup.attachBeforeOpen(this._onPopupOpened,this);}else if(c==="sap.m.DatePicker"){this.oControl._oPopup.attachClosed(this._onPopupClosed,this);this.oControl._oPopup.attachOpened(this._onPopupOpened,this);}this._bDatePickerFinalized=true;};C.prototype._onPopupClosed=function(){var n=this.oControl.getDateValue();if(n){this._setItemOnFieldInstance();}else{this.oFieldInstance.resetSelection();}this.oControl.focus();};C.prototype._onPopupOpened=function(){this.oControl.setDateValue(null);};C.prototype._setItemOnFieldInstance=function(){var v=this.oControl.getValue();if(!v){return;}if(!this._oFieldItem){this._oFieldItem=new I({text:v});this.oFieldInstance.addItem(this._oFieldItem);}else{this._oFieldItem.setText(v);}this._oFieldItem.data("value",this.getControlValue());this.oFieldInstance.setSelectedItem(this._oFieldItem);};C.prototype.getControlValue=function(){var c=this.getControlName();if(c==="sap.m.Input"){return this.oControl.getValue();}if(c==="sap.m.DatePicker"||c==="sap.m.DateTimePicker"){return this.oControl.getDateValue();}return null;};return C;});
