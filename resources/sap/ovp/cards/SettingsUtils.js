/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(['jquery.sap.global',"sap/m/Dialog","sap/m/ToolbarSpacer","sap/m/Button",'sap/ovp/cards/CommonUtils','sap/ovp/cards/rta/SettingsDialogConstants','sap/ui/Device','sap/m/MessagePopover','sap/m/MessagePopoverItem','sap/m/Link'],function(q,D,T,B,C,S,a,M,b,L){"use strict";function c(i,v){var m=i.getComponentInstance(),n=m.getComponentData(),A=n.appComponent,p=n.cardId,r=p+'Dialog',t=n.modelName,u=A.getModel(t),w=v.getModel().getData(),x={cards:{}};x.cards[r]={model:t,template:w.template,settings:w};v.setModel(u,t);v.getController()._oManifest=x;C.createCardComponent(v,x,'dialogCard');}function g(A){if(A.indexOf('#')!==-1){return A.split('#')[1];}else{return"Default";}}function d(E,K){var A;if(K.indexOf(",")!==-1){K=K.split(",")[0];}if(K.indexOf(".Identification")!==-1){if(E[K]){var r=sap.ovp.cards.AnnotationHelper.sortCollectionByImportance(E[K]);for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){if(I&&I["Label"]){return I["Label"].String;}else{return I["SemanticObject"].String+"-"+I["Action"].String;}}if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){if(I&&I["Label"]){return I["Label"].String;}else{return I["Url"].String;}}}}return"No Navigation";}else if(K.indexOf(".HeaderInfo")!==-1){A=g(K);if(E[K]&&E[K]["Description"]&&E[K]["Description"].Label){return E[K]["Description"].Label.String}else{return A;}}else{var m="";A=g(K);if(A!=="Default"){m="#"+A;}var n="com.sap.vocabularies.Common.v1.Label"+m;if(E[K]&&E[K][n]){return E[K][n].String;}else{return A;}}}function e(t,i){switch(i){case"cardPreview":return(C.supportedCards.indexOf(t)!==-1);case"listType":case"listFlavor":var m=["sap.ovp.cards.list"];return(m.indexOf(t)!==-1);case"listFlavorForLinkList":var n=["sap.ovp.cards.linklist"];return(n.indexOf(t)!==-1);case"isViewSwitchSupportedCard":case"kpiHeader":var p=["sap.ovp.cards.list","sap.ovp.cards.table","sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.bubble","sap.ovp.cards.charts.donut","sap.ovp.cards.charts.line"];return(p.indexOf(t)!==-1);case"chart":var r=["sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.bubble","sap.ovp.cards.charts.donut","sap.ovp.cards.charts.line"];return(r.indexOf(t)!==-1);case"sortOrder":case"sortBy":case"lineItem":var u=["sap.ovp.cards.list","sap.ovp.cards.table"];return(u.indexOf(t)!==-1);default:break;}}function f(i,E,m,I){var n=true;var p=true;if(m){if(i.mainViewSelected){p=false;}else{n=false;}}switch(E){case"cardPreview":return e(i.template,"cardPreview");case"title":return n;case"dynamicSwitchSubTitle":return n&&!!i.dynamicSubTitle;case"dynamicSwitchStateSubTitle":return!!i.dynamicSubtitleAnnotationPath;case"subTitle":if(!i.subTitle){i.subTitle=' ';return false;}else{return n&&!i.dynamicSubtitleAnnotationPath;}case"dynamicSubTitle":return p&&!!i.dynamicSubtitleAnnotationPath;case"valueSelectionInfo":if(!i.valueSelectionInfo){i.valueSelectionInfo=' ';}return n&&(e(i.template,"kpiHeader")&&!!i.dataPointAnnotationPath);case"dataPoint":return p&&(e(i.template,"kpiHeader")&&!!i.dataPointAnnotationPath);case"listType":case"listFlavor":case"listFlavorForLinkList":return n&&e(i.template,E);case"sortOrder":return n&&(!i.staticContent)&&e(i.template,E)&&!!i.sortBy;case"sortBy":return n&&(!i.staticContent)&&e(i.template,E);case"identification":return p&&(!i.staticContent);case"presentationVariant":case"selectionVariant":return p&&(!i.staticContent)&&e(i.template,"kpiHeader");case"kpiHeader":return n&&e(i.template,E);case"lineItem":case"chart":return p&&e(i.template,E);case"showViewName":return m&&p;case"showDefaultView":if(m&&p){if(i.defaultViewSelected!=i.selectedKey){return true;}}return false;case"showMore":case"removeVisual":case"lineItemSubTitle":case"lineItemTitle":case"staticLink":case"links":var F=(i.template==="sap.ovp.cards.linklist"&&!!i.staticContent);if(E==="staticLink"){return(F&&!!i.staticContent[I].targetUri);}else if(E==="links"){return(F&&!!i.staticContent[I].semanticObject);}else if(E==="removeVisual"){return(F&&(!!i.staticContent[I].targetUri||!!i.staticContent[I].semanticObject));}else{return F;}default:break;}}function s(i){var m=false;this.oVisibility.viewSwitchEnabled=false;this.oVisibility.showViewSwitch=false;if(e(i.template,'isViewSwitchSupportedCard')){if(i.tabs&&i.tabs.length){m=true;this.oVisibility.showViewSwitch=true;}this.oVisibility.viewSwitchEnabled=true;}this.oVisibility.cardPreview=f(i,"cardPreview");this.oVisibility.title=f(i,"title",m);this.oVisibility.subTitle=f(i,"subTitle",m);this.oVisibility.valueSelectionInfo=f(i,"valueSelectionInfo",m);this.oVisibility.listType=f(i,"listType",m);this.oVisibility.listFlavor=f(i,"listFlavor",m);this.oVisibility.listFlavorForLinkList=f(i,"listFlavorForLinkList",m);this.oVisibility.sortOrder=f(i,"sortOrder",m);this.oVisibility.sortBy=f(i,"sortBy",m);if(i.template==="sap.ovp.cards.linklist"&&!!i.staticContent){var n=i.staticContent,v={},V={},p={},r={};for(var t=0;t<n.length;t++){var I=n[t].index;v[I]=f(i,"staticLink",null,t);V[I]=f(i,"links",null,t);p[I]=f(i,"removeVisual",null,t);r[I]=f(i,"showMore",null,t);}this.oVisibility.staticLink=v;this.oVisibility.links=V;this.oVisibility.removeVisual=p;this.oVisibility.showMore=r;}this.oVisibility.lineItemTitle=f(i,"lineItemTitle");this.oVisibility.lineItemSubTitle=f(i,"lineItemSubTitle");this.oVisibility.showViewName=f(i,"showViewName",m);this.oVisibility.showDefaultView=f(i,"showDefaultView",m);this.aVariantNames.forEach(function(u){this.oVisibility[u.sPath]=f(i,u.sPath,m)&&!!i[u.sPath]&&!!i[u.sPath].length;}.bind(this));this.oVisibility.kpiHeader=f(i,"kpiHeader",m)&&!!i["dataPoint"]&&!!i["dataPoint"].length;this.oVisibility.dynamicSwitchSubTitle=f(i,"dynamicSwitchSubTitle",m);this.oVisibility.dynamicSwitchStateSubTitle=f(i,"dynamicSwitchStateSubTitle",m);this.oVisibility.moveToTheTop=false;this.oVisibility.moveUp=false;this.oVisibility.moveDown=false;this.oVisibility.moveToTheBottom=false;this.oVisibility.delete=false;}function _(){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");var i=r?new sap.ui.model.resource.ResourceModel({bundleUrl:r.oUrlInfo.url}):null;return i;}function h(i){var m=i.getProperty("/staticContent");for(var n=0;n<m.length;n++){m[n].index="Index--"+(n+1);}i.setProperty("/staticContent",m);}function j(i){if(i.lineItem){i.lineItem.forEach(function(n){if(n.value===i.annotationPath){i.lineItemQualifier=n.name;}});}if(i.tabs&&i.tabs.length&&i.selectedKey){i.viewName=i.tabs[i.selectedKey-1].value;i.isDefaultView=false;if(i.selectedKey===i.defaultViewSelected){i.isDefaultView=true;}}var m=i.sortOrder;i.sortOrder='descending';if(m&&m.toLowerCase()!=='descending'){i.sortOrder='ascending';}i.isExtendedList=false;if(i.listType==='extended'){i.isExtendedList=true;}i.isBarList=false;if(i.listFlavor==='bar'){i.isBarList=true;}i.hasKPIHeader=false;if(i.dataPointAnnotationPath){i.hasKPIHeader=true;}return i;}function k(i){var E=i.entityType;this.aVariantNames.forEach(function(v){var V=[];for(var n in E){if(E.hasOwnProperty(n)&&n.indexOf(v.sVariant)!==-1){if(v.sVariant===".LineItem"){var p={name:d(E,n),value:n,fields:sap.ovp.cards.AnnotationHelper.sortCollectionByImportance(E[n])};V.push(p);}else{V.push({name:d(E,n),value:n});}}}if(V.length!==0){if(!v.isMandatoryField){V.unshift({name:'Select Value',value:''});}i[v.sPath]=V;}});if(i.entityType&&i.entityType.property){i['modelProperties']=i.entityType.property.map(function(p){return{name:p.name,value:p.name}});i['modelProperties'].unshift({name:'Select Value',value:''});}if(!!i.tabs&&i.tabs.length){var m=false;i.newViewCounter=0;i.defaultViewSelected=i.selectedKey;i.isViewResetEnabled=false;i.aViews=[{text:'Main',key:0,isLaterAddedView:false,isViewResetEnabled:false}];m=i.tabs.some(function(t){return t.dataPointAnnotationPath;});i.tabs.forEach(function(t,n){var p=t.value;if(m&&!t.dataPointAnnotationPath&&t.dataPoint&&t.dataPoint.length){t.dataPointAnnotationPath=t.dataPoint[0].value;}if(n+1===i.selectedKey){p=t.value+" (default view)";}i.aViews.push({text:p,key:n+1,initialSelectedKey:n+1,isLaterAddedView:false,isViewResetEnabled:false})});}else if(e(i.template,'isViewSwitchSupportedCard')){i.newViewCounter=0;i.aViews=[{text:'click "+" to add a view',key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];}return i;}function l(m){var n=m.getData();sap.ushell.Container.getService('CrossApplicationNavigation').getLinks().done(function(p){var A=[],r={};for(var i=0;i<p.length;i++){A.push(p[i].intent);r[p[i].intent]=p[i].text;}sap.ushell.Container.getService('CrossApplicationNavigation').isIntentSupported(A).done(function(R){var p=[];for(var t in R){if(R.hasOwnProperty(t)&&R[t].supported===true&&r&&r[t]){p.push({name:r[t],value:t});}}var u=n;if(p.length!==0||p.length!==0){u['links']=p;}m.refresh();}).fail(function(E){q.sap.log.error(E);});}).fail(function(E){q.sap.log.error(E);});}var o={dialogBox:undefined,oSaveButton:undefined,oResetButton:undefined,oMessagePopOverButton:undefined,oMessagePopOver:undefined,oAppDescriptor:undefined,sApplicationId:"",iContentHeightForDialog:38,iContentHeightForDialogWithViewSwitch:33,aVariantNames:S.aVariantNames,FORM_ITEM_NAME_FOR_LIST_FLAVOR_IN_LINKLIST:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OVP_KEYUSER_CAROUSEL"),FORM_ITEM_NAME_FOR_LIST_FLAVOR_IN_LIST:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OVP_KEYUSER_BARLIST"),addManifestSettings:j,setVisibilityForFormElements:s,getVisibilityOfElement:f,oVisibility:S.oVisibility,getDialogBox:function(i){return new Promise(function(r,m){if(!this.dialogBox){this.oSaveButton=new B("settingsSaveBtn",{text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("save"),type:"Emphasized"});var n=new B("settingsCancelBtn",{text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("cancelBtn")});this.oResetButton=new B("settingsResetBtn",{text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("resetCardBtn")});this.oMessagePopOverButton=new B("settingsMessagePopOverBtn",{text:"{/Counter/All}",type:"Emphasized",icon:"sap-icon://message-popup"}).addStyleClass("sapOvpSettingsMessagePopOverBtn");this.dialogBox=new D("settingsDialog",{title:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("settingsDialogTitle"),buttons:[this.oMessagePopOverButton,this.oSaveButton,n,this.oResetButton],afterClose:function(N){var K=this.dialogBox.getContent()[0],P=K.byId("sapOvpSettingsLineItemTitle"),Q=K.byId("sapOvpSettingsLineItemSubTitle");if(P){P.destroy();}if(Q){Q.destroy();}this.dialogBox.destroyContent();}.bind(this)});this.dialogBox.setBusyIndicatorDelay(0);n.attachPress(function(N){this.dialogBox.close();}.bind(this));}var p=new L({text:"Show more information",href:"http://sap.com",target:"_blank"});var t=new b({type:'{type}',title:'{title}',description:'{description}',subtitle:'{subtitle}',counter:'{counter}',fieldName:'{fieldName}',link:p});this.oMessagePopOver=new M({items:{path:'/Messages',template:t}});var u={'Counter':{'All':0,'Error':0,'Success':0,'Warning':0,'Information':0},'Messages':[]};var v=new sap.ui.model.json.JSONModel(u);this.oMessagePopOver.setModel(v);this.oMessagePopOverButton.setModel(v);var w=i.getComponentInstance(),O=w.getRootControl().getModel("ovpCardProperties").getData(),x=q.extend(true,{},O);x=k.call(this,x);x=this.addManifestSettings(x);var y=new sap.ui.model.json.JSONModel(x),z=_(),A=i.getDomRef().offsetHeight,E=new sap.ui.model.json.JSONModel(a.system),F=w.getComponentData(),G=F.mainComponent,H=G.getLayout();this.oAppDescriptor=G._getCardFromManifest(F.cardId);this.sApplicationId=G._getApplicationId();E.setDefaultBindingMode("OneWay");x.dialogBoxHeight=A;x.dialogBoxWidth=H.getColumnWidth(H.columnStyle);if(x.template==="sap.ovp.cards.linklist"){y.setProperty("/listFlavorName",this.FORM_ITEM_NAME_FOR_LIST_FLAVOR_IN_LINKLIST);}else{y.setProperty("/listFlavorName",this.FORM_ITEM_NAME_FOR_LIST_FLAVOR_IN_LIST);}if(x.template==="sap.ovp.cards.linklist"&&x.staticContent){var I={};var J=new sap.ui.model.json.JSONModel(I);l(J);h(y);y.setProperty("/lineItemId","linkListItem--1");y.setProperty("/lineItemIdCounter",x.staticContent.length);}this.setVisibilityForFormElements(x);var V=new sap.ui.model.json.JSONModel(this.oVisibility);var K=new sap.ui.view("settingsView",{viewName:"sap.ovp.cards.rta.SettingsDialog",type:sap.ui.core.mvc.ViewType.XML,preprocessors:{xml:{bindingContexts:{ovpCardProperties:y.createBindingContext("/")},models:{ovpCardProperties:y,deviceSystemProperties:E}}}});if(x.template==="sap.ovp.cards.linklist"&&x.staticContent){K.setModel(J,"staticCardProperties");}K.setModel(y);K.setModel(z,"ovplibResourceBundle");K.setModel(V,"visibility");this.dialogBox.addContent(K);K.loaded().then(function(N){var P=N.byId("dialogCard");if(!P.getVisible()){P=N.byId("dialogCardNoPreview");}P.setWidth(x.dialogBoxWidth+"rem");c(i,N);this.dialogBox.open();N.getController().settingsResolve=r;}.bind(this));}.bind(this));}};return o;},true);
