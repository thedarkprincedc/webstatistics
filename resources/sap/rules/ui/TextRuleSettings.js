/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Column","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/m/ComboBox","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression"],function(q,l,C,S,L,a,b,M,T,c,d,f,I,B,g,E,V,h){"use strict";var t=C.extend("sap.rules.ui.TextRuleSettings",{metadata:{library:"sap.rules.ui",properties:{modelName:{type:"string",defaultValue:""},newTextRule:{type:"boolean",defaultValue:false},enableElseIf:{type:"boolean",defaultValue:false},enableElse:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}}}});sap.rules.ui.TextRuleSettings.prototype._callRefreshResultsFunctionImport=function(){var i=this;var o=this.getModel("oDataModel");var m=this.getModel().getData();var j={groupId:"changes"};o.setDeferredGroups([j.groupId]);var s=function(r){i._createPredefinedTable();i.getModel().getData().needToRefresh=false;};var k=function(e){sap.m.MessageToast.show(e);};var n=function(r){var R=m.RuleId;o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:j.groupId,urlParameters:{RuleId:R}});o.submitChanges({groupId:j.groupId,success:s,error:k});};if(m.needToRefresh){n();}};sap.rules.ui.TextRuleSettings.prototype._createInfoMessageStrip=function(e,i){var m=new sap.m.MessageStrip({visible:true,id:i,text:e,type:sap.ui.core.MessageType.Information,showIcon:true,showCloseButton:true}).addStyleClass("sapTextRuleSettingsMessageStrip");return m;};sap.rules.ui.TextRuleSettings.prototype._createLayout=function(){var e=this;if(!this.oForm){this._destroyElements();this.oForm=new S("_formLayout",{editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new L(),new f("__elseCheckBox",{enabled:true,width:"100px",text:this.oBundle.getText("enableElse"),selected:this.getProperty("enableElse"),select:function(o){var s=o.getSource();var i=s.getSelected();var _=this.getModel();var m=_.getData();if(m.ElseStatus!="C"){m.ElseStatus="U";}e.setProperty("enableElse",i);}}),new L({text:this.oBundle.getText("output")}).setTooltip(this.oBundle.getText("output")),new sap.ui.layout.HorizontalLayout({content:[new b("__resultSelect",{width:"220px",items:{path:"settingModel>/results/resultsEnumeration",template:new sap.ui.core.Item({key:"{settingModel>Id}",text:"{settingModel>Name}"})},selectedKey:"{/ResultDataObjectId}",change:function(o){var s=o.getSource();var _=this.getModel();var m=_.getData();if(m.ResultDataObjectStatus!="C"){m.ResultDataObjectId=s.getSelectedKey();m.ResultDataObjectName=s._getSelectedItemText();m.ResultDataObjectStatus="U";if(m.ResultDataObjectId!=s.getSelectedKey()){this._updateRefreshFlags(false,false);}}this.getModel("settingModel").setProperty("/resultDataObjectChanged",true);this._createPredefinedTable();}.bind(this)}),this._createRefreshButton()]}),new L(),this._createPredefinedResultsLayout()]}).addStyleClass("sapTextRuleSettingsForm");}this.oForm.setBusyIndicatorDelay(0);return this.oForm;};sap.rules.ui.TextRuleSettings.prototype._createPredefinedResultsLayout=function(){var r=false;var s=this.getModel("oDataModel").sServiceUrl;if(s=="/rules-service/rule_srv"){r=true;}if(r){var v=this._createVerticalLayout();return v;}else{return new L();}};sap.rules.ui.TextRuleSettings.prototype._createPredefinedTable=function(){if(!this.oPredefinedTable){this.oPredefinedTable=new T("idPredefinedTable",{backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.All,swipeDirection:sap.m.SwipeDirection.Both,fixedLayout:true,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new c({width:"45%",header:new sap.m.Label({text:"Text Rule Results",design:sap.m.LabelDesign.Bold})}),new c({width:"25%",header:new sap.m.Label({text:"Access",design:sap.m.LabelDesign.Bold})}),new c({width:"45%",header:new sap.m.Label({text:"Value",design:sap.m.LabelDesign.Bold})})]});}var r=this.getModel("settingModel").getProperty("/resultDataObjectChanged");var R=this.getModel("settingModel").getProperty("/refreshButtonClicked");var _=this.getModel("oDataModel");if(!r&&!R){this.oPredefinedTable.setModel(_);var e=[this.getModel().getData().ruleBindingPath,"/TextRule/TextRuleResults"].join("");this.oPredefinedTable.bindItems({path:e,factory:this._tableFactory.bind(this)});this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;}else{this._updatePredefinedTable(this.getModel().getData());}return null;};sap.rules.ui.TextRuleSettings.prototype._createRefreshButton=function(){var _=function(){this.getModel("settingModel").setProperty("/refreshButtonEnabled",true,null,true);return this.oBundle.getText("textRuleRefreshWarning");}.bind(this);var e=function(){this._updateRefreshFlags(true,false);}.bind(this);var i=_();var j=function(){var k=i;M.warning(k,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A===sap.m.MessageBox.Action.OK){e();}}});}.bind(this);var r=new B({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:j,visible:true,enabled:"{settingModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtn"));this.refreshButton=r;return r;};sap.rules.ui.TextRuleSettings.prototype._createVerticalLayout=function(){var v=new sap.ui.layout.VerticalLayout("verticalLayout",{content:[this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripHiddenAccessInfoText"),"id_HiddenAccessMessageStrip"),this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripEditableAccessInfoText"),"id_EditableAccessMessageStrip"),this._createPredefinedTable()]});return v;};sap.rules.ui.TextRuleSettings.prototype._destroyElements=function(){if(sap.ui.getCore().byId("_formLayout")){sap.ui.getCore().byId("_formLayout").destroy();}if(sap.ui.getCore().byId("__elseCheckBox")){sap.ui.getCore().byId("__elseCheckBox").destroy();}if(sap.ui.getCore().byId("__resultSelect")){sap.ui.getCore().byId("__resultSelect").destroy();}if(sap.ui.getCore().byId("id_HiddenAccessMessageStrip")){sap.ui.getCore().byId("id_HiddenAccessMessageStrip").destroy();}if(sap.ui.getCore().byId("id_EditableAccessMessageStrip")){sap.ui.getCore().byId("id_EditableAccessMessageStrip").destroy();}if(sap.ui.getCore().byId("idPredefinedTable")){sap.ui.getCore().byId("idPredefinedTable").destroy();}};sap.rules.ui.TextRuleSettings.prototype._getAccessOptions=function(){var A={accessEnumration:[{key:"editableAccess",value:"Editable"},{key:"hiddenAccess",value:"Hidden"}]};return A;};sap.rules.ui.TextRuleSettings.prototype._getCurrentResult=function(){var m=this.getModel().getData();var H={Id:m.RuleId,Version:m.RuleVersion};var D=this.getModel("oDataModel");var p=D.createKey("/Rules",H);var e=p.split("/")[1];m.ResultDataObjectId=D.oData[e].ResultDataObjectId;m.ResultDataObjectName=D.oData[e].ResultDataObjectName;m.ResultDataObjectStatus="A";};sap.rules.ui.TextRuleSettings.prototype._getMessageByResultUpdates=function(r){var m=this.oBundle.getText("refreshingWillDeleteMsg");var e=this.oBundle.getText("refreshAreyouSureMsg");var i=r.addedColumns.length+r.changedColumns.length+r.removedColumns.length;if(i!=0){var j=function(s){return"'"+s+"'";};var k=(r.addedColumns.length==0)?"":this.oBundle.getText("columnsWereAdded",r.addedColumns.map(j).toString());var n=(r.changedColumns.length==0)?"":this.oBundle.getText("columnsWereChanged",r.changedColumns.map(j).toString());var o=(r.removedColumns.length==0)?"":this.oBundle.getText("columnsWereRemoved",r.removedColumns.map(j).toString());var p=k+n+o+((r.removedColumns.length==0)?"":m)+e;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",true,null,true);return p;}else{this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true);}return null;};sap.rules.ui.TextRuleSettings.prototype._getPredefinedExpressionAdvanced=function(o,e,i,j){var k=sap.ui.getCore().byId(this.getExpressionLanguage());var s=j?j:sap.rules.ui.ExpressionType.NonComparison;return new E({expressionLanguage:k,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,id:e,type:s,value:i,editable:true,change:function(m){var n=m.getSource();var o=n.getBindingContext();var r=o.getPath().split("/")[1];o.oModel.oData[r].Expression=n.getValue();this.getModel("settingModel").setProperty("/resultAttributeChanged",true);this._updateResultAttributeJSON(o,false,null,n.getValue());}.bind(this)});},sap.rules.ui.TextRuleSettings.prototype._getResultsData=function(){var e=this;var i=this.getProperty("newTextRule");var m=this.getModel("oDataModel");var r=this.getModel().getData();var H={Id:r.ProjectId,Version:r.ProjectVersion};var j=[m.createKey("/Projects",H),"/DataObjects"].join("");m.read(j,{success:function(k){e._readSuccess(k,i);},error:function(){console.log("Error reading DO");}});};sap.rules.ui.TextRuleSettings.prototype._getSelectedVisibilityStatus=function(A){if(A=="Hidden"){return"hiddenAccess";}else{return"editableAccess";}};sap.rules.ui.TextRuleSettings.prototype._initSettingsModel=function(r){var i={};i.predefinedResults=[];i.results=r;i.accessOptions=this._getAccessOptions();this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"settingModel");};sap.rules.ui.TextRuleSettings.prototype._readSuccess=function(e,i){if(e){var r={resultsEnumeration:e.results};r.resultsEnumeration.push({Id:"0",Name:""});this._initSettingsModel(r);if(i){this._setDefaultResult();}else{this._getCurrentResult();}if(this.needCreateLayout){var j=this.getAggregation("mainLayout");if(j){j.destroy();}j=this._createLayout();this.setAggregation("mainLayout",j);this.needCreateLayout=false;}}};sap.rules.ui.TextRuleSettings.prototype._setDefaultResult=function(){var _=this.getModel();var m=_.getData();var r=this._internalModel.getData().results.resultsEnumeration;if(r.length>0){m.ResultDataObjectId=r[r.length-1].Id;m.ResultDataObjectName=r[r.length-1].Name;m.ResultDataObjectStatus="A";}};sap.rules.ui.TextRuleSettings.prototype._setColumnAccessMode=function(o,e){var s=e.getSource();var i="exp"+e.getSource().sId.split("select")[1];var j=sap.ui.getCore().byId(i);var k=s.getSelectedKey();var r=o.getPath().split("/")[1];if(k==="hiddenAccess"){o.oModel.oData[r].AccessMode="Hidden";o.oModel.oData[r].Expression="";j.setValue("");j.setValueStateText(this.oBundle.getText("defaultValue"));this._updateResultAttributeJSON(o,false,"Hidden",null);}else{o.oModel.oData[r].AccessMode="Editable";this._updateResultAttributeJSON(o,false,"Editable",null);}this.getModel("settingModel").setProperty("/resultAttributeChanged",true);};sap.rules.ui.TextRuleSettings.prototype._tableFactory=function(i,o){var e=i.split("-")[1];var j="exp"+e;var k=o.getProperty("DataObjectAttributeName")?o.getProperty("DataObjectAttributeName"):o.getProperty("Name");var m=o.getProperty("DataObjectAttributeId")?o.getProperty("DataObjectAttributeId"):o.getProperty("Id");var n;var p=o.getProperty("BusinessDataType");var s;var r=this.getModel("settingModel");var A=r.oData.predefinedResults;if(r.getProperty("/resultDataObjectChanged")){this._updateResultAttributeJSON(o,true,"Editable","");s="Editable";n="";}else if(r.getProperty("/refreshButtonClicked")){var u=A[m];s=u?u.AccessMode:"Editable";n=u?u.Expression:"";this._updateResultAttributeJSON(o,false,s,n);}else{n=o.getProperty("Expression");s=o.getProperty("AccessMode");this._updateResultAttributeJSON(o,false,s,n);}var v=this._getSelectedVisibilityStatus(s);return new sap.m.ColumnListItem({visible:true,cells:[new sap.m.Label({visible:true,design:sap.m.LabelDesign.Standard,text:k,textAlign:sap.ui.core.TextAlign.Begin,textDirection:sap.ui.core.TextDirection.Inherit}),new sap.m.Select({width:"65%",id:"select"+e,items:{path:"settingModel>/accessOptions/accessEnumration",template:new sap.ui.core.Item({key:"{settingModel>key}",text:"{settingModel>value}"})},selectedKey:v,change:function(w){this._setColumnAccessMode(o,w);}.bind(this)}),this._getPredefinedExpressionAdvanced(o,j,n,p)]});};sap.rules.ui.TextRuleSettings.prototype._updatePredefinedTable=function(r){if(this.getModel("settingModel").getProperty("/resultDataObjectChanged")){this.getModel("settingModel").oData.predefinedResults=[];}this.resultDataObjectModel=this.getModel("oDataModel");var e=this._internalModel.getData().results.resultsEnumeration;var j;for(var i=0;i<e.length;i++){if(e[i].Id==r.ResultDataObjectId){j=e[i].Version;break;}}var k=this.getModel().getData();var H={Id:k.ProjectId,Version:k.ProjectVersion};var p=this.resultDataObjectModel.createKey("/Projects",H);H={Id:r.ResultDataObjectId,Version:j};var s=[p,this.resultDataObjectModel.createKey("/DataObjects",H),"/DataObjectAttributes"].join("");this.oPredefinedTable.setModel(this.resultDataObjectModel);this.oPredefinedTable.bindItems({path:s,factory:this._tableFactory.bind(this)});this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;};sap.rules.ui.TextRuleSettings.prototype._updateRefreshFlags=function(n,i){this.getModel().getData().needToRefresh=n;this.getModel("settingModel").setProperty("/refreshButtonEnabled",i,null,true);this.getModel("settingModel").setProperty("/refreshButtonClicked",true);this._callRefreshResultsFunctionImport();};sap.rules.ui.TextRuleSettings.prototype._updateResultAttributeJSON=function(o,r,A,e){var s=this.getModel("settingModel");var i=s.getProperty("/refreshButtonClicked");var j=o.getProperty("DataObjectAttributeId")?o.getProperty("DataObjectAttributeId"):o.getProperty("Id");if(s.oData.predefinedResults){if(s.oData.predefinedResults[j]){if(r){s.oData.predefinedResults[j].AccessMode="Editable";s.oData.predefinedResults[j].Expression="";}if(i){s.oData.predefinedResults[j]=o.getObject(o.sPath);s.oData.predefinedResults[j].isAttributeinBackend=true;}if(A){s.oData.predefinedResults[j].AccessMode=A;}if(e||e==""){s.oData.predefinedResults[j].Expression=e;}}else{s.oData.predefinedResults[j]=o.getObject(o.sPath);if(r){s.oData.predefinedResults[j].AccessMode="Editable";s.oData.predefinedResults[j].Expression="";}if(i){s.oData.predefinedResults[j].isAttributeinBackend=true;}}}};sap.rules.ui.TextRuleSettings.prototype.getButtons=function(D){var e=[];var o=new B({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtn"));o.attachPress(function(){D.close();},this);var A=new B({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));A.attachPress(function(){this._applySettingsModelChangesToOData(D);},this);e.push(A);e.push(o);return e;};sap.rules.ui.TextRuleSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.setBusyIndicatorDelay(0);};sap.rules.ui.TextRuleSettings.prototype.onBeforeRendering=function(){if(this.firstLoad){this._getResultsData();this.firstLoad=false;}};sap.rules.ui.TextRuleSettings.prototype._applySettingsModelChangesToOData=function(D){var e=this;var _=this.getModel();var o=this.getModel("oDataModel");var s=this.getModel("settingModel");var j=this.getBindingContext("dummy");var r=_.oData.RuleId;var R=_.oData.RuleVersion;var k=_.oData.ResultDataObjectId;var m=s.getProperty("/resultDataObjectChanged");var A=s.getProperty("/resultAttributeChanged");var n=this.getProperty("enableElse");var p=(_.oData.ElseStatus=="U"&&n)?false:true;var u={groupId:"changes"};var v=false;var w=this.getProperty("newTextRule");var x=function(){D.setState(sap.ui.core.ValueState.Success);D.close();};var y=function(){var O=s.oData.predefinedResults;for(var Q in O){if(!O[Q].isAttributeinBackend){var U={RuleId:O[Q].RuleId,RuleVersion:O[Q].RuleVersion,Id:O[Q].Id};var W=o.createKey("/TextRuleResults",U);var X=new sap.ui.model.Context(o,W);o.deleteCreatedEntry(X);var Y=_.oData.TextRuleResultExpressions;for(var i=0;i<Y.length;i++){if(Y[i].ResultId==O[Q].Id){var Z={RuleId:O[Q].RuleId,RuleVersion:O[Q].RuleVersion,ResultId:O[Q].Id,ConditionId:Y[i].ConditionId};var W=o.createKey("/TextRuleResultExpressions",Z);var X=new sap.ui.model.Context(o,W);o.deleteCreatedEntry(X);}}}}};var z=function(){var P={};if(!j.getProperty("TextRule")){var i={RuleId:r,RuleVersion:R};P.properties=i;o.createEntry("/TextRules",P);}var O={RuleId:r,RuleVersion:R,Sequence:1,Type:"If"};P.properties=O;o.createEntry("/TextRuleConditions",P);};var F=function(O){var Q=O.Id;var U=_.oData.TextRuleResults;var P={};if(!m&&U){for(var i=0;i<U.length;i++){var W={RuleId:r,RuleVersion:R,ResultId:U[i].Id,ConditionId:Q,Expression:U[i].Expression};P.properties=W;o.createEntry("/TextRuleResultExpressions",P);}P={};P.success=x;P.groupId=u.groupId;o.submitChanges(P);}if(!m&&A){J();A=false;}};var G=function(i){var O=e.getModel("TextRuleModel").oData.enableElse;var Q=e.getProperty("enableElse");if(Q&&!O){var P={};var U={RuleId:r,RuleVersion:R,Sequence:i,Type:"Else"};P.properties=U;P.success=F;P.error=function(){console.log("Error creating TextRuleResultExpressions");};o.createEntry("/TextRuleConditions",P);}else if(!Q&&O){o.remove(_.oData.elseBindingPath,u);}};var H=function(){o.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:u.groupId,urlParameters:{RuleId:r,ResultDataObjectId:k}});};var J=function(){if(s.oData.predefinedResults){var i=s.oData.predefinedResults;var O;for(O in i){var Q=i[O].AccessMode;var U=i[O].Expression?i[O].Expression:"";o.callFunction("/SetPredefinedResultAttributes",{method:"POST",groupId:u.groupId,urlParameters:{RuleId:r,DataObjectAttributeId:O,AccessMode:Q,Expression:U}});}}};var K=function(){o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:u.groupId,urlParameters:{RuleId:r}});};if(s.getProperty("/refreshButtonClicked")){y();}if(w){v=true;z();}if(_.oData.ElseStatus=="U"){v=true;G(2);}if(!m&&A&&p){v=true;J();}else if(m){v=true;H();J();}var N=s.oData.needToRefresh;if(N){v=true;K();}var P={};P.success=x;P.groupId=u.groupId;if(v){o.submitChanges(P);return;}D.setState(sap.ui.core.ValueState.Success);D.close();};return t;},true);
