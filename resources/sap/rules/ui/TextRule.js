/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/m/Label","sap/rules/ui/RuleBase","sap/m/Panel","sap/ui/core/Title","sap/ui/layout/form/Form","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Button","sap/ui/layout/Grid","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/rules/ui/ExpressionAdvanced","sap/m/Link","sap/m/FlexBox","sap/m/Dialog","sap/rules/ui/TextRuleSettings"],function(q,l,L,R,P,T,F,a,b,c,B,G,d,e,E,f,g,D,h){"use strict";var j={vocabulary:"vocabulary",rule:"rule",verticalLayout:"verticalLayout"};var k=R.extend("sap.rules.ui.TextRule",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{"_toolbar":{type:"sap.m.Toolbar",multiple:false,singularName:"_toolbar"},"_verticalLayout":{type:"sap.ui.core.Control",multiple:false,visibility:"visible",singularName:"_verticalLayout"}}},_addToolBar:function(){var t=new a({design:"Transparent",enabled:"{TextRuleModel>/editable}"});var o=new sap.m.Title({text:this.oBundle.getText("textRule")});var s=new B({text:"",press:this._openTextRuleSettings.bind(this),visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("settings"));s.setIcon("sap-icon://action-settings");t.addContent(o);t.addContent(new b({}));t.addContent(s);t.addContent(new b({width:"1em"}));this.setAggregation("_toolbar",t,true);},_addTextRuleControl:function(){this.verticalLayout=new sap.ui.layout.VerticalLayout({width:"100%",busy:"{TextRuleModel>/busyVerticalLayoutState}"});this.setAggregation("_verticalLayout",this.verticalLayout,true);},_bindRule:function(){var i=[this._getBindModelName(),this.getBindingContextPath()].join("");this.bindElement({path:i,parameters:{expand:"TextRule"}});this.getElementBinding().attachDataRequested(this._handleRuleDataRequested,this);this.getElementBinding().attachDataReceived(this._handleRuleDataReceived,this);this.getElementBinding().refresh();},_bindVerticalLayout:function(){var v=this.getAggregation("_verticalLayout");var i=[this._getBindModelName(),this.getBindingContextPath(),"/TextRule/TextRuleConditions"].join("");v.bindAggregation("content",{path:i,parameters:{expand:"TextRuleResultExpressions"},factory:this._verticalLayoutFactory.bind(this)});v.getBinding("content").attachDataRequested(this._handleVerticalLayoutDataRequested,this);v.getBinding("content").attachDataReceived(this._handleVerticalLayoutDataReceived,this);},_createFormLayout:function(i,C,t){var p=new P({expandable:true,expanded:true,headerText:t,content:new F(i,{editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:4,emptySpanL:4,emptySpanM:4,emptySpanS:4,columnsL:1,columnsM:1}),formContainers:[this._createIfBlockFormContainer(C,t),this._createThenFormContainer(C,this.oBundle.getText("then"))]})});return p;},_createElseFormLayout:function(i,C,t){var p=new P({expandable:true,expanded:true,headerText:t,content:new F(i,{editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:4,emptySpanL:4,emptySpanM:4,emptySpanS:4,columnsL:1,columnsM:1}),formContainers:[this._createElseFormContainer(C,t)]})});return p;},_createIfBlockFormContainer:function(C,t){var i=C.getProperty("Expression");var m=new d({formElements:[new e({label:new L({text:""}),fields:[this._getExpressionAdvancedText(C,i)]})]});return m;},_createThenFormContainer:function(C,t){var i=new d({toolbar:new a({content:[new b({width:"2em"}),new L({text:t}).addStyleClass("sapTextRuleFontSize")]})});var m=[this.getBindingContextPath(),"/TextRule",C.getPath(),"/TextRuleResultExpressions"].join("");i.bindAggregation("formElements",{path:m,factory:this._formElementsFactory.bind(this)});return i;},_createElseFormContainer:function(C,t){this._settingsModel.oData.elseBindingPath=C.getPath();var i=new d({});var m=[this.getBindingContextPath(),"/TextRule",C.getPath(),"/TextRuleResultExpressions"].join("");i.bindAggregation("formElements",{path:m,factory:this._formElementsFactory.bind(this)});return i;},_createTextRuleSettings:function(){var m=this._getModel();var C=this.getBindingContext();if(this._internalModel.getProperty("/newTextRule")){this._internalModel.setProperty("/enableElse",false);}var t=new h({expressionLanguage:this.getExpressionLanguage(),enableElse:this._internalModel.getProperty("/enableElse"),newTextRule:this._internalModel.getProperty("/newTextRule")});var s=JSON.stringify(this._settingsModel.getData());var i=JSON.parse(s);var n=new sap.ui.model.json.JSONModel(i);t.setModel(n);t.setModel(this._internalModel,"TextRuleModel");t.setModel(m,"oDataModel");t.setBindingContext(C,"dummy");return t;},_dataPartReceived:function(p){this.dataReceived[p]=true;if(!this._isAllDataReceived()){return;}this._updateBusyState();this._dataLoaded.resolve();},_dataPartRequested:function(p){this.dataReceived[p]=false;this._setDataLoadedPromise();this._updateBusyState();},_decideSettingsEnablement:function(i,m){return i&&m;},_formElementsFactory:function(i,C){var r=C.getProperty("ResultId"),m=C.getProperty("RuleId"),v=C.getProperty("RuleVersion"),p,A,V=true;var H={RuleId:m,Id:r,RuleVersion:v};var n=C.getProperty("Expression");var o=C.getModel().createKey("/TextRuleResults",H);p=o.split("/")[1];this.getModel("settingModel").oData.TextRuleResults.push(C.getModel().oData[p]);p=C.sPath.split("/")[1];this.getModel("settingModel").oData.TextRuleResultExpressions.push(C.getModel().oData[p]);var s={parts:[{path:o+"/BusinessDataType"}],formatter:function(w){return w;}};var t={parts:[{path:o+"/DataObjectAttributeName"}],formatter:function(w){return w;}};A={parts:[{path:o+"/AccessMode"}],formatter:function(w){return w;}};if(A=="Editable"){V=true;}else if(A=="Hidden"){V=false;}var u=new e({visible:V,label:new L({text:t,tooltip:t}),fields:[this._getExpressionAdvancedText(C,n,s)]});return u;},_getModel:function(){var m=this.getModelName();if(m){return this.getModel(m);}return this.getModel();},_getBindModelName:function(){var p="";var m=this.getModelName();if(m){p=m+">";}return p;},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise();}return this._dataLoaded.promise();},_getBlankContent:function(){var o=new L({text:this.oBundle.getText("startTextRule")});var s=new c();s.setText("\u00a0");var i=new f({enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTextRuleSettings,this]}).addStyleClass("sapTextRuleLink");var m=new g({justifyContent:"Center",items:[o,s,i],visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return m;},_getExpressionAdvancedText:function(C,i,m){var t=this;var o=sap.ui.getCore().byId(this.getExpressionLanguage());var s=m?m:sap.rules.ui.ExpressionType.NonComparison;var r=t._getConvertedExpression(i,false,C);var n=t._getExpressionFromParseResults(i,r);return new E({expressionLanguage:o,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:s,value:n,editable:"{TextRuleModel>/editable}",change:function(p){var S=p.getSource();var C=S.getBindingContext();var u=C.getPath();var r=t._getConvertedExpression(S.getValue(),true,C);var v=t._getExpressionFromParseResults(S.getValue(),r);t._updateModelExpression(u,C,v);}.bind(this)});},_updateModelExpression:function(p,C,i){C.getModel().setProperty(p+"/Expression",i,C,true);},_getConvertedExpression:function(i,m,C){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var r=this._formRuleData(C,i);var n;if(m){n=o.convertRuleToCodeValues(r);}else{n=o.convertRuleToDisplayValues(r);}return n;},_formRuleData:function(C,i){var m=this.getBindingContextPath();var r=m.split("/")[2];var o=C.getProperty("RuleId");var v=C.getProperty("Version");var n=q.extend({},this.getModel().oData);n=n[r];if(!n){n={};}if(!n.DecisionTable){n.DecisionTable={};}n.Type="DT";n.DecisionTable.metadata={};n.DecisionTable.RuleID=o;n.DecisionTable.version=v;n.DecisionTable.HitPolicy="FM";n.DecisionTable.DecisionTableColumns={};n.DecisionTable.DecisionTableColumns.results=[];n.DecisionTable.DecisionTableColumns.results.push({"metadata":{},"RuleId":o,"Id":1,"Version":v,"Sequence":1,"Type":"CONDITION","Condition":{"metadata":{},"RuleId":o,"Id":1,"Version":v,"Expression":i,"Description":null,"ValueOnly":false,"FixedOperator":null},"Result":null});n.DecisionTable.DecisionTableRows={};n.DecisionTable.DecisionTableRows.results=[];n.DecisionTable.DecisionTableColumnsCondition={};n.DecisionTable.DecisionTableColumnsCondition.results=[];n.DecisionTable.DecisionTableColumnsResult={};n.DecisionTable.DecisionTableColumnsResult.results=[];return n;},_getExpressionFromParseResults:function(i,r){if(r.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted){return r.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted.Expression;}else{return i;}},_handleRuleDataRequested:function(){this._dataPartRequested(j.rule);},_handleRuleDataReceived:function(i){if(i){this._dataPartReceived(j.rule);}},_handleVerticalLayoutDataReceived:function(o){var i=o.getParameter("data");if(!i){return;}var v=this.getAggregation("_verticalLayout");if(i.results&&i.results.length==0){var m=this._getBlankContent();v.addContent(m);this._internalModel.setProperty("/newTextRule",true);}else{this._internalModel.setProperty("/newTextRule",false);}this._dataPartReceived(j.verticalLayout);},_handleVerticalLayoutDataRequested:function(o){this._dataPartRequested(j.verticalLayout);},_handleVocabularyDataChanged:function(o){var i=o.getParameter("data");if(i){this._handleVocabularyDataReceived(i);}else{this._handleVocabularyDataRequested();}},_handleVocabularyDataRequested:function(){this._dataPartRequested(j.vocabulary);},_handleVocabularyDataReceived:function(i){if(i){this._dataPartReceived(j.vocabulary);}},_initDataReceieved:function(){var v=false;var o=sap.ui.getCore().byId(this.getExpressionLanguage());if(o&&o._isDataExist()){v=true;}this.dataReceived={vocabulary:v,rule:false,verticalLayout:false};},_initInternalModel:function(){var i={};i.editable=this.getEditable();i.newTextRule=true;i.busyState=true;i.enableSettings=true;i.busyVerticalLayoutState=true;i.enableElse=false;this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"TextRuleModel");},_initDisplayModel:function(){this._settingsModel=new sap.ui.model.json.JSONModel();this.setModel(this._settingsModel,"settingModel");},_isAllDataReceived:function(){var i=this.dataReceived;return i.rule&&i.verticalLayout&&i.vocabulary;},_openTextRuleSettings:function(){var t=this._createTextRuleSettings();var o=new D({contentWidth:"70%",title:this.oBundle.getText("textRuleSettings")});o.addContent(t);var m=t.getButtons(o);for(var i=0;i<m.length;i++){o.addButton(m[i]);}o.attachBeforeClose(function(n){var p=o.getState();if(p===sap.ui.core.ValueState.Success){this._initDisplayModel();this._readTextRuleResults(true);}o.destroy();},this);o.open();},_readTextRuleResults:function(i){var t=this;var p=this.getBindingContextPath();var m=[p,"/TextRule/TextRuleResults"].join("");var M=this._getModel();if(p&&M){M.read(m,{success:function(n){t.getModel("settingModel").oData.TextRuleResults=[];t.getModel("settingModel").oData.TextRuleResultExpressions=[];if(i){var o=sap.ui.getCore().getEventBus();o.publish("sap.ui.rules","refreshTextRuleModel");t._resetControl();}},error:function(){console.log("Error reading TextRuleResults");}});}},_resetControl:function(){this._unbindRule();this._unbindVerticalLayout();this._initDataReceieved();this._updateBusyState();this._internalModel.setProperty("/enableElse",false);var m=this._getModel();var i=this.getBindingContextPath();if(!i||!m){return;}var s=i.split("'");this._settingsModel.oData.ProjectId=s[1];this._settingsModel.oData.ProjectVersion=s[3];this._settingsModel.oData.RuleId=s[5];this._settingsModel.oData.RuleVersion=s[7];this._settingsModel.oData.ruleBindingPath=i;this._settingsModel.oData.TextRuleResults=[];this._settingsModel.oData.TextRuleResultExpressions=[];var C=new sap.ui.model.Context(m,i);this.setBindingContext(C);this._bindRule();this._bindVerticalLayout();},_setDataLoadedPromise:function(){if(!this._dataLoaded||this._dataLoaded.state()!=="pending"){this._dataLoaded=new q.Deferred();}},_updateBusyState:function(){var i=this.dataReceived;var m=i.rule&&i.verticalLayout&&i.vocabulary;var n=!m;this._internalModel.setProperty("/busyState",n);var V=!i.verticalLayout;this._internalModel.setProperty("/busyVerticalLayoutState",V);},_unbindRule:function(){this.unbindElement();},_unbindVerticalLayout:function(){var v=this.getAggregation("_verticalLayout");v.unbindAggregation("content");},_verticalLayoutFactory:function(i,C){var t=C.getProperty("Type");var m;switch(t){case this.typeIf:m=this.oBundle.getText("if");return this._createFormLayout(i,C,m);case this.typeElseIf:m=this.oBundle.getText("elseIf");this._internalModel.setProperty("/enableElseIf",true);return this._createFormLayout(i,C,m);case this.typeElse:m=this.oBundle.getText("else");this._internalModel.setProperty("/enableElse",true);return this._createElseFormLayout(i,C,m);default:break;}return null;},init:function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.typeIf=this.oBundle.getText("typeIf");this.typeElseIf=this.oBundle.getText("typeElseIf");this.typeElse=this.oBundle.getText("typeElse");this.resetContent=true;this._initInternalModel();this._initDataReceieved();this._initDisplayModel();this._addToolBar();this._addTextRuleControl();},onBeforeRendering:function(){this._readTextRuleResults(false);if(this.resetContent){this._resetControl();this.resetContent=false;}},setEnableSettings:function(v){this.setProperty("enableSettings",v,true);this._internalModel.setProperty("/enableSettings",v);return this;},setModelName:function(v){this.setProperty("modelName",v);this.resetContent=true;return this;},setExpressionLanguage:function(v){this.setAssociation("expressionLanguage",v,true);var i=(v instanceof Object)?v:sap.ui.getCore().byId(v);if(!i){return this;}var V=this.getAggregation("_verticalLayout");if(V){var m=V.getBinding("content");if(m){m.refresh();}}if(i._isDataExist()){var o=new sap.ui.base.Event("","",{data:true});this._handleVocabularyDataChanged(o);}i.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this;},setEditable:function(v){this.setProperty("editable",v,true);this._internalModel.setProperty("/editable",v);return this;},setBindingContextPath:function(v){var o=this.getBindingContextPath();if(v&&(o!==v)){this._unbindRule();this._unbindVerticalLayout();this._initDataReceieved();this.setProperty("bindingContextPath",v);this.resetContent=true;}return this;}});return k;},true);
