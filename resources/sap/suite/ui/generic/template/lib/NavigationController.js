/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/routing/HistoryDirection","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessagePage","sap/m/Link","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/testableHelper"],function(q,B,C,H,a,b,F,c,M,d,L,P,r,T,t){"use strict";var h=a.getInstance();function n(s){if(s.indexOf("/")===0){return s;}return"/"+s;}function f(o,R,i){var s=R.template;var E=R.entitySet;var v=R.viewLevel;var O=-1;if(o.oFlexibleColumnLayoutHandler){O=v<3?v:0;}var j=O<0?o.oNavigationObserver:o.aNavigationObservers[O];var k=new P();var m=O<0?o.oHeaderLoadingObserver:o.aHeaderLoadingObservers[O];m.addObserver(k);var p={};var S={appComponent:o.oAppComponent,isLeaf:!R.pages||!R.pages.length,entitySet:E,navigationProperty:R.navigationProperty,componentData:{registryEntry:{componentCreateResolve:i,route:R.name,routeConfig:R,viewLevel:v,routingSpec:R.routingSpec,oNavigationObserver:j,oHeaderLoadingObserver:k,preprocessorsData:p}}};if(R.component.settings){q.extend(S,R.component.settings);}var u;o.oAppComponent.runAsOwner(function(){try{var w=sap.ui.component({name:s,settings:S,handleValidation:true,async:true});var x;u=new C({propagateModel:true,width:"100%",height:"100%",settings:S});x=w.then(function(y){u.setComponent(y);return u;});u.loaded=function(){return x;};}catch(e){throw new Error("Component "+s+" could not be loaded");}});return u;}function g(o,e){t.testable(f,"fnCreateComponentInstance");var m={};var p={iHashChangeCount:0,backTarget:0};var s=[];var A=Promise.resolve();var u=[];var v=[];var w=[];function G(){var i=e.oRouter,j=i.getTargets()._mTargets,k=[];Object.keys(j).forEach(function(z1){var A1=j[z1],B1=A1._oOptions,C1=i.getRoute(B1.viewName),D1=C1&&C1._oConfig;if(D1&&(!D1.navigation||!D1.navigation.display)){k.push({oConfig:D1});}});return k;}t.testable(G,"fnGetAllPages");function x(i){var j=i||G();if(!Array.isArray(j)){j=[j];}j.forEach(function(k){k.oComponentContainer=f(o,k.oConfig,function(){});});return j;}t.testable(x,"fnCreatePages");function y(){var i=e.oRouter.getViews();i.getView({viewName:"root"});return o.mRouteToTemplateComponentPromise.root;}function z(){return e.oAppComponent.getManifestEntry("sap.app").title;}function D(){return p.iHashChangeCount;}function E(i,j,k){var z1=function(D1){q.extend(j,D1);};for(var A1 in o.componentRegistry){var B1=o.componentRegistry[A1];if(B1.route===i){var C1=B1.methods.getUrlParameterInfo;return C1?C1(k).then(z1):Promise.resolve();}}return Promise.resolve();}function I(j,k){var z1=k?E("root",j):Promise.resolve();return z1.then(function(){var A1="";var B1="";for(var C1 in j){var D1=j[C1];for(var i=0;i<D1.length;i++){var E1=D1[i];B1=B1+A1+C1+"="+E1;A1="&";}}return B1;});}function J(i,j){var z1=location.hash.split("&")[0]+"&/";for(var k=0;k<j;k++){z1=z1+i[k];if(k<(j-1)){z1=z1+"/";}}return z1;}function K(j){for(var i=0;i<j.length;i++){if(j[i].title!==u[j.length-i-1]||""){j[i].subtitle=u[j.length-i-1]||"";}}v=j;o.oShellServicePromise.then(function(k){k.setHierarchy(j);});}function S(i,j){u[i]=j;var k=v[v.length-i-1];if(k){if(k.title!==j){k.subtitle=j;}o.oShellServicePromise.then(function(z1){z1.setHierarchy(v);});}}function O(i,j,k){var z1=j.headerTitle;var A1=j.titleIconUrl;var B1=o.oFlexibleColumnLayoutHandler.getFullscreenLayout(j.level);var C1=J(k,j.level)+"?"+"FCLLayout="+B1;var D1={title:z1,icon:A1,intent:C1};var E1=o.oTemplatePrivateGlobalModel.getProperty("/generic/FCL/isVisuallyFullScreen");if(j.level<3&&!E1){i.push(D1);}}var Q;function R(){var i,k,z1,A1;var B1=o.oApplicationProxy.getHierarchySectionsFromCurrentHash();if(Q&&Q instanceof T){var C1=Q.getProperty("entitySet");A1=e.oTemplateContract.mEntityTree[C1];}else{return;}var D1=[];var E1,F1;if(o.oFlexibleColumnLayoutHandler){E1=A1;}if(B1.length>0){if(o.oFlexibleColumnLayoutHandler){O(D1,E1,B1);}for(var j=0;j<B1.length-1;j++){if(A1.parent){var G1=e.oTemplateContract.mEntityTree[A1.parent];if(o.oFlexibleColumnLayoutHandler){F1=J(B1,G1.level)+"?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(G1.level);}else{F1=J(B1,G1.level);}i=G1.headerTitle;z1=G1.titleIconUrl;A1=G1;}else{if(o.oFlexibleColumnLayoutHandler){F1=J(B1,A1.level)+"?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(A1.level);}else{F1=J(B1,A1.level);}i=e.oTemplateContract.mEntityTree[A1.entitySet].headerTitle;z1=e.oTemplateContract.mEntityTree[A1.entitySet].titleIconUrl;}k={title:i,icon:z1,intent:F1};D1.push(k);}k={title:z()};k.intent=location.hash.split("&")[0];if(o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isListAndFirstEntryLoadedOnStartup()){k.intent=k.intent+"&/?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(0);}I({},true).then(function(H1){if(H1){if(o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isListAndFirstEntryLoadedOnStartup()){k.intent=k.intent+"&"+H1;}else{k.intent=k.intent+"&/?"+H1;}}D1.push(k);K(D1);});}}function U(i,j){var k;if(!i&&j instanceof T){var z1=j&&o.componentRegistry[j.getId()];var A1=z1&&z1.methods.getTitle;k=A1&&A1();}else if(!i&&j&&j.title){k=j.title;}k=k||z();Q=j;o.oShellServicePromise.then(function(B1){B1.setTitle(k);R();});}function V(j,k){var z1;var A1=[];for(var i=0;i<=k;i++){var B1=j[i];if(B1){if(z1){A1.push(B1);}else{z1=B1;}}}if(z1){z1.resume(A1);}}function W(i){var j=[o.oPagesDataLoadedObserver.getProcessFinished(true)];var k=null;var z1=p.iHashChangeCount;var A1=-1;var B1={};for(var C1 in o.componentRegistry){var D1=o.componentRegistry[C1];var E1=D1.oControllerRegistryEntry&&D1.oControllerRegistryEntry.oTemplateUtils.oServices.oTemplateCapabilities.oMessageButtonHelper;var F1=D1.activationTakt===z1;var G1=D1.utils.getTemplatePrivateModel();G1.setProperty("/generic/isActive",F1);if(F1){j.push(D1.oViewRenderedPromise);if(D1.viewLevel>A1){A1=D1.viewLevel;k=D1.oComponent;}B1[D1.viewLevel]=E1;}else{D1.utils.suspendBinding();if(E1){E1.suspend();}}}V(B1,A1);var H1=o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isAppTitlePrefered();U(H1,i||k);Promise.all(j).then(function(){if(z1===p.iHashChangeCount&&q.isEmptyObject(m)){o.oAppComponent.firePageDataLoaded();}});}var X=W.bind(null,null);function Y(){q.sap.log.info("Navigate back");if(p.backTarget&&n(h.getPreviousHash()||"")!==n(p.hash)){o.oBusyHelper.setBusyReason("HashChange",true);}p.LeaveByBack=true;window.history.back();}function Z(i,j){i=n(i||"");q.sap.log.info("Navigate to hash: "+i);if(i===p.hash){q.sap.log.info("Navigation suppressed since hash is the current hash");return;}o.oBusyHelper.setBusyReason("HashChange",true);p.targetHash=i;if(p.backTarget&&n(h.getPreviousHash()||"")===i){Y();return;}p.LeaveByReplace=j;if(j){e.oHashChanger.replaceHash(i);}else{e.oHashChanger.setHash(i);}}function $(i,j,k,z1){var A1=j.then(function(B1){if(B1){i=i+"?"+B1;}if(z1){p.backwardingInfo={backCount:z1.backCount,targetViewLevel:z1.targetViewLevel,targetHash:n(i)};Y();}else{Z(i,k);}return i;});o.oBusyHelper.setBusy(A1);return A1;}function _(i){var j=0;for(var k=p;k.oEvent;){var z1=k.oEvent.getParameter("config").viewLevel;if(z1===0){return j;}if(i&&j>0){return-1;}j++;k=s[k.backTarget];}return-1;}function a1(i,j,k){if(k===0){var z1=_(!i);return(z1>0)&&{backCount:z1,targetViewLevel:0};}var A1=s[p.backTarget];return A1&&A1.hash&&n(A1.hash.split("?")[0])===n(j)&&{backCount:1};}function b1(i){if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.setStoredTargetLayoutToOneColumn();}g1("root","",0,i);}function c1(i){var j=o.mEntityTree[i.entitySet].sRouteName;var k=o.mRouteToTemplateComponentPromise[j];return[k];}function d1(j,k){var z1=p.iHashChangeCount;var A1=function(C1){var D1=o.componentRegistry[C1.getId()];(D1.methods.presetDisplayMode||q.noop)(k,z1===D1.activationTakt);};for(var i=0;i<j.length;i++){var B1=j[i];B1.then(A1);}}function e1(i){var j=i&&o.mEntityTree[i.entitySet];var k=j?j.level:1;return k;}function f1(j,k){var z1=o.oApplicationProxy.getHierarchySectionsFromCurrentHash();var A1=j;for(var i=k-2;i>=0;i--){A1=z1[i]+"/"+A1;}return"/"+A1;}function g1(i,j,k,z1){var A1={};var B1=new Promise(function(C1){E(i,A1,j).then(function(){var D1=o.oFlexibleColumnLayoutHandler?o.oFlexibleColumnLayoutHandler.getAppStateParStringForNavigation(k,A1):I(A1,false);var E1=a1(z1,j,k);$(j,D1,z1,E1).then(C1);});});o.oBusyHelper.setBusy(B1);return B1;}function h1(i,j,k,z1){var A1=f1(i,j);g1(k,A1,j,z1);}function i1(i,j,k,z1,A1){var B1;var C1,D1;var E1=[];if(typeof i==="string"){B1=i;D1=n(B1).split("/").length-1;}else{C1=r.determineNavigationPath(i,j);D1=e1(C1);B1=C1.path;E1=c1(C1);}if(B1){if(j){B1=f1(B1,D1);}d1(E1,z1||0);if(A1){var F1="";var G1="&";for(var H1 in A1){F1=F1+G1+H1+"="+A1[H1];G1="&";}if(F1){B1=B1+"?"+F1;}Z(B1,k);return Promise.resolve(B1);}else{var I1=C1&&o.mEntityTree[C1.entitySet].sRouteName;return g1(I1,B1,D1,k);}}}function j1(i,j,k,z1){return i1(i,j,k,z1);}function k1(i){var j=p.iHashChangeCount;p.iHashChangeCount++;s.push(null);if(i){for(var k in o.componentRegistry){var z1=o.componentRegistry[k];if(z1.activationTakt===j&&i[z1.viewLevel]){z1.activationTakt=p.iHashChangeCount;}}}return{iHashChangeCount:p.iHashChangeCount};}function l1(i){var j,k,z1,A1,B1,C1=null,D1,E1;if(i){j=i.entitySet;k=i.text;C1=i.icon;E1=i.description;}if(j){D1=o.oAppComponent.getModel().getMetaModel();if(D1){z1=D1.getODataEntitySet(j);A1=D1.getODataEntityType(z1.entityType);B1=A1["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(B1&&B1.TypeImageUrl&&B1.TypeImageUrl.String){C1=B1.TypeImageUrl.String;}}o.oShellServicePromise.then(function(H1){if(H1.setBackNavigation){H1.setBackNavigation(undefined);}});o.oTemplatePrivateGlobalModel.setProperty("/generic/messagePage",{text:k,icon:C1,description:E1});var F1;if(e.oTemplateContract.oFlexibleColumnLayoutHandler){F1=e.oTemplateContract.oFlexibleColumnLayoutHandler.displayMessagePage(i);}else{var G1=e.oRouter.getTargets();G1.display("messagePage");}k1(F1);W(i);}function m1(){if(!q.isEmptyObject(m)){var j=null;for(var i=0;!j;i++){j=m[i];}m={};l1(j);}}function n1(i){if(e.oTemplateContract.oFlexibleColumnLayoutHandler){i.viewLevel=i.viewLevel||0;m[i.viewLevel]=i;var j=Promise.all([A,e.oTemplateContract.oPagesDataLoadedObserver.getProcessFinished(true)]);j.then(m1);return;}l1(i);}function o1(){var i=[];var j=p.iHashChangeCount;for(var k in o.componentRegistry){var z1=o.componentRegistry[k];if(z1.activationTakt===j){i.push(k);}}return i;}function p1(){var i=[];for(var j in o.componentRegistry){i.push(j);}return i;}function q1(i){return w.slice(0,i+1);}function r1(i,j,k){var z1=o.componentRegistry[k.getId()]||{};var A1=(z1.activationTakt===j.iHashChangeCount-1);z1.activationTakt=j.iHashChangeCount;var B1;if(k&&k.onActivate){B1=k.onActivate(i,A1);}return B1||z1.viewRegisterd;}function s1(i,j,k){return r1(i,j,k).then(X);}function t1(i,j,k){var z1={};if(j||k){var A1=i.getParameter("config").viewLevel;for(var B1=0;B1<A1;B1++){z1[B1]=o.oPaginatorInfo[B1];}}o.oPaginatorInfo=z1;}function u1(i){return o.oApplicationProxy.getAlternativeContextPromise(i);}function v1(i){if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.handleBeforeRouteMatched(i);}}function w1(k,i){w=[""];for(var j=1;j<=i;j++){var z1="keys"+j;w.push(k[z1]);}}function x1(j){j=q.extend({},j);var k=j.getParameter("config").viewLevel;var z1=n(e.oHashChanger.getHash()||"");q.sap.log.info("Route matched with hash "+z1);var A1;if(p.backwardingInfo){A1=p;s.push(A1);var B1=A1.iHashChangeCount+1;p={iHashChangeCount:B1,forwardingInfo:{bIsProgrammatic:true,bIsBack:true,iHashChangeCount:B1,backCount:A1.backwardingInfo.backCount,targetHash:A1.backwardingInfo.targetHash,targetViewLevel:A1.backwardingInfo.targetViewLevel},backTarget:A1.backTarget};}if(p.forwardingInfo){if(p.forwardingInfo.backCount){p.backTarget=s[p.backTarget].backTarget;p.forwardingInfo.backCount--;if(p.forwardingInfo.backCount&&k!==p.forwardingInfo.targetViewLevel){p.hash=z1;Y();return;}delete p.forwardingInfo.backCount;}if(p.forwardingInfo.targetHash&&p.forwardingInfo.targetHash!==z1){p.hash=z1;var C1=p.forwardingInfo.targetHash;delete p.forwardingInfo.targetHash;Z(C1,true);return;}}var D1=false;for(var i=0;i<o.aStateChangers.length;i++){var E1=o.aStateChangers[i];if(E1.isStateChange(j)){D1=true;}}if(D1){p.hash=z1;R();return;}o.oTemplatePrivateGlobalModel.setProperty("/generic/routeLevel",k);var F1=p.forwardingInfo;delete p.forwardingInfo;if(!F1){F1={};var G1=p.iHashChangeCount;F1.iHashChangeCount=G1+1;F1.bIsProgrammatic=(z1===p.targetHash);F1.bIsBack=!!(p.LeaveByBack||(!F1.bIsProgrammatic&&(h.getDirection()===b.Backwards)));p.LeaveByBack=F1.bIsBack;p.LeaveByReplace=F1.bIsProgrammatic&&p.LeaveByReplace;A1=p;s.push(A1);p={iHashChangeCount:F1.iHashChangeCount};if(A1.LeaveByReplace){p.backTarget=A1.backTarget;}else if(F1.bIsBack){p.backTarget=s[A1.backTarget].backTarget;}else{p.backTarget=G1;}}p.oEvent=j;p.hash=z1;var H1=j.getParameter("config");var I1=r.determinePath(H1,j);var J1=k<2?I1:r.determinePath(H1,j,o.routeViewLevel1.pattern);u1(J1).then(function(K1){var L1=j.getParameter("arguments");if(K1){var M1=L1["?query"];p.forwardingInfo=F1;i1(K1.context,null,true,K1.iDisplayMode,M1||{});return;}w1(L1,k);K([]);t1(j,F1.bIsProgrammatic,F1.bIsBack);if(o.oFlexibleColumnLayoutHandler){A=o.oFlexibleColumnLayoutHandler.handleRouteMatched(j,H1,I1,F1);}else{if(H1.viewLevel===0||!(F1.bIsProgrammatic||F1.bIsBack)){o.oApplicationProxy.setEditableNDC(false);}var N1=H1.target;var O1=o.mRouteToTemplateComponentPromise[N1];A=new Promise(function(P1){O1.then(function(Q1){s1(I1,F1,Q1).then(P1);});});}A.then(o.oBusyHelper.setBusyReason.bind(null,"HashChange",false));});}function y1(){n1({title:o.getText("ST_ERROR"),text:o.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:""});}if(o.sRoutingType==="f"){e.oRouter.attachBeforeRouteMatched(v1);}e.oRouter.attachRouteMatched(x1);e.oRouter.attachBypassed(y1);e.navigate=Z;e.navigateToParStringPromise=$;e.activateOneComponent=r1;e.afterActivation=X;e.addUrlParameterInfoForRoute=E;e.getParStringPromise=I;e.performPseudoHashChange=k1;e.getActiveComponents=o1;e.getAllComponents=p1;e.getRootComponentPromise=y;e.getCurrenActivationTakt=D;e.getCurrentKeys=q1;e.getTargetLevel=e1;e.getAppTitle=z;e.subTitleForViewLevelChanged=S;e.navigateToSuffix=h1;return{navigateToRoot:b1,navigateToContext:j1,navigateToMessagePage:n1,navigateBack:Y};}function l(o,e){var i={oAppComponent:e.oAppComponent,oRouter:e.oAppComponent.getRouter(),oTemplateContract:e,oHashChanger:H.getInstance(),mRouteToComponentResolve:{}};e.oNavigationControllerProxy=i;var j=new Promise(function(R){i.fnInitializationResolve=R;});e.oBusyHelper.setBusy(j);q.extend(o,g(e,i));q.extend(i,o);var v={};i.oRouter._oViews._getViewWithGlobalId=function(V){if(!v[V.viewName]){var R=i.oRouter.getRoute(V.viewName);var k;if(R&&R._oConfig){k=f(e,R._oConfig,i.mRouteToComponentResolve[V.viewName]);}else{k=sap.ui.view({viewName:V.viewName,type:V.type,height:"100%"});}v[V.viewName]=k;if(V.viewName==="root"){e.rootContainer=k;}}return v[V.viewName];};r.startupRouter(i);}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(o){B.apply(this,arguments);t.testableStatic(l,"NavigationController")(this,o);}});N._sChanges="Changes";return N;});
