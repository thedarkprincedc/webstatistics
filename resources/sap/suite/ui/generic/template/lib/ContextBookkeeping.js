sap.ui.define(["jquery.sap.global","sap/ui/base/Object"],function(q,B){"use strict";function g(a){var p={};var P=[];function c(C){var D=a.getTransactionController().getDraftController();var i=D.getDraftContext();var s=C.getObject();var I=i.hasDraft(C);var t=I&&!s.IsActiveEntity;var u=t&&!s.HasActiveEntity;var v=false;if(s.DraftEntityCreationDateTime&&s.DraftEntityLastChangeDateTime){v=s.DraftEntityCreationDateTime.getTime()!==s.DraftEntityLastChangeDateTime.getTime();}return{bIsDraft:t,bIsDraftSupported:I,bIsCreate:u,bIsDraftModified:v};}function r(C,v){var s=C.getPath();var i=c(C);if(v===1&&!i.bIsCreate){P.push(s);}p[s]={oContextInfo:i,oContext:C};return i;}function b(){for(var i=P.length-1;i>=0;i--){var C=p[P[i]].oContext;if(C){return P[i];}}}function d(C){var s=C.getPath();var R=p[s];return R;}function e(C,R,i){var s=d(C);if(!s.oContextInfo.bIsCreate||!i){s.oRemovalPromise=R;}R.then(function(t){if(!s.oContextInfo.bIsCreate||!i){var D=t.context.getPath();var u=p[D];if(u){delete u.oEditingPromise;}}s.oContext=null;},function(){delete s.oRemovalPromise;});}function f(C,i){e(C,i,false);}function h(C,i){e(C,i,true);}function j(C,E){var i=d(C);i.oEditingPromise=new Promise(function(R,s){var N=function(){delete i.oEditingPromise;s();};E.then(function(t){if(t.draftAdministrativeData){N();}else{R(t);}},N);});i.oEditingPromise.catch(q.noop);}function A(s){var C=p[s];if(C){C.oContext=null;}}function k(M,s){return new Promise(function(R,i){M.read(s+"/SiblingEntity",{success:function(t){var u=M.getContext("/"+M.getKey(t));R(u);},error:function(E){i(E);}});});}function l(C){var i=d(C);if(i.oContextInfo.bIsCreate){return Promise.resolve();}var s=i.oSiblingPromise;if(!s){s=i.oContextInfo.bIsDraftSupported?k(C.getModel(),C.getPath()):Promise.resolve(C);if(i.oContextInfo.bIsDraft||!i.oContextInfo.bIsDraftSupported){i.oSiblingPromise=s;}}return s;}function m(s){var C=p[s];if(!C){return Promise.resolve();}return new Promise(function(R){var i=null;var t=function(){R(i);};var H=function(E){E.then(function(u){var v=u.context.getPath();var w=p[v];if(!w||w.oContext){i={context:u.context,iDisplayMode:2};}t();},t);};if(C.oRemovalPromise){C.oRemovalPromise.then(function(u){i={context:u.context,iDisplayMode:1};var D=u.context.getPath();var v=p[D];var E=v&&v.oEditingPromise;if(E){H(E);}else{t();}},t);}else if(C.oEditingPromise){H(C.oEditingPromise);}else{t();}});}function n(s){if(p[s]){p[s].oContextInfo.bIsDraftModified=true;}}function o(s){return p[s].oContextInfo.bIsDraftModified;}return{registerContext:r,adaptAfterObjectDeleted:A,activationStarted:f,cancellationStarted:h,editingStarted:j,getDraftSiblingPromise:l,getAlternativeContextPromise:m,getPathOfLastShownDraftRoot:b,markDraftAsModified:n,getIsDraftModified:o};}return B.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(a){q.extend(this,g(a));}});});
