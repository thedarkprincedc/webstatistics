sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState"],function(q,B,N,S,U){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function g(s,c,o){var b=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var e=false;var h=null;var A=Promise.resolve();var D=false;var j=false;var E=c.byId("editStateFilter");var k;var l=null;var m=null;s.oSmartFilterbar.setSuppressSelection(true);var p=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function t(){return D;}function u(){var T={};T[d]={};var V=[];var W=p();for(var i=0;i<W.length;i++){var X=W[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(X)){V.push(X);}}T[a]={suppressDataSelection:!D,visibleCustomFields:V};if(E){T[a].editStateFilter=E.getSelectedKey();}var Y=s.oMultipleViewsHandler&&s.oMultipleViewsHandler.getContentForIappState();if(Y){var Z=Y.mode==="single"?"tableViewData":"tableTabData";T[a][Z]=Y.state;}c.getCustomAppStateDataExtension(T[d]);return T;}function v(){var T=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var V=new S(T);var W=c.getVisibleSelectionsWithDefaults();for(var i=0;i<W.length;i++){if(!V.getValue(W[i])){V.addSelectOption(W[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&V.getID()){V.setID("");}var X={selectionVariant:V.toJSONString(),tableVariantId:(!b&&s.oSmartTable.getCurrentVariantId())||"",customData:u()};return X;}function w(){if(!j){return;}j=false;try{l=o.storeInnerAppStateWithImmediateReturn(v(),true);}catch(i){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(l instanceof N){j=true;l=null;return;}l.promise.fail(function(T){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+T);});if(m===l.appStateKey){l=null;}else{o.replaceHash(l.appStateKey);}}function R(T,V){if(T&&T.editStateFilter!==undefined){if(E){E.setSelectedKey((T.editStateFilter===null)?0:T.editStateFilter);}}var W=T&&T.visibleCustomFields;if(W&&W.length>0){var X=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<X.length;i++){var Y=X[i];var Z=Y.getName();if(W.indexOf(Z)!==-1){Y.setVisibleInFilterBar(true);}}}D=V&&!(T&&T.suppressDataSelection);if(D){s.oSmartFilterbar.search();Q(D);}}function x(i){c.restoreCustomAppStateDataExtension(i||{});}function y(i,T){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(a)){x(i[d]);R(i[a],T);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}x(i);}}function z(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function C(i,T){if(e){return;}if(i||T!==D){D=T;if(!j){j=true;if(!s.oSmartFilterbar.isDialogOpen()){if(h){w();}else{setTimeout(w,0);}}}}}function F(T,V,W,X){s.oSmartFilterbar.setSuppressSelection(false);var Y=V.appStateKey||"";if(e){return;}if(m===null){m=Y;}else if(Y!==m){return;}e=true;var Z=V.selectionVariant||"";var $=(!b&&V.tableVariantId)||"";var _=(!Y&&W)||{};if(!s.bWorkListEnabled){if((r.appStateKey!==Y||r.selectionVariant!==Z||r.tableVariantId!==$||f(r.urlParams,_))&&X!==sap.ui.generic.app.navigation.service.NavType.initial){if(!l||l.appStateKey!==Y){var a1=V&&V.bNavSelVarHasDefaultsOnly;if(V.oSelectionVariant&&r.selectionVariant!==Z){var b1=V.oSelectionVariant.getParameterNames().concat(V.oSelectionVariant.getSelectOptionsPropertyNames());for(var i=0;i<b1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(b1[i]);}}var c1=new U({selectionVariant:V.oSelectionVariant.toJSONObject()});V.oUiState=c1;if(a1&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.setUiState(c1,{bReplace:false,bStrictMode:false});}else if(!a1||s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setUiState(c1,{bReplace:true,bStrictMode:false});}if($!==r.tableVariantId){s.oSmartTable.setCurrentVariantId($);}V.customData=V.customData||{};var d1=s.oMultipleViewsHandler&&s.oMultipleViewsHandler.getMode();if(d1){var e1=d1==="single"?"tableViewData":"tableTabData";if(V.customData[a]&&V.customData[a][e1]){s.oMultipleViewsHandler.restoreFromIappState(V.customData[a][e1]);}}y(V.customData,true);}r={appStateKey:Y,urlParams:_,selectionVariant:Z,tableVariantId:$};}}if(h){h();h=null;}if(X!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var f1=(X===sap.ui.generic.app.navigation.service.NavType.xAppState||X===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!V.bNavSelVarHasDefaultsOnly;D=f1||s.bLoadListAndFirstEntryOnStartup||k||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(D){s.oSmartFilterbar.search();Q(D);}}l=null;T();e=false;}function P(){if(!h){A=new Promise(function(T){h=T;});}var i=new Promise(function(T,V){var W=o.parseNavigation();W.done(F.bind(null,T));W.fail(V);});return i;}function G(){var i=v();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function H(){C(true,D);}function J(i){var T=i.getParameter("context");var V=s.oSmartFilterbar.getFilterData();if(V._CUSTOM!==undefined){y(V._CUSTOM);}else{var W=u();n(W[d]);n(W[a]);y(W);}if(I.indexOf(T)<0){D=i.getParameter("executeOnSelect");C(true,D);}}function K(){if(!b){C(true,D);}}function L(){if(!b){C(true,D);}}function M(i){var T=i.getParameter("arguments");var V=T&&T["?query"];m=(V&&V["sap-iapp-state"])||"";if(l){if(l.appStateKey!==m){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+m+" expected "+l.appStateKey);return false;}P();return true;}return false;}function O(){k=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(w);}function Q(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var T=c.getOwnerComponent().getModel("_templPriv");if(D){T.setProperty("/listReport/isHeaderExpanded",false);}else{T.setProperty("/listReport/isHeaderExpanded",true);}}}s.getCurrentAppState=v;return{areDataShownInTable:t,parseUrlAndApplyAppState:P,getUrlParameterInfo:z,changeIappState:C,onSmartFilterBarInitialise:O,onBeforeSFBVariantFetch:G,onAfterSFBVariantSave:H,onAfterSFBVariantLoad:J,onAfterTableVariantSave:K,onAfterApplyTableVariant:L,isStateChange:M};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,o){q.extend(this,g(s,c,o));}});});
