sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/m/MessageBox","sap/suite/ui/generic/template/js/AnnotationHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/ui/model/Filter","sap/ui/comp/navpopover/LinkData"],function(q,J,O,T,a,S,b,E,M,A,c,I,d,F,L){"use strict";return{getMethods:function(v,t,C){var s={};var e=true;var f;var w=null;function g(){var i=C.getOwnerComponent();var r=t.oComponentUtils.getTemplatePrivateModel();r.setProperty("/listReport/isLeaf",i.getIsLeaf());}function h(){var G=q.sap.getObject("sap.ushell.Container.getUser");var i=C.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var B=(i&&i.icons&&i.icons.icon)||"";var r={bookmarkIcon:B,bookmarkCustomUrl:function(){var H=hasher.getHash();return H?("#"+H):window.location.href;},bookmarkServiceUrl:function(){var y=s.oSmartTable.getTable();var z=y.getBinding("rows")||y.getBinding("items");return z?z.getDownloadUrl()+"&$top=0&$inlinecount=allpages":"";},isShareInJamActive:!!G&&G().isJamActive()};var x=t.oComponentUtils.getTemplatePrivateModel();x.setProperty("/listReport/share",r);}function o(i){C.onInitSmartFilterBarExtension(i);s.oIappStateHandler.onSmartFilterBarInitialise();}function j(){var i=s.oIappStateHandler.parseUrlAndApplyAppState();i.then(function(){e=false;},function(r){if(r instanceof Error){r.showMessageBox();e=false;}});}function k(){if(!e){s.oIappStateHandler.changeIappState(true,false);}}function u(i){var r=C.getOwnerComponent().getModel(),x=t.oComponentUtils.getTemplatePrivateModel();var y=r.getMetaModel(),z=y.getODataEntitySet(C.getOwnerComponent().getEntitySet()),D=z["Org.OData.Capabilities.V1.DeleteRestrictions"];var B=false;if(sap.suite.ui.generic.template.js.AnnotationHelper.areDeleteRestrictionsValid(y,z.entityType,D)){var G=D&&D.Deletable&&D.Deletable.Path;var H=t.oCommonUtils.getSelectedContexts(i);B=H.some(function(K){var N=r.getObject(K.getPath()+"/DraftAdministrativeData");var P=!(N&&N.InProcessByUser&&!N.DraftIsProcessedByMe);return P&&!(G&&!r.getProperty(G,K));});}x.setProperty("/listReport/deleteEnabled",B);t.oCommonUtils.setEnabledToolbarButtons(i);if(!t.oCommonUtils.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function l(i){var r=i.getParameters();var x=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(x,r);}function m(i){var r,x;r=i.getParameters();x=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(x,r,s,undefined,undefined);}function n(i){var r,x,y,D,z,B;r=i.getParameters().mainNavigation;z=i.getParameters();B=i.getSource();if(r){x=B.getText&&B.getText();y=t.oCommonUtils.getCustomData(i);if(y&&y["LinkDescr"]){D=y["LinkDescr"];r.setDescription(D);}}B=B.getParent().getParent().getParent().getParent();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(B,z,s,x,r);}function p(r){var x=v.getItems();for(var i=0;i<x.length;i++){if(!r||x[i].getBindingContextPath()===r){return x[i];}}}return{onInit:function(){var i=C.getOwnerComponent().getAppComponent();var r=i.getConfig();s.bWorkListEnabled=!!r.pages[0].component.settings&&r.pages[0].component.settings.isWorklist||false;s.oSmartFilterbar=C.byId("listReportFilter");s.oSmartTable=C.byId("listReport");s.updateControlOnSelectionChange=u;f=t.oServices.oApplication.getFclProxyForView(0);s.bLoadListAndFirstEntryOnStartup=f&&f.isListAndFirstEntryLoadedOnStartup&&f.isListAndFirstEntryLoadedOnStartup();s.oMultipleViewsHandler=new d(s,C,t);s.oIappStateHandler=new I(s,C,t.oCommonUtils.getNavigationHandler());t.oServices.oApplication.registerStateChanger({isStateChange:s.oIappStateHandler.isStateChange});v.getUrlParameterInfo=s.oIappStateHandler.getUrlParameterInfo;v.getItems=function(){var y=s.oSmartTable.getTable();if(t.oCommonUtils.isUiTable(y)){return y.getRows();}return y.getItems();};v.displayNextObject=function(y){return new Promise(function(z,B){w={aWaitingObjects:y,resolve:z,reject:B};});};v.onComponentActivate=function(){if(!e){s.oIappStateHandler.parseUrlAndApplyAppState();}};v.refreshBinding=function(){if(s.oIappStateHandler.areDataShownInTable()){t.oCommonUtils.refreshSmartTable(s.oSmartTable);}};g();h();C.byId("template::FilterText").attachBrowserEvent("click",function(){C.byId("page").setHeaderExpanded(true);});var x=t.oComponentUtils.getTemplatePrivateModel();x.setProperty("/listReport/isHeaderExpanded",true);x.setProperty("/listReport/deleteEnabled",false);if(s.bWorkListEnabled){s.oSmartFilterbar.setSuppressSelection(false);s.oSmartFilterbar.search();}},handlers:{addEntry:function(i){var r=i.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(r,false,s.oSmartFilterbar);},q.noop,s);},deleteEntries:function(i){t.oCommonEventHandlers.deleteEntries(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},onSelectionChange:function(i){var r=i.getSource();u(r);},onChange:function(i){t.oCommonEventHandlers.onChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onBreadCrumbUrlPressed:function(i){t.oCommonEventHandlers.onBreadCrumbUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:o,onSmartFilterBarInitialized:j,onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(r){t.oCommonEventHandlers.onDataReceived(r);var x=s.oMultipleViewsHandler.getImplementingHelper();if(x&&typeof x.setTableDirty==='function'){x.setTableDirty(s.oSmartTable,false);}if(w){var y;var z=false;for(var i=0;i<w.aWaitingObjects.length&&!z;i++){y=p(w.aWaitingObjects[i]);if(y){t.oCommonEventHandlers.onListNavigate(y,s);w.resolve();z=true;}}if(!z){y=p();if(y){t.oCommonEventHandlers.onListNavigate(y,s);w.resolve();}else{w.reject();}}w=null;return;}var B=r.getSource().getTable();f.handleDataReceived(B,s,t);},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder});C.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl(i);},onShowDetails:function(i){t.oCommonEventHandlers.onShowDetails(i.getSource(),s);},onListNavigate:function(i){if(!C.onListNavigationExtension(i)){t.oCommonEventHandlers.onListNavigate(i.getSource(),s);}},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkPopoverOpens:function(i){var r=i.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var x=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());t.oCommonUtils.semanticObjectLinkNavigation(r,x,C);},q.noop,s,q.noop);},onSemanticObjectLinkNavigationPressed:l,onSemanticObjectLinkNavigationTargetObtained:m,onSemanticObjectLinkNavigationTargetObtainedSmartLink:n,onDraftLinkPressed:function(i){var B=i.getSource();var r=B.getBindingContext();t.oCommonUtils.showDraftPopover(r,B);},onAssignedFiltersChanged:function(i){if(i.getSource()){C.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:k,onToggleFiltersPressed:function(){var i=t.oComponentUtils.getTemplatePrivateModel();i.setProperty("/listReport/isHeaderExpanded",!i.getProperty("/listReport/isHeaderExpanded"));},onSearchButtonPressed:function(){t.oCommonUtils.refreshModel(s.oSmartTable);s.oIappStateHandler.changeIappState(false,true);},onSemanticObjectLinkPopoverLinkPressed:function(i){t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(i,s);},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!e){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!e){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){t.oCommonEventHandlers.onBeforeRebindChart(i);C.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl(i);},onChartInitialise:function(i){s.oMultipleViewsHandler.fnRegisterToChartEvents(i);s.oMultipleViewsHandler.init(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){var r=t.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.lists.ShareSheet",{shareEmailPressed:function(){sap.m.URLHelper.triggerEmail(null,t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]),document.URL);},shareJamPressed:function(){var y=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:t.oServices.oApplication.getAppTitle()}}});y.open();}},"share",function(y,z){var R=sap.ui.getCore().getLibraryResourceBundle("sap.m");z.setProperty("/emailButtonText",R.getText("SEMANTIC_CONTROL_SEND_EMAIL"));z.setProperty("/jamButtonText",R.getText("SEMANTIC_CONTROL_SHARE_IN_JAM"));z.setProperty("/bookmarkButtonText",R.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var G=q.sap.getObject("sap.ushell.Container.getUser");z.setProperty("/jamVisible",!!G&&G().isJamActive());});r.openBy(i.getSource());var x=this.getView().byId("template::Share");var B=this.getView().byId("bookmarkButton");B.setBeforePressHandler(function(){x.focus();});},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oSmartTable.getTable());},onDeterminingDataFieldForIntentBasedNavigation:function(i){var B=i.getSource();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(B,s.oSmartTable.getTable(),s);},onTableInit:function(i){var r=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(r);s.oMultipleViewsHandler.init(i);},onSearchWorkListLight:function(i){var r=s.oSmartTable;r.data("searchString",i.getSource().getValue());r.data("allowSearchWorkListLight",true);r.rebindTable();var x=C.getOwnerComponent().getModel();var R=function(i){c.handleError("getCollection",C,t.oServices,i.getParameters());s.oSmartTable.getTable().setBusy(false);c.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,C.getView()));};x.attachEvent('requestFailed',R);x.attachEventOnce('requestCompleted',function(){x.detachEvent('requestFailed',R);});},onWorkListLightTableSort:function(i){var r=s.oSmartTable;if(r){r.openPersonalisationDialog("Sort");}},onWorkListLightTableFilter:function(){var i=s.oSmartTable;if(i){i.openPersonalisationDialog("Filter");}},onWorkListLightTableGroup:function(){var i=s.oSmartTable;if(i){i.openPersonalisationDialog("Group");}},onWorkListLightTableColumns:function(){var i=s.oSmartTable;if(i){i.openPersonalisationDialog("Columns");}}},formatters:{formatDraftType:function(D,i,H){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerType.Draft;}else if(H){return D.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(D,i){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(D){if(D&&D.DraftUUID){return true;}return false;},formatDraftOwner:function(D,H){var i="";if(D&&D.DraftUUID&&H){var U=D.InProcessByUserDescription||D.InProcessByUser||D.LastChangedByUserDescription||D.LastChangedByUser;if(U){i=t.oCommonUtils.getText("ST_DRAFT_OWNER",[U]);}else{i=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return i;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";}},extensionAPI:new E(t,C,s)};}};});
