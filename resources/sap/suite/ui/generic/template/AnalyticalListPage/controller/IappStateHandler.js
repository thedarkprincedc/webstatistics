sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/Device"],function(q,B,S,F,D){"use strict";function g(s,c,n){var a="sap.suite.ui.generic.template.customData";var b="sap.suite.ui.generic.template.genericData";var d="visual";var e="compact";var p;var I=false;var o=null;var A=null;var r={appStateKey:"",urlParams:{}};function f(){return p.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function R(i){if(i&&i.editStateFilter!==undefined){var H=c.byId("editStateFilter");if(H){H.setSelectedKey((i.editStateFilter===null)?0:i.editStateFilter);}}var T=s.oController.getOwnerComponent().getModel("_templPriv");if(i.chartVariantId&&s.oSmartChart){s.oSmartChart.setCurrentVariantId(i.chartVariantId);}if(i.filterMode){T.setProperty('/alp/filterMode',i.filterMode);s.filterBarController.handleFilterSwitch(i.filterMode);}else{j();}if(i.contentView){((D.system.phone||D.system.tablet&&!D.system.desktop)&&i.contentView==="charttable")?T.setProperty('/alp/contentView',"chart"):T.setProperty('/alp/contentView',i.contentView);}if(i.autoHide){T.setProperty('/alp/autoHide',i.autoHide);}}function h(i){i=i||{};if(i.hasOwnProperty(a)&&i.hasOwnProperty(b)){R(i[b]);t(i[a]);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}j();t(i);}}function j(){var T=s.oController.getOwnerComponent().getModel("_templPriv"),i=s.oSmartFilterbar.isCurrentVariantStandard()?s.oController.getOwnerComponent().getDefaultFilterMode():T.getProperty('/alp/filterMode');if(!(i===d||i===e)){q.sap.log.error("Defaulting to Visual filter due to incorrect value of defaultFilterMode in App descriptor");i=d;}if(i===d&&s.hideVisualFilter){q.sap.log.error("Visual filter is hidden defaulting to compact");i=e;}s.filterBarController.setDefaultFilter(i);}function k(i,H,N){s.oSmartFilterbar.setSuppressSelection(false);var J=i.appStateKey||"";if(I){return;}A=J;I=true;var K=(!J&&H)||{};if(N!==sap.ui.generic.app.navigation.service.NavType.initial){var L=i&&i.bNavSelVarHasDefaultsOnly;var M=new S(i.selectionVariant);u(M,i);x(M);if(!L||s.oSmartFilterbar.isCurrentVariantStandard()){w(M);}if(i.tableVariantId&&s.oSmartTable){s.oSmartTable.setCurrentVariantId(i.tableVariantId);}var T=s.oController.getOwnerComponent().getModel("_templPriv");if(N===sap.ui.generic.app.navigation.service.NavType.xAppState&&T.getProperty('/alp/filterMode')===d){v();}if(i.customData){h(i.customData);}else{j();}if(!L){s.oSmartFilterbar.search();}r={appStateKey:J,urlParams:K};}else{j();}U();o=null;I=false;}function l(){var i={};i[a]={};var T=s.oController.getOwnerComponent().getModel("_templPriv");i[b]={chartVariantId:s.oSmartChart&&s.oSmartChart.getCurrentVariantId(),filterMode:T.getProperty('/alp/filterMode'),contentView:T.getProperty('/alp/contentView'),autoHide:T.getProperty('/alp/autoHide')};var H=c.byId("editStateFilter");if(H){i[b].editStateFilter=H.getSelectedKey();}c.getCustomAppStateDataExtension(i[a]);return i;}function m(){var H=new S(s.oSmartFilterbar.getDataSuiteFormat());var V=c.getVisibleSelectionsWithDefaults();for(var i=0;i<V.length;i++){if(!H.getValue(V[i])){H.addSelectOption(V[i],"I","EQ","");}}if(s.oController.byId('template::PageVariant').currentVariantGetModified()&&H.getID()){H.setID("");}return{selectionVariant:H.toJSONString(),tableVariantId:s.oSmartTable&&s.oSmartTable.getCurrentVariantId(),customData:l()};}function t(i){c.restoreCustomAppStateDataExtension(i||{});}function u(i,H){var J=s.oSmartFilterbar.determineMandatoryFilterItems();var K;for(var L=0;L<J.length;L++){if(J[L].getName().indexOf("$Parameter.P_DisplayCurrency")!==-1){var M=H.oSelectionVariant.getSelectOption("DisplayCurrency");if(M&&M[0]&&M[0].Low){K=M[0].Low;}else if(F.readProperty(H,"oDefaultedSelectionVariant._mSelectOptions.DisplayCurrency.0.Low")){K=H.oDefaultedSelectionVariant._mSelectOptions.DisplayCurrency[0].Low;}if(K){i.addParameter("$Parameter.P_DisplayCurrency",K);}if(s.alr_visualFilterBar&&K){s.alr_visualFilterBar.setDisplayCurrency(K);}break;}}}function v(){var i=q.extend(true,{},s.oSmartFilterbar.getFilterData(true)),H=s.oController.getOwnerComponent().getModel("_filter");H.setData(i);s.filterBarController._updateFilterLink();}function w(i){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setDataSuiteFormat(i.toJSONString(),true);}function x(H){var J=H.getParameterNames().concat(H.getSelectOptionsPropertyNames());for(var i=0;i<J.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(J[i]);}if(s.alr_visualFilterBar){s.alr_visualFilterBar.addVisualFiltersToBasicArea(J);}}function y(){var i=m();try{o=n.storeInnerAppStateWithImmediateReturn(i);}catch(H){q.sap.log.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+H);}if(o instanceof sap.ui.generic.app.navigation.service.NavError){o=null;return;}if(o&&A!==o.appStateKey){r.appStateKey=o.appStateKey;}}function C(){var T=s.oController.getOwnerComponent().getModel("_templPriv");if(T.getProperty('/alp/filterMode')===d){if(!T.getProperty("/alp/searchable")){s.oSmartFilterbar.showFilterDialog();}}}function z(){if(s.oSmartFilterbar.isInitialised()){s.oSmartFilterbar.checkSearchAllowed(s);}}function U(){z();C();var i=s.oController.getOwnerComponent().getModel("_filter");i.setData(q.extend(true,{},s.oSmartFilterbar.getFilterData(true)));s.filterBarController._updateFilterLink();if(s.alr_visualFilterBar&&s.alr_visualFilterBar.updateVisualFilterBindings){s.alr_visualFilterBar.updateVisualFilterBindings(true);}}function E(i){p=n.parseNavigation();}function G(){try{p.done(k);p.fail(function(H){if(H instanceof Error){H.showMessageBox();}j();U();});}catch(i){j();U();}}return{getFilterState:l,fnCheckMandatory:z,getCurrentAppState:m,fnSetDefaultFilter:j,fnRestoreFilterState:h,getUrlParameterInfo:f,onSmartFilterBarInitialise:E,onSmartFilterBarInitialized:G,fnStoreCurrentAppStateAndAdjustURL:y};}return B.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.IappStateHandler",{constructor:function(s,c,n){q.extend(this,g(s,c,n));}});});
