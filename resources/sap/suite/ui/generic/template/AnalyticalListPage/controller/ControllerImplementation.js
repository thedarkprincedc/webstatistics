sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/base/EventProvider","sap/suite/ui/generic/template/AnalyticalListPage/extensionAPI/ExtensionAPI","sap/ui/core/ResizeHandler","sap/suite/ui/generic/template/AnalyticalListPage/controller/FilterBarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/ToolbarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterBarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterDialogController","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/ui/table/AnalyticalTable","sap/ui/model/odata/AnnotationHelper","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/controller/ContentAreaController","sap/suite/ui/generic/template/AnalyticalListPage/controller/IappStateHandler","sap/suite/ui/generic/template/AnalyticalListPage/util/CommonUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/Device"],function(q,B,J,O,T,a,S,b,E,c,R,F,d,V,f,M,g,A,h,j,C,I,k,l,D){"use strict";var m="sap.suite.ui.generic.template.customData",n="sap.suite.ui.generic.template.genericData",o="chart",p="visual",r="compact";return{getMethods:function(v,t,s){var u={};var w=false;var x=false;var y=false;var z=true;function G(){var e=s.getOwnerComponent();var i=e.getModel("_templPriv");i.setProperty("/listReport/isLeaf",e.getIsLeaf());}function H(){var e=q.sap.getObject("sap.ushell.Container.getUser");var i=s.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var W=(i&&i.icons&&i.icons.icon)||"";var X={bookmarkIcon:W,bookmarkCustomUrl:function(){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();return hasher.getHash()?("#"+hasher.getHash()):window.location.href;},bookmarkServiceUrl:function(){var Z=u.oSmartTable.getTable();var $;if(Z){$=Z.getBinding("rows")||Z.getBinding("items");}else{$="";}return $?$.getDownloadUrl()+"&$top=0&$inlinecount=allpages":"";},isShareInJamActive:!!e&&e().isJamActive()};var Y=s.getOwnerComponent().getModel("_templPriv");Y.setProperty("/listReport/share",X);}function K(e,i){var W=e&&e.property;return W.filter(function(X){return typeof X[i]!=="undefined";});}function L(i){var W=i.getModel(),X=W&&W.getMetaModel(),Y=X&&X.getODataEntityType(i.getEntityType()),Z=X&&X.getODataEntityType(i.getEntityType(),true),$=Y&&K(Y,"com.sap.vocabularies.Common.v1.FilterDefaultValue"),_,a1,b1,c1,d1,e1,f1=[];try{a1=new j.Model(new j.Model.ReferenceByModel(W));e1=a1&&a1.findQueryResultByName(i.getEntitySet());b1=e1&&e1.getParameterization();c1=b1&&X.getODataEntitySet(b1.getEntitySet().getQName());d1=c1&&X.getODataEntityType(c1.entityType);f1=d1?K(d1,"defaultValue"):[];}catch(e){q.sap.log.Error(e);}if($.length>0||f1.length>0){_={"SelectOptions":[],"Parameters":[]};$.forEach(function(g1){var h1=X.createBindingContext(Z+"/property/[${path:'name'}===\'"+g1.name+"']/com.sap.vocabularies.Common.v1.FilterDefaultValue"),i1={"PropertyName":g1.name,"Ranges":[{"Sign":"I","Option":"EQ","Low":h.format(h1),"High":null}]};_.SelectOptions.push(i1);});f1.forEach(function(g1){var h1={"PropertyName":"$Parameter."+g1.name,"PropertyValue":g1.defaultValue};_.Parameters.push(h1);});}return _;}function N(e){var i=e.getSource(),W=L(i);if(W){i.setDataSuiteFormat(JSON.stringify(W),true);}u.oIappStateHandler.onSmartFilterBarInitialise();s.onInitSmartFilterBarExtension(e);}function P(){u.oIappStateHandler.onSmartFilterBarInitialized();}function Q(e){var i=e.getParameters();var W=e.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(W,i);}function U(e){var i,W;i=e.getParameters();W=e.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(W,i,u,undefined,undefined);}return{onInit:function(){var e=s.getOwnerComponent();var W=e.getModel("_templPriv");W.setProperty("/alp",{filterMode:e.getHideVisualFilter()?r:e.getDefaultFilterMode(),contentView:e.getDefaultContentView(),autoHide:e.getAutoHide(),visibility:{hybridView:(D.system.phone||D.system.tablet&&!D.system.desktop)?false:true}});u.hideVisualFilter=e.getHideVisualFilter();u.hideVisualFilter=(u.hideVisualFilter===undefined||u.hideVisualFilter!==true)?false:true;u.oSmartFilterbar=s.byId("template::SmartFilterBar");u.oSmartTable=s.byId("table");u.oPage=s.byId("template::Page");u.oSmartChart=s.byId("chart");u.alr_compactFilterContainer=s.byId("template::CompactFilterContainer");u.alr_visualFilterContainer=s.byId("template::VisualFilterContainer");u.alr_filterContainer=s.byId("template::FilterContainer");u.alr_visualFilterBar=s.byId("template::VisualFilterBar");if(u.alr_visualFilterBar){u.alr_visualFilterBar.setSmartFilterId(u.oSmartFilterbar.getId());}u.oKpiTagContainer=s.byId("template::KpiTagContainer");if(u.oKpiTagContainer){q.sap.require("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController");sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController.init(u);}u.oContentArea=new C();u.oTemplateUtils=t;u.toolbarController=new d();u.oController=s;u.filterBarController=new F();u.filterBarController.init(u);u.oContentArea.createAndSetCustomModel(u);u.oContentArea.setState(u);if(!u.hideVisualFilter){u.visualFilterBarContainer=new V();u.visualFilterBarContainer.init(u);}u.oIappStateHandler=new I(u,s,t.oCommonUtils.getNavigationHandler());G();H();s.byId("template::FilterText").attachBrowserEvent("click",function(){s.byId("template::Page").setHeaderExpanded(true);});W.setProperty("/listReport/isHeaderExpanded",true);if(u.oSmartTable){var X=u.oSmartTable.getTable();}var Y="sapUiSizeCozy",Z="sapUiSizeCompact",$="sapUiSizeCondensed";if(t.oCommonUtils.isUiTable(X)||X instanceof A){var _=s.getView();var a1=q(document.body);if(a1.hasClass(Y)||_.hasStyleClass(Y)){u.oSmartTable.addStyleClass(Y);}else if(a1.hasClass(Z)||_.hasStyleClass(Z)){var b1=e.getComponentContainer().getSettings().condensedTableLayout;if(b1===false){u.oSmartTable.addStyleClass(Z);}else{u.oSmartTable.addStyleClass($);}}}v.getUrlParameterInfo=function(){return u.oIappStateHandler.getUrlParameterInfo();};v.onComponentActivate=function(){};v.refreshBinding=function(){if(u.alr_visualFilterBar&&u.alr_visualFilterBar.updateVisualFilterBindings){u.alr_visualFilterBar.updateVisualFilterBindings();}if(u.oSmartChart&&u.oSmartChart.rebindChart){u.oSmartChart.rebindChart();}if(u.oSmartTable){t.oCommonUtils.refreshSmartTable(u.oSmartTable);}if(u.oKpiTagContainer){var c1=u.oKpiTagContainer.mAggregations.content;for(var i in c1){if(c1[i].getModelName&&c1[i].getModelName()==="kpi"){c1[i]._firstTime=true;c1[i].onBeforeRendering();}}}};u.oSmartFilterbar.attachFilterChange(function(i){var c1=u.oSmartChart&&u.oSmartChart.getChart()&&u.oSmartChart.getDrillStackFilters();if(c1&&c1.length){u.oController.getOwnerComponent().getModel("_templPriv").setProperty('/alp/_ignoreChartSelections',false);}else{u.oController.getOwnerComponent().getModel("_templPriv").setProperty('/alp/_ignoreChartSelections',true);}u.oIappStateHandler.fnCheckMandatory();var d1=i.getSource(),e1=q.extend(true,{},d1.getFilterData(true)),f1=u.oController.getOwnerComponent().getModel("_filter");f1.setData(e1);if(i.getParameters().filterItem){if(!u.hideVisualFilter){u.filterBarController.changeVisibility(i);}u.oController.getOwnerComponent().getModel("_templPriv").setProperty('/alp/_ignoreChartSelections',false);}u.filterBarController._updateFilterLink();});},handlers:{onBack:function(){t.oServices.oNavigationController.navigateBack();},addEntry:function(e){var i=e.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(i,false,u.oSmartFilterbar);},q.noop,u);},deleteEntries:function(e){t.oCommonEventHandlers.deleteEntries(e);},onSelectionChange:function(e){var W=e.getSource(),X=W.getModel(),Y=W.getModel("_templPriv");var Z=X.getMetaModel(),$=Z.getODataEntitySet(this.getOwnerComponent().getEntitySet()),_=$["Org.OData.Capabilities.V1.DeleteRestrictions"];var a1=(_&&_.Deletable&&_.Deletable.Path)?_.Deletable.Path:"";var b1=false;var c1=true;var d1=(a1&&a1!=="");var e1=t.oCommonUtils.getSelectedContexts(W);if(e1.length>0){for(var i=0;i<e1.length;i++){var f1=X.getObject(e1[i].getPath());if(!(f1.IsActiveEntity&&f1.HasDraftEntity&&f1.DraftAdministrativeData&&f1.DraftAdministrativeData.InProcessByUser)){c1=false;}if(d1){if(X.getProperty(a1,e1[i])){d1=false;}}if(!c1&&!d1){b1=true;break;}}}Y.setProperty("/listReport/deleteEnabled",b1);},onChange:function(e){t.oCommonEventHandlers.onChange(e);},onSmartFieldUrlPressed:function(e){t.oCommonEventHandlers.onSmartFieldUrlPressed(e,u);},onContactDetails:function(e){t.oCommonEventHandlers.onContactDetails(e);},onSmartFilterBarInitialise:N,onSmartFilterBarInitialized:P,onEditStateFilterChanged:function(e){e.getSource().fireChange();},onFilterPress:function(e){u.filterBarController.showDialog.call(u.filterBarController);},onClearPress:function(e){u.filterBarController.clearFilters();s.onClearFilterExtension(e);},onGoPress:function(e){u.filterBarController.onGoFilter();},onBeforeSFBVariantSave:function(){var e=u.oIappStateHandler.getCurrentAppState();if(!this.getOwnerComponent().getProperty('smartVariantManagement')){delete e.customData["sap.suite.ui.generic.template.genericData"].contentView;}u.oSmartFilterbar.setFilterData({_CUSTOM:e.customData});},onAfterSFBVariantLoad:function(){var e=u.oSmartFilterbar.getFilterData();if(e._CUSTOM!==undefined){u.oIappStateHandler.fnRestoreFilterState(e._CUSTOM);}else{var i=u.oIappStateHandler.getFilterState();k.nullify(i[m]);k.nullify(i[n]);u.oIappStateHandler.fnRestoreFilterState(i);}if(!y&&l.isDefaultVariantSelected(u)){y=true;return;}else if(!y&&!l.isDefaultVariantSelected(u)){y=true;}u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},onBeforeRebindTable:function(e){t.oCommonEventHandlers.onBeforeRebindTable(e);s.onBeforeRebindTableExtension(e);},onBeforeRebindChart:function(e){},onShowDetails:function(e){t.oCommonEventHandlers.onShowDetails(e.getSource(),u);},onListNavigate:function(e){t.oCommonEventHandlers.onListNavigate(e.getSource(),u);},onCallActionFromToolBar:function(e){var i=t.oCommonUtils.getParentTable;t.oCommonUtils.getParentTable=function(){return u.oSmartTable;};t.oCommonEventHandlers.onCallActionFromToolBar(e,u);t.oCommonUtils.getParentTable=i;i=null;},onShowDetailsIntent:function(e){t.oCommonEventHandlers.onShowDetailsIntent(e,u.oSmartFilterbar);},onCallActionFromList:function(e){},onDataFieldForIntentBasedNavigation:function(e){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(e,u);},onDataFieldWithIntentBasedNavigation:function(e){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(e,u);},onBeforeSemanticObjectLinkPopoverOpens:function(e){var i=e.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var W=u.oSmartFilterbar.getDataSuiteFormat();t.oCommonUtils.semanticObjectLinkNavigation(i,W,s);},q.noop,u,q.noop);},onAssignedFiltersChanged:function(e){if(e&&e.getSource()){if(u&&u.oSmartFilterbar&&u.filterBarController){s.byId("template::FilterText").setText(u.oSmartFilterbar.retrieveFiltersWithValuesAsText());}}},onToggleFiltersPressed:function(){var e=s.getOwnerComponent();var i=e.getModel("_templPriv");i.setProperty("/listReport/isHeaderExpanded",(i.getProperty("/listReport/isHeaderExpanded")===true)?false:true);},onSearchButtonPressed:function(){if(D.system.phone&&u.oPage.getHeaderExpanded()){u.oPage.setHeaderExpanded(false);}var e=s.getOwnerComponent().getModel();e.attachEventOnce("requestSent",function(){if(u.oSmartFilterbar.isLiveMode()&&z){z=false;}else{u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();}});var i=function(W){M.handleError("getCollection",this,t.oServices,W.getParameters());var X=this.getView().byId("table");X.getTable().setBusy(false);M.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,null));}.bind(this);e.attachEventOnce("requestFailed",i);e.attachEventOnce("requestCompleted",function(W){if(W.getParameter("success")){e.detachEvent("requestFailed",i);}});},onSemanticObjectLinkPopoverLinkPressed:function(e){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(e,u);},onSemanticObjectLinkNavigationPressed:Q,onSemanticObjectLinkNavigationTargetObtained:U,onAfterTableVariantSave:function(){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},onAfterApplyTableVariant:function(){if(!w&&l.isDefaultVariantSelected(u)){w=true;return;}else if(!w&&!l.isDefaultVariantSelected(u)){w=true;}u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},onAfterChartVariantSave:function(e){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();t.oCommonUtils.setEnabledToolbarButtons(e.getSource());},onAfterApplyChartVariant:function(){if(!x&&l.isDefaultVariantSelected(u)){x=true;return;}else if(!x&&!l.isDefaultVariantSelected(u)){x=true;}u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},onFilterModeSegmentedButtonChange:function(e){u.filterBarController.handleFilterSwitch(e.getParameter("key"),e.oSource._bApplyingVariant);u.oController._templateEventHandlers.onSegmentButtonPressed();},onContentViewSegmentButtonPressed:function(){u.oController._templateEventHandlers.onSegmentButtonPressed(!u.oController.getOwnerComponent().getProperty('smartVariantManagement'));},onSegmentButtonPressed:function(i){if(!i){u.oController.byId('template::PageVariant').currentVariantSetModified(true);u.oSmartFilterbar.setFilterData({_CUSTOM:u.oIappStateHandler.getFilterState()});}u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},onShareListReportActionButtonPress:function(e){if(!u.oShareActionSheet){u.oShareActionSheet=t.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.lists.ShareSheet",{shareEmailPressed:function(){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();sap.m.URLHelper.triggerEmail(null,t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]),document.URL);},shareJamPressed:function(){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();var i=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:t.oServices.oApplication.getAppTitle()}}});i.open();}},"share",function(i,W){var X=sap.ui.getCore().getLibraryResourceBundle("sap.m");W.setProperty("/emailButtonText",X.getText("SEMANTIC_CONTROL_SEND_EMAIL"));W.setProperty("/jamButtonText",X.getText("SEMANTIC_CONTROL_SHARE_IN_JAM"));W.setProperty("/bookmarkButtonText",X.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var Y=q.sap.getObject("sap.ushell.Container.getUser");W.setProperty("/jamVisible",!!Y&&Y().isJamActive());i.openBy(e.getSource());});}else{u.oShareActionSheet.openBy(e.getSource());}},onDeterminingDataFieldForAction:function(e){var i=u.oController.getOwnerComponent().getModel("_templPriv");var W=i.getProperty('/alp/contentView');var X=(W===o)?u.oSmartChart:u.oSmartTable.getTable();t.oCommonEventHandlers.onDeterminingDataFieldForAction(e,X);},onDeterminingDataFieldForIntentBasedNavigation:function(e){var i=e.getSource();var W=u.oController.getOwnerComponent().getModel("_templPriv");var X=W.getProperty('/alp/contentView');var Y=(X===o)?u.oSmartChart:u.oSmartTable.getTable();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(i,Y,u);},onInlineDataFieldForAction:function(e){t.oCommonEventHandlers.onInlineDataFieldForAction(e,u);},onInlineDataFieldForIntentBasedNavigation:function(e){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(e.getSource(),u);},onAutoHideToggle:function(){u.chartController._updateTable();u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},onFullScreenToggled:function(e){var i=e.getParameter("fullScreen");var W=e.getSource().getModel("_templPriv");W.setProperty("/alp/fullScreen",i);},onDialogOpened:function(e){var i=u.oSmartFilterbar.getFilterDialogContent();if(!u.visualFilterDialogContainer){u.visualFilterDialogContainer=new f();u.visualFilterDialogContainer.init(u);}if(i.length<2){var W=[new sap.m.SegmentedButtonItem({icon:"sap-icon://filter-fields",width:"inherit",key:r,tooltip:"{i18n>FILTER_COMPACT}"}),new sap.m.SegmentedButtonItem({icon:"sap-icon://filter-analytics",width:"inherit",key:p,tooltip:"{i18n>FILTER_VISUAL}",enabled:"{_templPriv>/alp/searchable}"})];var X=new sap.m.SegmentedButton({width:"inherit",selectedKey:r,items:W,select:function(e){var _=e.getSource();_.setSelectedKey(r);u.visualFilterDialogContainer._toggle.call(u.visualFilterDialogContainer);}});var Y=u.visualFilterDialogContainer._createForm();u.oSmartFilterbar.addFilterDialogContent(Y);var Z=new sap.m.OverflowToolbar({design:sap.m.ToolbarDesign.Transparent,content:[new sap.m.ToolbarSpacer(),X]}).addStyleClass("sapSmartTemplatesAnalyticalListPageFilterDialogToolbar");i[0].setToolbar(Z);X.setModel(u.oController.getView().getModel("_templPriv"),"_templPriv");}var $=u.oController.getView().getModel("_templPriv");if($.getProperty("/alp/searchable")){if($.getProperty("/alp/filterMode")===p){u.oSmartFilterbar.addFilterDialogContent(i[1]);if(D.system.desktop&&(!D.system.phone||!D.system.tablet)){u.oSmartFilterbar.setContentWidth(790);u.oSmartFilterbar.setContentHeight(685);}else if(D.system.tablet){if(D.orientation.portrait){u.oSmartFilterbar.setContentWidth(400);u.oSmartFilterbar.setContentHeight(720);}else if(D.orientation.landscape){u.oSmartFilterbar.setContentWidth(512);u.oSmartFilterbar.setContentHeight(861);}}}else{u.oSmartFilterbar.addFilterDialogContent(i[0]);}}else{u.oSmartFilterbar.addFilterDialogContent(i[0]);}},onSearchForFilters:function(e){u.visualFilterDialogContainer._triggerSearchInFilterDialog.call(u.visualFilterDialogContainer,e);},onDialogSearch:function(e){u.visualFilterDialogContainer._searchDialog.call(u.visualFilterDialogContainer);},onDialogCancel:function(e){u.visualFilterDialogContainer._cancelDialog.call(u.visualFilterDialogContainer);},onRestore:function(e){u.visualFilterDialogContainer._restoreDialog.call(u.visualFilterDialogContainer);},onDataReceived:function(e){u.oContentArea.enableToolbar();t.oCommonEventHandlers.onDataReceived(e);},onRowSelectionChange:function(e){var i=e.getSource();t.oCommonUtils.setEnabledToolbarButtons(i);}},extensionAPI:new c(t,s,u)};}};});
