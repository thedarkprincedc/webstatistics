sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/controller/KpiCardController","sap/ui/model/json/JSONModel","sap/ui/model/json/JSONModel","sap/ui/core/mvc/ViewType","sap/m/Popover","sap/ui/Device"],function(K,J,F,V,P,D){"use strict";var O;jQuery.sap.declare("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController");sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController={_kpiCards:[],init:function(s){var m=this;m.oState=s;m.oGenericModel=new J();var g={header:"Some Header",title:"Some Title",titleUrl:"",icon:"sap-icon://camera"};m.oGenericModel.setData(g);if(O===undefined){O=sap.ui.getCore().loadLibrary("sap.ovp",{async:true});}},openKpiCard:function(e){var m=this;var s;if(typeof e.currentTarget!="undefined"){s=sap.ui.getCore().byId(e.currentTarget.id);}else{s=e.getSource();}O.then(function(){m.createPopover(function(){m._openCard(s);}.bind(m,s),s);});},_openCard:function(s){var m=this;jQuery.sap.delayedCall(0,this,function(){m._kpiCards[s.getQualifier()].openBy(s);});},handleKpiPress:function(e){this.openKpiCard(e);},createPopover:function(o,s){var m=this;var q=s.getQualifier();var c=m.oState.oController.getOwnerComponent();var S=c.getComponentContainer().getSettings();var k=S.keyPerformanceIndicators;var Q;for(var a in k){if(k[a].hasOwnProperty("qualifier")&&k[a].qualifier===q){Q=k[a];break;}}if(!Q){jQuery.sap.log.error("KPI settings not found with qualifier.");return;}var b=S.appComponent.getManifestEntry("/sap.app/crossNavigation/outbounds/"+Q.detailNavigation);var M=c.getModel(Q.model);M.getMetaModel().loaded().then(function(){var m=this;m._oCardController=new K();var c=m.oState.oController.getOwnerComponent();var p=new J();var Q=arguments[0];var M=c.getModel(Q.model);var d=M.getMetaModel();var e=d.getODataEntitySet(Q.entitySet);var E=d.getODataEntityType(e.entityType);var f=E["com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+q];var g=f.SelectionVariant&&f.SelectionVariant.Path;var h=E[g.split("@")[1]];Q.metaModel=d;p.setData(Q);var v=sap.ui.view({async:false,preprocessors:{xml:{bindingContexts:{entityType:d.createBindingContext(d.getODataEntityType(e.entityType,true)),entitySet:d.createBindingContext(d.getODataEntitySet(Q.entitySet,true))},models:{entitySet:d,entityType:d,parameter:p},dataModel:M,settings:p,preprocessorsData:c.getComponentData().preprocessorsData}},type:V.XML,viewName:"sap.suite.ui.generic.template.AnalyticalListPage.view.KpiCardSizeM",height:"100%"});v.data({"kpiTitle":s._nameFromPath,"qualifierSettings":Q,"selectionVariant":h});v.setModel(c.getModel(Q.model));var i=new sap.ui.model.json.JSONModel();var j={"visible":Q.detailNavigation?true:false};if(Q.detailNavigation&&b){j.target=b.semanticObject;j.action=b.action;j.parameters=JSON.stringify(b.parameters?b.parameters:{});}else{j.visible=false;}i.setData(j);v.setModel(i,"detailNavigation");if(typeof m._kpiCards[q]!="undefined"){m._kpiCards[q].destroy();}m._kpiCards[q]=new P();if(D.system.tablet&&!D.system.desktop){m._kpiCards[q].setPlacement("Bottom");}m._kpiCards[q].setShowHeader(false);m._kpiCards[q].addContent(v);m._oKpiCardController=v.getController();m._oKpiCardController._assignCommonUtils(m.oState.oTemplateUtils.oCommonUtils);m.oState.oController.getView().addDependent(m._kpiCards[q]);o();}.bind(this,Q));},onExit:function(){if(this._oKpiCard){this._oKpiCard.destroy();}},_setModel:function(m){this._oKpiCard.setModel(m);}};return sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController;});
