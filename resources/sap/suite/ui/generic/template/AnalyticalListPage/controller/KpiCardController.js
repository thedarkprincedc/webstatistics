sap.ui.define(["jquery.sap.global","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/thirdparty/d3","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(q,F,C,J,D,K,V){"use strict";q.sap.require("sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter");var n,s;var c=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiCardController",{onInit:function(e){q.sap.require("sap.ovp.cards.CommonUtils");},onExit:function(){},onBeforeRendering:function(){var o=sap.ovp.cards.CommonUtils;var d,S;var v=this.getView();var a=v.data("qualifierSettings");var Q=a.qualifier;var m=v.getModel();var M=m.getMetaModel();var e=M.getODataEntitySet(a.entitySet);var E=M.getODataEntityType(e.entityType);var b="kpiCard"+Q;var f={"cards":{}};S=V.SelectionPresentationVariant+(Q?"#"+Q:"");var p=E[S].PresentationVariant&&E[S].PresentationVariant.Path;if(!p){q.sap.log.error("PresentationVariant does not have Path.");return;}var g=E[p.split("@")[1]].Visualizations;g.forEach(function(A){if(A.AnnotationPath.indexOf("DataPoint")>0){d=A.AnnotationPath.split("@")[1];}});f["cards"][b]={"model":a.model,"template":"sap.ovp.cards.charts.analytical","settings":{"title":v.data("kpiTitle"),"entitySet":a.entitySet,"selectionPresentationAnnotationPath":S,"dataPointAnnotationPath":d,"showFilterInHeader":true,"navigation":"chartNav"}};o.createCardComponent(v,f,"template::ALPcardContainer");o.onHeaderClicked=function(h){this.handleNavigationPress(v);}.bind(this);o.onContentClicked=function(h){var i=h.getObject();this.handleNavigationPress(v,i);}.bind(this);},handleNavigationPress:function(v,o){var N=v.getModel("detailNavigation");if(N){var t=N.getProperty("/target");var a=N.getProperty("/action");if(t&&a){if(!n){n=s.getNavigationHandler();}this._oSelectionVariant=new sap.ui.generic.app.navigation.service.SelectionVariant();var b=JSON.parse(N.getProperty("/parameters"));this._createNavigationContext(b,true);this._getSelectOptionsFromAnnotation(v);if(o){this._createNavigationContext(o);}this._oSelectionVariant=this._oSelectionVariant.toJSONString();n.navigate(t,a,this._oSelectionVariant,null,function(e){if(e instanceof sap.ui.generic.app.navigation.service.NavError){if(e.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){sap.m.MessageBox.show(s.getText("ST_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:s.getText("ST_GENERIC_ERROR_TITLE")});}else{sap.m.MessageBox.show(e.getErrorCode(),{title:s.getText("ST_GENERIC_ERROR_TITLE")});}}});}}},_assignCommonUtils:function(o){s=o;n=s.getNavigationHandler();},_createNavigationContext:function(p,I){var k=Object.keys(p);for(var i=0;i<k.length;i++){var e=k[i];if(!p[e]&&p[e]!==""){return;}if(I){this._oSelectionVariant.addParameter(e,p[e]);}else{if(this._oSelectionVariant.getSelectOption(e)){this._oSelectionVariant.removeSelectOption(e);}this._oSelectionVariant.addSelectOption(e,"I","EQ",p[e]);}}},_getSelectOptionsFromAnnotation:function(v){var t=this;var S=v.data("selectionVariant");var a=S.SelectOptions;var b=S.Parameters;if(b&&b.length){b.forEach(function(p){var P=p.PropertyName.PropertyPath;var d=p.PropertyValue.String;if(t._oSelectionVariant.getParameter(P)){t._oSelectionVariant.removeParameter(P);}t._oSelectionVariant.addParameter(P,d);});}if(a&&a.length){a.forEach(function(o){var p=o.PropertyName.PropertyPath;var r=o.Ranges;r.forEach(function(R){var l=R.Low.String;var h=(R.High&&R.High.String)?R.High.String:null;var d=R.Sign.EnumMember.split("/")[1];var O=R.Option.EnumMember.split("/")[1];t._oSelectionVariant.addSelectOption(p,d,O,l,h);});});}}});return c;});
