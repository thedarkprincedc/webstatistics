sap.ui.define(['jquery.sap.global','sap/ui/core/mvc/Controller','sap/ui/model/Filter','sap/ui/model/json/JSONModel',"sap/m/Button","sap/m/StandardListItem","sap/m/List","sap/m/ToolbarSpacer","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil"],function(q,C,F,J,B,S,L,T,a){"use strict";var s=false,t={},I={},u="",D=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController",{});sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createDropdown=function(c,o,m,b,p){u=(p.filterRestriction=='multiple')?q.extend(true,{items:[],ranges:[],value:null},o.getDimensionFilter()):o.getDimensionFilter();var i=c.getModel('i18n'),f={"descriptionAndId":p.dimensionFieldDisplay,"descriptionOnly":p.dimensionFieldDisplay,"idAndDescription":p.dimensionField,"idOnly":p.dimensionField},f=(Object.keys(f).indexOf(p.textArrangement)!==-1)?f[p.textArrangement]:p.dimensionFieldDisplay,d=new sap.m.ToggleButton({icon:"sap-icon://menu",type:"Transparent",iconFirst:true,enabled:(u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u),tooltip:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED")}),l=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createStandardListItem(m,o,i,b,p,d),e=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createPopoverWithList(m,o,i,p,b,l,f,d),O=new sap.m.Button({text:i.getResourceBundle().getText("OK"),press:function(E){o.setDimensionFilter(u);o.fireFilterChange();e.close();}}),g=new sap.m.Button({text:i.getResourceBundle().getText("CANCEL"),press:function(){e.close();}});s=false;e.addContent(l);l.attachSelectionChange(function(E){var h=l.getModel().getData(E.mParameters.listItem.getBindingContext().sPath);h=h[p.dimensionField];var k=E.getParameters().listItem.mProperties.selected;if(p.filterRestriction==='multiple'){if(u.items&&u.items.length){for(var j=0;j<u.items.length;j++){if(u.items[j].key===h){u.items.splice(j,1);}else if(k){u.items.push({key:h});break;}}}else if(u.items){u.items.push({key:h});}else{u.items=[];}if(u.items.length){t.setVisible(true);I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[b,u.items.length]));}t.setVisible(Boolean(u.items.length));d.setEnabled(Boolean(u.items.length));}else if(p.filterRestriction==='single'){u=h;if(u){t.setVisible(true);I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[b,+Boolean(u)]));}d.setEnabled(Boolean(u));}});e.addStyleClass("sapSmartTemplatesAnalyticalListPageSelectedLinkDialog");e.setBeginButton(O);e.setEndButton(g);e.openBy(c);};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createPopoverWithList=function(m,c,i,p,b,l,f,o){var d=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.isEntitytypeSearchable(m,p);if(this._oPopoverDialog){this._oPopoverDialog;}if(l){this._oPopoverDialog=new sap.m.ResponsivePopover('',{placement:sap.m.PlacementType.Bottom,verticalScrolling:true,title:b,subHeader:[new sap.m.Toolbar({content:[new sap.m.SearchField({liveChange:function(e){var g=[];var Q=e.getSource().getValue();if(Q&&Q.length>0){var h=new F(f,sap.ui.model.FilterOperator.Contains,Q);g.push(h);}var j=l.getBinding("items");s=false;o.setPressed(false);o.setTooltip(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));j.filter(g);},enabled:d,initialFocus:true}),o]})],content:[l]});this._oPopoverDialog.setModel(c.getModel("_filter"),"_filter");}return this._oPopoverDialog;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createStandardListItem=function(m,c,i,b,p,o){var d="/"+p.entitySet,e=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.standardListItemTemplateCreation(c,p);I=new sap.m.Label({text:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[b,typeof(c.getDimensionFilter())==="object"&&c.getDimensionFilter()!==null?c.getDimensionFilter().items.length:+Boolean(c.getDimensionFilter())])});t=new sap.m.Toolbar({content:[I,new sap.m.ToolbarSpacer(),new sap.ui.core.Icon({src:"sap-icon://sys-cancel",tooltip:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_CLEAR_SELECTION"),press:function(E){t.setVisible(false);s=false;o.setTooltip(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));o.setEnabled(false);o.setPressed(false);l.removeSelections(true);(u&&u.hasOwnProperty("items"))?u.items=[]:u="";I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[b,(u&&u.hasOwnProperty("items"))?u.items.length:+Boolean(u)]));l.getBinding("items").filter([]);}}).addStyleClass("sapSmartTemplatesAnalyticalListPageDropdownDialogCancelButton")],"visible":(u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u)});if(c.getSmartFilterId()){var f=sap.ui.getCore().byId(c.getSmartFilterId());if(f&&f.getEntitySet()===p.entitySet){d=c.considerAnalyticBinding(d,f);}}var g=[p.measureField,p.dimensionField,p.dimensionFieldDisplay],l=new sap.m.List({mode:p.filterRestriction==="single"?sap.m.ListMode.SingleSelectMaster:sap.m.ListMode.MultiSelect,growing:true,growingThreshold:15,showNoData:false,infoToolbar:t,items:{path:d,template:e,sorter:sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.getSortObject(p),parameters:{select:g.join(",")}}});e.setModel(c.getModel("_filter"),"_filter");l.setModel(m);o.attachPress(function(E){if(p.filterRestriction=="multiple"&&u.items.length||u&&u.hasOwnProperty('items')&&!u.items.length&&s){sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings(l,o,i,p.filterRestriction,p.dimensionField);}else if(p.filterRestriction=="single"&&u!=null||u==null&&s){sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings(l,o,i,p.filterRestriction,p.dimensionField);}});return l;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.selectedVisibilityUpdateFormatter=function(u,c){for(var i=0;i<u.items.length;i++){if(u.items[i].key===c){return true;}}return false;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.isEntitytypeSearchable=function(m,p){var o=m.getMetaModel().getODataEntitySet(p.entitySet);if(o.extensions.length){for(var i=0;i<o.extensions.length;i++){if(o.extensions[i].name=="searchable"){return o.extensions[i].value=="true";}}}return true;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.standardListItemTemplateCreation=function(c,p){var b=p.textArrangement,d=[];d.push({path:p.measureField});p.unitField?d.push({path:p.unitField}):"";var e=new sap.m.StandardListItem({title:{parts:[p.dimensionFieldDisplay,p.dimensionField],formatter:function(o,f){return a.getTextArrangement(o,f,b);}},description:{parts:d,formatter:function(f,g){return sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart.prototype._getFormattedNumberWithUoM(f,g);}},selected:{parts:["_filter>/"+c.getParentProperty(),p.dimensionField],formatter:function(o,f){if(s){return true;}else{if(typeof(u)==="object"&&u!==null){for(var i=0;i<u.items.length;i++){if(u.items[i].key===f){return true;}}}else{return(u!==null&&u===f)?true:false;}}}}});return e;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.getSortObject=function(p){if(p.sortOrder&&p.sortOrder.length){return new sap.ui.model.Sorter((p.sortOrder[0].Field)?p.sortOrder[0].Field.String:"",p.sortOrder[0].Descending.Boolean);}};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings=function(l,o,b,f,c){var d=[];s=!s;if(s){o.setTooltip(b.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_ALL"));o.setEnabled(true);if(f==='multiple'){for(var i=0;i<u.items.length;i++){var e=new F(c,sap.ui.model.FilterOperator.EQ,(f==="multiple")?u.items[i].key:u);d.push(e);}}else if(f==='single'){var e=new F(c,sap.ui.model.FilterOperator.EQ,u);d.push(e);}l.getBinding("items").filter(d);}else{o.setEnabled((u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u));l.getBinding("items").filter(d);}};return D;});
