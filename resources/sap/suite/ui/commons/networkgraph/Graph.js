sap.ui.define(["sap/suite/ui/commons/library","jquery.sap.global","sap/ui/core/Control","./SvgBase","./Node","./Line","./Group","./layout/LayeredLayout","./Tooltip","sap/ui/core/Popup","sap/ui/model/json/JSONModel","sap/m/SuggestionItem","./Utils","sap/m/ButtonType","sap/m/Label","sap/m/OverflowToolbar","sap/m/OverflowToolbarButton","sap/m/SearchField","sap/m/ToolbarSpacer","sap/ui/core/CustomData","sap/ui/model/Filter","sap/m/OverflowToolbarLayoutData","./KeyboardNavigator"],function(l,q,C,S,N,L,G,c,T,P,J,d,U,B,e,O,f,g,h,j,F,k,K){var m=l.networkgraph.Orientation;var A="nodes",n="lines",o="groups";var Z=[0.05,0.1,0.25,0.33,0.50,0.67,0.75,0.80,0.90,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5],D=9,p=0.4,r=100000;var s={Group:"group",Node:"node",Line:"line",IsLastKey:"islast",TypeKey:"type"};var t=Object.freeze({Node:"Node",Line:"Line"});var R=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var u=0,M=100;var v=d.extend("sap.suite.ui.commons.networkgraph.LimitedSuggestionItem",{render:function(a,i,b,x){if(u++<M){d.prototype.render.call(this,a,i,b,x);}}});var w=S.extend("sap.suite.ui.commons.networkgraph.Graph",{metadata:{library:"sap.suite.ui.commons",properties:{height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},orientation:{type:"sap.suite.ui.commons.networkgraph.Orientation",group:"Behavior",defaultValue:m.LeftRight},backgroundImage:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null}},aggregations:{lines:{type:"sap.suite.ui.commons.networkgraph.Line",multiple:true,singularName:"line"},nodes:{type:"sap.suite.ui.commons.networkgraph.Node",multiple:true,singularName:"node"},groups:{type:"sap.suite.ui.commons.networkgraph.Group",multiple:true,singularName:"group"},legend:{type:"sap.ui.core.Control",multiple:false},layoutAlgorithm:{type:"sap.suite.ui.commons.networkgraph.layout.LayoutAlgorithm",multiple:false}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{graphReady:{},afterLayouting:{},beforeLayouting:{},zoomChanged:{},failure:{parameters:{type:"String",message:"String"}},selectionChange:{parameters:{items:{type:"sap.suite.ui.commons.networkgraph.ElementBase[]"}}},searchSuggest:{parameters:{term:{type:"sap.ui.core.String"}}},search:{parameters:{term:{type:"sap.ui.core.String"},key:{type:"sap.ui.core.String"}}}}}});w.FAILURE_TYPE={INCONSISTENT_MODEL:"Inconsistent model",LAYOUT_FAILURE:"Layout failure"};w.prototype.ZOOM_100_INDEX=D;w.prototype.init=function(){this._fZoomRatio=1;this._fZoomRatioIndex=D;this._mSelectedNodes={};this._mSelectedLines={};this._bIsLayedOut=false;this._bIsFullScreen=false;this._mNodes={};this._bNeedNodeProcessing=true;this._oFullScreenContainer=null;this._bRequiresDataProcessing=true;this._oPanning={};this._oLegendLabels={};this._iRunningLayouts=0;this._oLastLayout=null;this._bIsRtl=sap.ui.getCore().getConfiguration().getRTL();this._oFocus=null;this._tooltip=this._createTooltip();this._createToolbar();};w.prototype.onBeforeRendering=function(){this._bIsRtl=sap.ui.getCore().getConfiguration().getRTL();this.setBusy(false);this.setBusyIndicatorDelay(0);this._loadData();};w.prototype.onAfterRendering=function(){var H="",a=this._bIsRtl?"direction="+"\"rtl\"":"",b="<rect class=\"sapSuiteFlickerFreeRect\" x=\"0\" y=\"0\"></rect>";this.$scroller=this.$("scroller");this.$legend=this.$("legend");if(this.getNodes().length>0){this.setBusy(true);}else{this.fireGraphReady();}if(this._isDelayedLayouting()){this.getNodes().forEach(function(i){i._setupWidthAndHeight();H+=i._render({sizeDetermination:i._useAutomaticSize()});});this.$scroller.html("<svg "+a+" class=\"sapSuiteUiCommonsNetworkGraphSvg\">"+H+b+"</svg>");setTimeout(function(){this.getNodes().forEach(function(i){i._applyMaxWidth();i._createMultilineTitle();i._createDescription();});this._preprocessData();}.bind(this),0);}};w.prototype._beforeRender=function(){this.fireEvent("afterLayouting");};w.prototype._fireFailure=function(a,b){var i=b;if(typeof b==="object"&&b.text){i=b.text;}this.fireFailure([a.toString(),i]);q.sap.log.warning("Graph failure: "+a+": "+i);};w.prototype.preventInvalidation=function(b){this._bPreventInvalidation=b;};w.prototype.setSearchSuggestionItems=function(i){var a=[];if(i){i.forEach(function(I){a.push({text:I.getText(),icon:I.getIcon(),key:I.getKey(),description:I.getDescription()});});}this._oSuggestionItemsModel.setData({items:a});};w.prototype.destroyAllElements=function(){this.destroyAggregation(A,false);this.destroyAggregation(o,false);this.destroyAggregation(n,false);};w.prototype.deselect=function(b){var i=[],$=this.$(),a=function(E){Object.keys(E).forEach(function(x){i.push(E[x]);E[x].setSelected(false);},this);}.bind(this);$.find("."+this.HIGHLIGHT_CLASS).removeClass(this.HIGHLIGHT_CLASS);$.find("."+this.SELECT_CLASS).removeClass(this.SELECT_CLASS);$.find("."+this.VISIBLE_ACTIONS_BUTTONS_CLASS).removeClass(this.VISIBLE_ACTIONS_BUTTONS_CLASS);a(this._mSelectedNodes);a(this._mSelectedLines);if(!b&&i.length){this.fireSelectionChange({items:i});}return i;};w.prototype.getFocus=function(){return this._oFocus;};w.prototype.getToolbar=function(){return this._toolbar;};w.prototype.getNodeByKey=function(a){if(this._bRequiresDataProcessing){this._processData();}return this._mNodes[a];};w.prototype.setCustomLegendLabel=function(a){var b=a.isNode!==false?t.Node:t.Line;if(a.status){this._oLegendLabels[b+a.status]=a.label;this._createLegend();}};w.prototype.getCorrectMousePosition=function(a){var b=this.$svg.offset(),i=1,x=1;if(this._iWidth!==this.$svg.width()||this._iHeight!==this.$svg.height()){i=this._iWidth/this.$svg.width();x=this._iHeight/this.$svg.height();}return{x:parseInt((a.x-b.left)*i,10),y:parseInt((a.y-b.top)*x,10)};};w.prototype._createTooltip=function(){var a=new T(this.getId()+"-tooltip");this.addDependent(a);a.create(this);a.attachEvent("afterClose",function(){this.setFocus(this.getFocus());}.bind(this));return a;};w.prototype.defocus=function(){this.$().find("."+this.FOCUS_CLASS).removeClass(this.FOCUS_CLASS);};w.prototype.setFocus=function(a){var i;this.defocus();if(this.getFocusDomRef()){this.getFocusDomRef().focus();}if(a&&a.item instanceof L){a.button=null;}if(a){if(a.button){if(a.item instanceof N){i=a.item._aActionButtons.indexOf(a.button);if(i>-1){a.item._setActionButtonFocus(a.button,true);}}else if(a.item instanceof G){if(a.button===G.BUTTONS.MENU){a.item._setMenuButtonFocus(true);}else if(a.button===G.BUTTONS.COLLAPSE){a.item._setCollapseButtonFocus(true);}}}else if(a.item){a.item._setFocus(true);}}this._oFocus=a;this._ensureOnScreen(a?a.item:null);this._updateAccessibility(a);};w.prototype._updateAccessibility=function(a){var i,b=function(){this._setAccessibilityTitle(R.getText("NETWORK_GRAPH_ACCESSIBILITY_CONTENT"));}.bind(this),x=function(y){return R.getText("NETWORK_GRAPH_ACCESSIBILITY_ACTION_BUTTON")+" "+y;};if(a){if(a.button){if(a.item instanceof N){i=a.item._aActionButtons.indexOf(a.button);if(i>-1){this._setAccessibilityTitle(a.item._getActionButtonTitle(a.button));}else{b();}}else if(a.item instanceof G){if(a.button===G.BUTTONS.MENU){this._setAccessibilityTitle(x(R.getText("NETWORK_GRAPH_GROUP_DETAIL")));}else if(a.button===G.BUTTONS.COLLAPSE){this._setAccessibilityTitle(x(R.getText("NETWORK_GRAPH_EXPAND_COLLAPSE")));}else{b();}}else{b();}}else if(a.item){this._setAccessibilityTitle(a.item._getAccessibilityLabel());}}else{b();}};w.prototype._processProperties=function(){if(this._bNeedNodeProcessing){this._mSelectedNodes={};this._mSelectedLines={};this.getNodes().forEach(function(a){if(a.getSelected()){this._mSelectedNodes[a.getKey()]=a;}if(a.getCollapsed()){a.setCollapsed(true);}},this);this.getLines().forEach(function(a){if(a.getSelected()){this._mSelectedLines[a._getLineId()]=a;}},this);this._bNeedNodeProcessing=false;}};w.prototype._loadData=function(){if(this.getNodes().length>0){if(!this._isDelayedLayouting()){q.sap.delayedCall(0,this,this._preprocessData);}}};w.prototype._preprocessData=function(){this._bIsLayedOut=false;this._bImageLoaded=false;if(!this._processData()){return;}this.fireBeforeLayouting();this._applyLayout().then(this._render.bind(this));};w.prototype._getAllElements=function(){return this.getNodes().concat(this.getGroups());};w.prototype._render=function(){this._beforeRender();this._iRunningLayouts--;if(this._iRunningLayouts>0){return;}this._oLastLayout=null;this._createSearchSuggestItems();this._innerRender();this._createLegend();this._processProperties();if(this._fZoomRatio!==1){this.$svg[0].setAttribute("viewBox","0 0 "+this.$svg.width()+" "+this.$svg.height());this.$svg.width(this.$svg.width()*this._fZoomRatio);this.$svg.height(this.$svg.height()*this._fZoomRatio);}if(this._selectElementAfterScroll){this._scrollToElement(this._selectElementAfterScroll);this._selectElementAfterScroll=null;}this._bIsLayedOut=true;this._setupEvents();this._setupKeyboardNavigation();this.setFocus(this.getFocus());if(!this.getBackgroundImage()||this._bImageLoaded){this.setBusy(false);this.fireGraphReady();}};w.prototype._innerRender=function(a){var b=function(Q){var V="";Q.forEach(function(W){V+=W._render();W.bOutput=true;});return V;};var i=function(){this.$svg.find(".sapSuiteFlickerFreeRect").remove();this._bImageLoaded=true;if(this._bIsLayedOut){this.setBusy(false);this.fireGraphReady();}}.bind(this);var x=120,y=function(){var Q=0,V=0;this._iWidth=0;this._iHeight=0;this._getAllElements().forEach(function(X){if(V<X._iHeight+X.getY()){V=X._iHeight+X.getY();}if(Q<X._iWidth+X.getX()){Q=X._iWidth+X.getX();}},this);if(this.getBackgroundImage()){var W=new Image();W.onload=function(){this._iWidth=Math.max(this._iWidth,W.width);this._iHeight=Math.max(this._iHeight,W.height);this.$svg.width(this._iWidth);this.$svg.height(this._iHeight);this.$svg.css("background-image","url("+this.getBackgroundImage()+")");this.$svg.css("background-size","cover");i();}.bind(this);W.onerror=function(){q.sap.log.warning("Unable to load background image.");i();};W.src=this.getBackgroundImage();}this._iWidth=Q+x;this._iHeight=V+x;this.$svg.width(this._iWidth);this.$svg.height(this._iHeight);}.bind(this);var z=function(Q){Q.forEach(function(V){V.forEach(function(W){W._afterRendering();});});};var E=this.getNodes(),H=this.getLines(),I=this.getGroups();q.sap.measure.start(this.getId(),"Rendering of a network graph");this.$scroller.html(this._renderSvg(b(E),b(H),b(I)));this.$svg=this.$("networkGraphSvg");y();z([E,H,I]);q.sap.measure.end(this.getId());};w.prototype._renderSvg=function(a,b,i){var H="",x="sapSuiteUiCommonsNetworkGraphSvg sapSuiteUiCommonsNetworkGraphNoSelect "+(this._fZoomRatio<p?" sapSuiteUiCommonsNetworkGraphZoomedOut ":"");H+="<svg id=\""+this.getId()+"-networkGraphSvg\"";if(this._bIsRtl){H+="direction="+"\"rtl\"";}H+=" class=\""+x+"\" preserveAspectRatio=\"none\" ";H+=">";H+="<g id=\""+this.getId()+"-eventwrapper\"><rect style=\"fill: none\" class=\"sapSuiteUiCommonsNetworkGraphEventWrapper\" width=\"100%\" height=\"100%\"/></g>";H+="<g id=\""+this.getId()+"-svgbody\">";H+="<g class=\"sapSuiteUiCommonsNetworkGroupEventWrapper\"></g>";H+="<g id=\""+this._getDomId("groups")+"\">";H+=i?i:"";H+="</g>";H+="<g id=\""+this._getDomId("lines")+"\" class=\"sapSuiteUiCommonsNetworkLines\">";H+=b?b:"";H+="</g>";H+="<g id=\""+this._getDomId("nodes")+"\" class=\"sapSuiteUiCommonsNetworkNodes\">";H+=a?a:"";H+="</g>";H+="</g>";if(this.getBackgroundImage()){H+="<rect class=\"sapSuiteFlickerFreeRect\" x=\"0\" y=\"0\" height=\"100%\" width=\"100%\"></rect>";}H+="</svg>";return H;};w.prototype._isProperKey=function(a){return a||(a==="0");};w.prototype._processData=function(){var a=function(){var I=0;this.mGroups={};return this.getGroups().some(function(x){var y=x.getKey();if(!this._isProperKey(y)){this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Group without a proper key [index: "+I+"] found.");return true;}x._resetSize();x._clearChildren();if(this.mGroups[y]){this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Group with a duplicit key "+y+" found.");return true;}this.mGroups[y]=x;I++;return false;},this);}.bind(this);var b=function(){var I=0;this._mNodes={};return this.getNodes().some(function(x){if(!this._isProperKey(x.getKey())){this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Node without a proper ID [index: "+I+"] found.");return true;}var y=x.getGroup(),z;x._oGroup=null;if(y){z=this.mGroups[y];if(z){x._oGroup=z;z.aNodes.push(x);}else{this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Node belonging to a nonexistent group with key "+y+" found.");return true;}}x._setupWidthAndHeight();x._clearChildren();x._rendered=false;if(this._mNodes[x.getKey()]){this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Node with a duplicit key "+x.getKey()+" found.");return true;}this._mNodes[x.getKey()]=x;I++;return false;},this);}.bind(this);var i=function(){return this.getLines().some(function(x,I){var y=this.getNodeByKey(x.getFrom()),z=this.getNodeByKey(x.getTo());if(!y){this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Line going from a nonexistent node with key "+x.getFrom()+" found.");return true;}if(!z){this._fireFailure(w.FAILURE_TYPE.INCONSISTENT_MODEL,"Line going to a nonexistent node with key "+x.getTo()+" found.");return true;}x._rendered=false;x._initialized=false;if(y&&z){y.aChildren.push(z);y.aLines.push(x);z.aParents.push(y);z.aParentLines.push(x);x._oFrom=y;x._oTo=z;x._sKey="line_"+y.getKey()+"-"+z.getKey()+"["+I+"]";}if(y._oGroup){y._oGroup.aLines.push(x);y._oGroup.aChildren.push(z);}if(z._oGroup){z._oGroup.aParentLines.push(x);z._oGroup.aParents.push(y);}return false;},this);}.bind(this);this._bRequiresDataProcessing=false;if(a()||b()||i()){return false;}return true;};w.prototype._validateLayout=function(){var W,b,a,i;W=this.getNodes().some(function(x){if(x._isIgnored()){return false;}i="Missing coordinates: Node("+x.getKey()+")";return!((x._oGroup&&x._oGroup.getCollapsed())||(isFinite(x.getX())&&isFinite(x.getY())));});if(W){this._fireFailure(w.FAILURE_TYPE.LAYOUT_FAILURE,i);return false;}if(this._isLayered()){b=this.getGroups().some(function(x){if(x._isIgnored()){return false;}i="Missing coordinates: Group("+x.getKey()+")";return!x._isEmpty()&&(!isFinite(x.getX())||!isFinite(x.getY()));});if(b){this._fireFailure(w.FAILURE_TYPE.LAYOUT_FAILURE,i);return false;}}a=this.getLines().some(function(x){if(x._isIgnored()){return false;}i="Missing coordinates: Line("+x.getKey()+")";return!x._validateLayout();});if(a){this._fireFailure(w.FAILURE_TYPE.LAYOUT_FAILURE,i);return false;}return true;};w.prototype._suggest=function(a){var b=function(i){i.addCustomData(new j({key:s.IsLastKey,value:"true",writeToDom:true}));};var x=function(i){var I=U.find(i.getCustomData(),function(Q){return Q.getKey()===s.IsLastKey;});if(I){i.removeCustomData(I);}};var y=function(i){var I=U.find(i.getCustomData(),function(Q){return Q.getKey()===s.TypeKey;});return I&&I.getValue();};var z=function(){var I=this._searchField.getSuggestionItems(),Q,V,W;for(var i=0;i<I.length;i++){Q=I[i];x(Q);if(i<I.length-1){V=y(Q);W=y(I[i+1]);if(V&&W){if((V===s.Node&&W===s.Line)||(V===s.Line&&W===s.Group)){b(Q);}}}}}.bind(this);var E=[],H=this.fireEvent("searchSuggest",{term:a},true);u=0;if(H){if(a){E=[new F([new F("text",function(i){return(i.toLowerCase()||"").indexOf(a.toLowerCase())>-1;}),new F("description",function(i){return(i.toLowerCase()||"").indexOf(a.toLowerCase())>-1;})],false)];}this._searchField.getBinding("suggestionItems").filter(E);z();}this._searchField.suggest();};w.prototype._search=function(a,b){var i="_selectNode",E,I;E=this.fireEvent("search",{term:a,key:b},true);if(!E){return;}if(a){I=U.find(this.getNodes(),function(I){return b?I.getKey()===b:I.getTitle()===a;});if(!I){I=U.find(this.getLines(),function(x){if(x._isLoop()){return false;}return b?x._getLineId()===b:x._createSuggestionHelpText()===a;});i="_selectLine";}if(!I){I=U.find(this.getGroups(),function(x){return x.aNodes.length>0&&(b?x.getKey()===b:x.getTitle()===a);});i="_selectGroup";}if(I){if(i){this[i]({element:I,scroll:true,alwaysSelect:true});}}}else{this.deselect(false);this.setFocus(null);}};w.prototype._createToolbar=function(){var a=this;this._toolbar=new O(this.getId()+"-toolbar",{content:[new h()]}).addStyleClass("sapSuiteUiCommonsNetworkGraphToolbar");this.addDependent(this._toolbar);this._searchField=new g({layoutData:new k({priority:sap.m.OverflowToolbarPriority.NeverOverflow,shrinkable:true}),enableSuggestions:true,suggest:function(E){a._suggest(E.getParameter("suggestValue"));},search:function(E){var b=E.getParameter("query"),i=E.getParameter("suggestionItem"),x;if(i){x=i.getProperty("key");}a._search(b,x);}}).addStyleClass("sapSuiteUiCommonsNetworkGraphSearchField");this._toolbar.addContent(this._searchField);this._toolbar.addContent(new f({type:B.Transparent,icon:"sap-icon://legend",press:function(E){if(a.$legend.is(":visible")){a.$legend.hide();}else{a.$legend.show();}}}).setTooltip(R.getText("NETWORK_GRAPH_LEGEND")));this._toolbar.addContent(new f({layoutData:new k({group:1}),type:B.Transparent,icon:"sap-icon://zoom-in",press:function(E){a._zoom({deltaY:1});}}));this._zoomLabel=new e({layoutData:new k({group:1,priority:sap.m.OverflowToolbarPriority.Disappear}),text:"100%"});this._toolbar.addContent(this._zoomLabel);this._toolbar.addContent(new f({layoutData:new k({group:1}),type:B.Transparent,icon:"sap-icon://zoom-out",press:function(E){a._zoom({deltaY:-1});}}));this._toolbar.addContent(new f({type:B.Transparent,icon:"sap-icon://sys-monitor",press:this._fitToScreen.bind(this)}).setTooltip(R.getText("NETWORK_GRAPH_ZOOMTOFIT")));this._toolbar.addContent(new f({type:B.Transparent,icon:"sap-icon://full-screen",press:this._toggleFullScreen.bind(this)}));this._oPopup=new P({modal:true,shadow:false,autoClose:false});};w.prototype._fitToScreen=function(){var H=this.$scroller.height()/this._iHeight,W=this.$scroller.width()/this._iWidth,a=Math.min(H,W),z=Z.length-1;for(var i=1;i<Z.length;i++){if(a<Z[i]){z=i-1;break;}}this._zoom({newIndex:z});};w.prototype._getZoomText=function(){return Math.floor((this._fZoomRatio*100))+"%";};w.prototype._toggleFullScreen=function(){var a=function(){this._oFullScreenContainer={};this._oFullScreenContainer.$content=this.$();if(this._oFullScreenContainer.$content){this._oFullScreenContainer.$tempNode=q("<div></div>");this._oFullScreenContainer.$content.before(this._oFullScreenContainer.$tempNode);this._oFullScreenContainer.$overlay=q("<div id='"+q.sap.uid()+"'></div>");this._oFullScreenContainer.$overlay.addClass("sapSuiteUiCommonsNetworkGraphContainerOverlay");this._oFullScreenContainer.$overlay.append(this._oFullScreenContainer.$content);this._oPopup.setContent(this._oFullScreenContainer.$overlay);}this._oPopup.open(200,P.Dock.BeginTop,P.Dock.BeginTop,q("body"));}.bind(this),b=function(){this._oFullScreenContainer.$tempNode.replaceWith(this._oFullScreenContainer.$content);this._oPopup.close();this._oFullScreenContainer.$overlay.remove();}.bind(this);if(this._bIsFullScreen){b();}else{a();}this._bIsFullScreen=!this._bIsFullScreen;};w.prototype._setupKeyboardNavigation=function(){var I=[],x=[[]],y,z;if(!this._isLayedOut()){return;}this.getNodes().forEach(function(a){if(a.isHidden()||a._isIgnored()||!a.getVisible()){return;}I.push({item:a,x:a.getX(),y:a.getY()});});this.getLines().forEach(function(a){if(a.isHidden()||a._isIgnored()||!a.getVisible()){return;}var b=a.getCoordinates()[0],X=b.getX(),Y=b.getY();a.getCoordinates().forEach(function(b){if(X>b.getX()){X=b.getX();}if(Y>b.getY()){Y=b.getY();}});I.push({item:a,x:X,y:Y});});this.getGroups().forEach(function(a){if(a.isHidden()||a._isEmpty()||!a.getVisible()){return;}I.push({item:a,x:a.getX(),y:a.getY()});});I.sort(function(a,b){if(a.y<b.y){return-1;}else if(a.y>b.y){return 1;}else if(a.x<b.x){return-1;}else if(a.x>b.x){return 1;}else{return 0;}});if(I.length>0){z=[I[0]];x=[z];y=I[0];I.forEach(function(a,i){if(i===0){return;}if(a.y===y.y){z.push(a);}else{z=[a];x.push(z);}y=a;});}x=this._normalizeGrid(x,I);if(!this._oKeyboardNavigator){this._oKeyboardNavigator=new K(this);this.addDelegate(this._oKeyboardNavigator);}this._oKeyboardNavigator.setItems(x);this._oKeyboardNavigator.setWrapperDom(this.getFocusDomRef());};w.prototype._normalizeGrid=function(a,I){if(I.length===0){return a;}var b=I[0],x=b.x,y=b.x,z=1,E,H,Q=[],i;I.forEach(function(V){if(V.x<x){x=V.x;}if(V.x>y){y=V.x;}});a.forEach(function(V){if(V.length>z){z=V.length;}});E=Math.abs(y-x)/z;H=x;for(i=0;i<z;i++){H+=E;Q.push(H);}return a.map(function(V){var W,X;if(V.length===z){W=V;}else{W=[];X=0;while(X<(z-V.length)&&Q[X]<V[0].x){X++;W.push(null);}V.forEach(function(Y){W.push(Y);X++;});while(X<z){W.push(null);X++;}}return W.map(function(Y){return Y?Y.item:null;});});};w.prototype.getFocusDomRef=function(){return this.getDomRef("wrapper");};w.prototype._setupEvents=function(){var a=5;var i=0,b={},$=this.$("eventwrapper"),x=this.$scroller;var y=function(H,I){return Math.sqrt(Math.pow(H.clientX-I.clientX,2)+Math.pow(H.clientY-I.clientY,2));};var z=function(H){if(H.touches&&H.touches.length===2){b={t1:H.touches[0],t2:H.touches[1],diff:y(H.touches[0],H.touches[1])};}};var E=function(H){if(H.touches&&H.touches.length===2){if(++i===a){var I=H.touches[0],Q=H.touches[1],V=y(I,Q);this._zoom({point:{x:(I.clientX+Q.clientX)/2,y:(I.clientY+Q.clientY)/2},deltaY:V-b.diff});i=0;b={t1:I,t2:Q,diff:V};}}}.bind(this);x.mousemove(function(H){this._mouseMove(H.clientX,H.clientY);}.bind(this));$.mousedown(function(H){this._mouseDown(H.clientX,H.clientY);H.preventDefault();}.bind(this));x.mouseleave(this._endDragging.bind(this));x.mouseup(this._mouseUp.bind(this));x.bind("wheel",function(H){this._wheel({x:H.originalEvent.clientX,y:H.originalEvent.clientY,deltaY:H.originalEvent.deltaY});H.preventDefault();}.bind(this));x.bind("touchstart",function(H){z(H);});x.bind("touchmove",function(H){E(H);});};w.prototype._wheel=function(a){this._zoom({point:{x:a.x,y:a.y},deltaY:-a.deltaY});this._zoomLabel.setText(this._getZoomText());};w.prototype._endDragging=function(){this._oPanning.dragging=false;this.$scroller.removeClass("sapSuiteUiCommonsNetworkGraphPanning");};w.prototype._mouseMove=function(x,y){var a=this.$scroller[0];if(this._oPanning.dragging){if(!this.$scroller.hasClass("sapSuiteUiCommonsNetworkGraphPanning")){this.$scroller.addClass("sapSuiteUiCommonsNetworkGraphPanning");}a.scrollTop=a.scrollTop-(y-this._oPanning.lastY);a.scrollLeft=a.scrollLeft-(x-this._oPanning.lastX);this._oPanning.lastX=x;this._oPanning.lastY=y;}};w.prototype._mouseDown=function(x,y){this.deselect(false);this.setFocus(null);this._oPanning.lastX=x;this._oPanning.lastY=y;this._oPanning.dragging=true;this._tooltip.instantClose();};w.prototype._mouseUp=function(){this._endDragging();};w.prototype._zoom=function(a){var b=this.$svg[0].getAttribute("viewBox"),i=a.deltaY<0?-1:1,x,y,z,E;if(!a.point){a.point={x:this.$scroller.width()/2,y:this.$scroller.height()/2};}x=this.getCorrectMousePosition({x:a.point.x,y:a.point.y});z=a.newIndex||a.newIndex===0?a.newIndex:this._fZoomRatioIndex+i;if((z<0)||(z>Z.length-1)){return;}this._fZoomRatioIndex=z;this._fZoomRatio=Z[this._fZoomRatioIndex];if(!b){E="0 0 "+this.$svg.width()+" "+this.$svg.height();this.$svg[0].setAttribute("viewBox",E);}this.$svg.width(this._iWidth*this._fZoomRatio);this.$svg.height(this._iHeight*this._fZoomRatio);y=this.getCorrectMousePosition({x:a.point.x,y:a.point.y});this.$scroller[0].scrollLeft+=(x.x-y.x)*this._fZoomRatio;this.$scroller[0].scrollTop+=(x.y-y.y)*this._fZoomRatio;this._zoomLabel.setText(this._getZoomText());if(this._fZoomRatio<p){this.$svg.addClass("sapSuiteUiCommonsNetworkGraphZoomedOut");}else{this.$svg.removeClass("sapSuiteUiCommonsNetworkGraphZoomedOut");}this.fireEvent("zoomChanged");};w.prototype._createSearchSuggestItems=function(){var a=50;var b={items:[]},i=this.getNodes().sort(function(z,E){return z.getTitle().localeCompare(E.getTitle());}),x=this.getLines().sort(function(z,E){var H=z.getTitle(),I=E.getTitle();if(H===I){return z.getFromNode().getTitle().localeCompare(E.getFromNode().getTitle());}return H.localeCompare(I);}),y=this.getGroups().sort(function(z,E){return z.getTitle().localeCompare(E.getTitle());});this._oSuggestionItemsModel=new J();this._oSuggestionItemsModel.setSizeLimit(r);i.forEach(function(z){var E=U.trimText(z.getTitle(),a);b.items.push({text:E?E:z.getKey(),type:s.Node,icon:z.getIcon(),key:z.getKey(),description:"("+R.getText("NETWORK_GRAPH_NODE")+")"});});x.forEach(function(z){if(z._isLoop()){return;}if(z.getTitle()||z.getFromNode().getTitle()||z.getToNode().getTitle()){b.items.push({text:z._createSuggestionHelpText(),type:s.Line,key:z._getLineId(),description:"("+R.getText("NETWORK_GRAPH_LINE")+")"});}});y.forEach(function(z){var E=U.trimText(z.getTitle(),a);if(z.aNodes.length>0){b.items.push({text:E?E:z.getKey(),key:z.getKey(),type:s.Group,description:"("+R.getText("NETWORK_GRAPH_GROUP")+")"});}});this._oSuggestionItemsModel.setData(b);this._searchField.setModel(this._oSuggestionItemsModel);this._searchField.bindAggregation("suggestionItems",{path:"/items",template:new v({text:"{text}",icon:"{icon}",key:"{key}",description:"{description}",customData:new j({key:"type",value:"{type}"})})});};w.prototype._scrollToElement=function(i){var I=i._oGroup&&i._oGroup.getCollapsed(),a=i instanceof L?i.getSource():i;if(I){a=i._oGroup;}this.$scroller.get(0).scrollLeft=((a.getX()+(a._iWidth?a._iWidth:0)/2)*this._fZoomRatio)-(this.$scroller.width()/2);this.$scroller.get(0).scrollTop=((a.getY()+(a._iHeight?a._iHeight:0)/2)*this._fZoomRatio)-(this.$scroller.height()/2);};w.prototype._ensureOnScreen=function(i){var a,b,x,y,z,E,H,I;if(!i||!this.$scroller){return;}a=this.$scroller[0];b=(i instanceof L)?i.getSource():i;H=(b.getX()+b._iWidth/2)*this._fZoomRatio;I=(b.getY()+b._iHeight/2)*this._fZoomRatio;x=a.scrollLeft;z=a.scrollTop;y=x+this.$scroller.width();E=z+this.$scroller.height();if(H<x){a.scrollLeft=b.getX()*this._fZoomRatio-10;}if(I<z){a.scrollTop=b.getY()*this._fZoomRatio-10;}if(H>y){a.scrollLeft=(b.getX()+b._iWidth)*this._fZoomRatio+10-this.$scroller.width();}if(I>E){a.scrollTop=(b.getY()+b._iHeight)*this._fZoomRatio+10-this.$scroller.height();}};w.prototype._createLegend=function(){var $=this.$("legend"),H="",a=this,b={},i={};var x=function(E,I){var Q=E.getStatus();if(Q){if(I[Q]){I[Q].push(E);}else{I[Q]=[E];}}};var y=function(I){return Object.keys(I).length>0;};var z=function(E,I){H+=this._renderControl("div",{status:E,elementtype:I,"class":"sapSuiteUiCommonsNetworkGraphLegendLine"},false);H+=this._renderControl("div",{"class":"sapSuiteUiCommonsNetworkGraphLegendColorLine "+this._getStatusClass(E)});H+=this._renderControl("label",{"class":"sapSuiteUiCommonsNetworkGraphLegendLineLabel"},false);H+=this._oLegendLabels[I+E]?this._oLegendLabels[I+E]:E;H+="</label>";H+="</div>";}.bind(this);if(this.getLegend()){return;}if(!$[0]){return;}this.getNodes().forEach(function(E){x(E,b);});if(y(b)){H+="<div class=\"sapSuiteUiCommonsNetworkGraphLegendTitleNode\"><label class=\"sapSuiteUiCommonsNetworkGraphLegendTitle\">"+q.sap.encodeHTML(R.getText("NETWORK_GRAPH_NODES"))+"</label></div>";Object.keys(b).forEach(function(E){z(E,t.Node);});}this.getLines().forEach(function(E){x(E,i);});if(y(i)){H+="<div class=\"sapSuiteUiCommonsNetworkGraphLegendTitleLine\"><label class=\"sapSuiteUiCommonsNetworkGraphLegendTitle\">"+q.sap.encodeHTML(R.getText("NETWORK_GRAPH_LINES"))+"</label></div>";Object.keys(i).forEach(function(E){z(E,t.Line);});}$.html(H);this.$().find(".sapSuiteUiCommonsNetworkGraphLegendLine").click(function(E){var I=q(this).attr("status"),Q=q(this).attr("elementtype"),V=Q===t.Node?b:i;if(!E.ctrlKey){a.deselect(false);a.setFocus(null);}if(V[I]){V[I].forEach(function(W){W.$().addClass(a.SELECT_CLASS);});}});};w.prototype._selectElement=function(a){var i=a.element&&!a.element.getSelected(),I=[];var b=function(V){a.element.setSelected(V);if(a.setFocus!==false){this.setFocus({item:a.element});}}.bind(this);this.$().find("."+this.VISIBLE_ACTIONS_BUTTONS_CLASS).removeClass(this.VISIBLE_ACTIONS_BUTTONS_CLASS);if(!a.preventDeselect){I=this.deselect(true);if(a.setFocus){this.setFocus(null);}if(i||a.alwaysSelect){b(true);}}else{b(i);}if(!a.element._hasFocus()&&a.forceFocus){this.setFocus({item:a.element});}if(!I.some(function(x){return x===a.element;})){I.push(a.element);}this.fireSelectionChange({items:I});};w.prototype._selectLine=function(a){var b=a.element.getFromNode(),i=a.element.getToNode(),x=(b._isInCollapsedGroup()&&(b._oGroup===i._oGroup))?i._oGroup:null;if(a.scroll){this._scrollToElement(x||a.element);}if(!x){this._selectElement(a);}};w.prototype._selectNode=function(a){var b=a.element._isInCollapsedGroup()?a.element._oGroup:null;if(a.scroll){this._scrollToElement(b||a.element);}if(!b){this._selectElement(a);if(a.renderActionButtons!==false){a.element.showActionButtons(true);}}};w.prototype._selectGroup=function(a){if(a.scroll){this._scrollToElement(a.element);}this.setFocus({item:a.element});};w.prototype._applyLayout=function(){var a;this._iRunningLayouts++;a=this._getLayoutAlgorithm().layout().catch(function(E){this._fireFailure(w.FAILURE_TYPE.LAYOUT_FAILURE,E);return Promise.reject();}.bind(this)).then(function(){return new Promise(function(b,i){if(a.isTerminated()){b();return;}if(this._validateLayout()){b();}else{i();}}.bind(this));}.bind(this));if(this._oLastLayout&&this._iRunningLayouts>1){this._oLastLayout.terminate();}this._oLastLayout=a;return a;};w.prototype._setAccessibilityTitle=function(i){var a,W=this.$("accessibility");if(i===null){a=R.getText("NETWORK_GRAPH_ACCESSIBILITY_CONTENT");}else if(typeof i==="string"){a=i;}else{a=i._getAccessibilityLabel();}if(W){W.html(q.sap.encodeHTML(a));}};w.prototype._getLayoutAlgorithm=function(){return this.getLayoutAlgorithm()||this._getDefalutLayout();};w.prototype._getDefalutLayout=function(){if(!this._oDefalutLayout){this._oDefaultLayout=new c();this._oDefaultLayout.setParent(this,null,true);}return this._oDefaultLayout;};w.prototype._isLayered=function(){return this._getLayoutAlgorithm().isLayered();};w.prototype._isDelayedLayouting=function(){return this.getNodes().some(function(a){return a._useAutomaticSize()||a.getTitleLineSize()!==1||a._displayDescription();});};w.prototype._isLayedOut=function(){return this._bIsLayedOut;};w.prototype.destroyAggregation=function(a,b){this._bRequiresDataProcessing=true;C.prototype.destroyAggregation.call(this,a,b);};w.prototype.insertAggregation=function(a,b,i,x){this._bRequiresDataProcessing=true;C.prototype.insertAggregation.call(this,a,b,i,x);};w.prototype.removeAggregation=function(a,b,i){this._bRequiresDataProcessing=true;C.prototype.removeAggregation.call(this,a,b,i);};w.prototype.addAggregation=function(a,b,i){this._bRequiresDataProcessing=true;C.prototype.addAggregation.call(this,a,b,i);};w.prototype.removeAllAggregation=function(a,b){this._bRequiresDataProcessing=true;C.prototype.removeAllAggregation.call(this,a,b);};w.prototype.updateAggregation=function(a){this._bNeedNodeProcessing=true;C.prototype.updateAggregation.call(this,a);};w.prototype.invalidate=function(){if(this._bPreventInvalidation!==true){C.prototype.invalidate.call(this);}};return w;});
