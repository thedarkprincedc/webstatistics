// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/constants.private","jquery.sap.global"],function(s,i,q){"use strict";return Object.create(null,{PersonalizationAdapter:{value:P},getStorageResourceRoot:{value:g},getContainerPath:{value:c},delAdapterContainer:{value:e},createContainerData:{value:f},getAdapterContainer:{value:A},getContainerCategory:{value:h},isCategoryPContainer:{value:k},trimContainerKey:{value:t},save:{value:l},load:{value:m},del:{value:n},clearContainerData:{value:o},getItemKeys:{value:u},containsItem:{value:v},setItemValue:{value:w},getItemValue:{value:x},delItem:{value:y},addPrefixToItemKey:{value:p},stripPrefixFromItemKey:{value:r}});function P(H,C,S,z,B){var D,E;var F={cache:{},headers:{"sap-client":S.getClient()}};B=B&&B.config;if(!B){throw new Error("PersonalizationAdapter: missing configuration.");}if(!C){C=Object.create(null);}D=g(B);E=H(D,F);return Object.create(null,{getAdapterContainer:{value:A.bind(null,B,C,E)},delAdapterContainer:{value:e.bind(null,C,E)}});}function g(C){var I=!C||!C.storageResourceRoot;if(I){throw new Error("Configuration error: storage resource root is not defined.");}return C.storageResourceRoot;}function a(C){var I=!C||!C.relativeUrlReadOptimized;if(I){throw new Error("Configuration error: relative URL for read optimization is not defined.");}return C.relativeUrlReadOptimized;}function b(C){var I=!C||!C.relativeUrlWriteOptimized;if(I){throw new Error("Configuration error: relative URL for write optimization is not defined.");}return C.relativeUrlWriteOptimized;}function c(C,S,z){return j(C,S)+"/"+encodeURIComponent(t(z))+".json";}function t(C){var z=i.S_CONTAINER_PREFIX,B,R;if(q.type(C)!=="string"||C.length===0){throw new Error("Personalization container key must be a non-empty string");}if(C.substring(0,z.length)===z){B=C.substring(z.length);}else{q.sap.log.error("Unexpected personalization container key: "+C,"should always be prefixed with "+z,"sap.ushell.adapters.cdm.PersonalizationAdapter");B=C;}if(B.length<=40){R=B;}else{R=B.substring(0,40);q.sap.log.error("Invalid personalization container key: '"+B+"'"+" exceeds maximum key length (40 characters) and is shortened to '"+R+"'",undefined,"sap.ushell.adapters.cdm.PersonalizationAdapter");}return R;}function d(){return{validity:Infinity,keyCategory:s.keyCategory.GENERATED_KEY,writeFrequency:s.writeFrequency.HIGH,clientStorageAllowed:false};}function e(C,H,z){var B=C&&C[z];if(B){delete C[z];}return n(H,z);}function f(S,z){var C;if((!z&&z!=="")||z.constructor!==String){q.sap.log.warning("Personalization container has an invalid app name; must be a non-empty string",null,"sap.ushell.adapters.cdm.PersonalizationAdapter");}if(!S){S=d();}C=Object.create(null,{items:{value:Object.create(null),enumerable:true},__metadata:{value:Object.create(null,{appName:{value:z,enumerable:true},expiry:{value:Date.now()+S.validity*60*1000,enumerable:true},validity:{value:S.validity,enumerable:true},category:{value:h(S),enumerable:true}}),enumerable:true,writable:true}});return C;}function A(C,z,H,B,S,D){var E,F,G=c(C,S,B);if(z&&z[G]){return z[G];}F=f(S,D);E=F.items;return Object.create(null,{save:{value:l.bind(null,H,F,G)},load:{value:m.bind(null,H,F,G)},del:{value:n.bind(null,H,F,G)},setItemValue:{value:w.bind(null,E)},getItemValue:{value:x.bind(null,E)},getItemKeys:{value:u.bind(null,E)},containsItem:{value:v.bind(null,E)},delItem:{value:y.bind(null,E)}});}function h(S){return k(S)?"p":"u";}function j(C,S){return k(S)?a(C):b(C);}function k(S){return S&&S.keyCategory===s.keyCategory.FIXED_KEY&&S.writeFrequency===s.writeFrequency.LOW&&S.clientStorageAllowed;}function l(H,C,z){return new q.Deferred(function(D){H.put(z,{data:C}).then(function(R){D.resolve();}).catch(function(R){q.sap.log.error("Failed to save personalization container; response: "+(typeof R==="object"?JSON.stringify(R):R),R.stack?R.stack:null,"sap.ushell.adapters.cdm.PersonalizationAdapter");D.reject(R);});}).promise();}function m(H,C,z){return new q.Deferred(function(D){H.get(z).then(function(R){var B=JSON.parse(R.responseText);var E;if(B.data){B.items=B.data;delete B.data;B.__metadata=C.__metadata;}E=B.items;o(C.items);Object.keys(E).forEach(function(I){C.items[I]=E[I];});C.__metadata=B.__metadata;D.resolve();}).catch(function(R){o(C.items);if(R.status===404){D.resolve();}else{D.reject(R);}});}).promise();}function n(H,z){return new q.Deferred(function(D){H.delete(z).then(function(){D.resolve();}).catch(function(R){D.reject(R);});}).promise();}function o(C){Object.keys(C).forEach(function(K){delete C[K];});}function p(K){if(K==="__metadata"){return undefined;}else if(K.indexOf(i.S_VARIANT_PREFIX)===0||K.indexOf(i.S_ADMIN_PREFIX)===0){return K;}else{return i.S_ITEM_PREFIX+K;}}function r(K){if(K.indexOf(i.S_ITEM_PREFIX)===0){return K.substring(i.S_ITEM_PREFIX.length);}else if(K.indexOf(i.S_VARIANT_PREFIX)===0||K.indexOf(i.S_ADMIN_PREFIX)===0){return K;}else{throw new Error("Illegal item key for personalization container: '"+K+"'; must be prefixed with one of the following: ["+i.S_ITEM_PREFIX+", "+i.S_VARIANT_PREFIX+", "+i.S_ADMIN_PREFIX+"] ");}}function u(C){return Object.keys(C).map(p).filter(function(K){return!!K;});}function v(C,K){return C.hasOwnProperty(r(K));}function w(C,K,V){C[r(K)]=V;}function x(C,K){return C[r(K)];}function y(C,K){delete C[r(K)];}});
